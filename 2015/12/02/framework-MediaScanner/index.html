<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>framework--MediaScanner | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="MediaScanner涉及组件
MediaScannerService:负责扫描媒体文件，将扫描的信息插入到媒体数据库中
MediaProvider：处理 媒体数据库的增删改查
MediaScannerReceiver：接收外界发来的扫描请求，MediaScanner对外提供的接口

1.MediaScannerReceiver@Override
public void onReceive(Co">
<meta property="og:type" content="article">
<meta property="og:title" content="framework--MediaScanner">
<meta property="og:url" content="http://yoursite.com/2015/12/02/framework-MediaScanner/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="MediaScanner涉及组件
MediaScannerService:负责扫描媒体文件，将扫描的信息插入到媒体数据库中
MediaProvider：处理 媒体数据库的增删改查
MediaScannerReceiver：接收外界发来的扫描请求，MediaScanner对外提供的接口

1.MediaScannerReceiver@Override
public void onReceive(Co">
<meta property="og:updated_time" content="2015-12-09T05:45:17.324Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="framework--MediaScanner">
<meta name="twitter:description" content="MediaScanner涉及组件
MediaScannerService:负责扫描媒体文件，将扫描的信息插入到媒体数据库中
MediaProvider：处理 媒体数据库的增删改查
MediaScannerReceiver：接收外界发来的扫描请求，MediaScanner对外提供的接口

1.MediaScannerReceiver@Override
public void onReceive(Co">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-framework-MediaScanner" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/02/framework-MediaScanner/" class="article-date">
  <time datetime="2015-12-02T07:22:05.000Z" itemprop="datePublished">2015-12-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      framework--MediaScanner
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="MediaScanner">MediaScanner</h1><h2 id="涉及组件">涉及组件</h2><ul>
<li>MediaScannerService:负责扫描媒体文件，将扫描的信息插入到媒体数据库中</li>
<li>MediaProvider：处理 媒体数据库的增删改查</li>
<li>MediaScannerReceiver：接收外界发来的扫描请求，MediaScanner对外提供的接口</li>
</ul>
<h2 id="1-MediaScannerReceiver">1.MediaScannerReceiver</h2><pre><code>@Override
<span class="keyword">public</span> <span class="literal">void</span> onReceive(Context context, Intent intent) {
    final <span class="built_in">String</span> action = intent<span class="built_in">.</span>getAction();
    final Uri uri = intent<span class="built_in">.</span>getData();
    <span class="keyword">if</span> (Intent<span class="built_in">.</span>ACTION_BOOT_COMPLETED<span class="built_in">.</span><span class="keyword">equals</span>(action)) {
        <span class="comment">//接收BOOT_COMPLETED广播，扫描内部 外部存储区。</span>
        <span class="comment">//内部存储区 扫描的是/system/midia目录，存储了系统自带的铃声等媒体文件</span>
        <span class="comment">// Scan both internal and external storage</span>
        scan(context, MediaProvider<span class="built_in">.</span>INTERNAL_VOLUME);
        scan(context, MediaProvider<span class="built_in">.</span>EXTERNAL_VOLUME);

    } <span class="keyword">else</span> {
        <span class="keyword">if</span> (uri<span class="built_in">.</span>getScheme()<span class="built_in">.</span><span class="keyword">equals</span>(<span class="string">"file"</span>)) {
            <span class="comment">// handle intents related to external storage</span>
            <span class="comment">//uri = file:///storage/emulated/0/Sound_recorder/%E5%BD%95%E9%9F%B3_2015%E5%B9%B412%E6%9C%882%E6%97%A5_11%E7%82%B918%E5%88%8653%E7%A7%92.aac, </span>
            <span class="comment">//path = /storage/emulated/0/Sound_recorder/录音_2015年12月2日_11点18分53秒.aac</span>
            <span class="built_in">String</span> path = uri<span class="built_in">.</span>getPath();
            <span class="built_in">String</span> externalStoragePath = Environment<span class="built_in">.</span>getExternalStorageDirectory()<span class="built_in">.</span>getPath();<span class="comment">// /storage/emulated/0</span>
            <span class="built_in">String</span> legacyPath = Environment<span class="built_in">.</span>getLegacyExternalStorageDirectory()<span class="built_in">.</span>getPath();<span class="comment">// /sdcard</span>

            try {
                path = <span class="literal">new</span> File(path)<span class="built_in">.</span>getCanonicalPath();
            } catch (IOException e) {
                <span class="keyword">Log</span><span class="built_in">.</span>e(<span class="built_in">TAG</span>, <span class="string">"couldn't canonicalize "</span> + path);
                <span class="keyword">return</span>;
            }
            <span class="keyword">if</span> (path<span class="built_in">.</span>startsWith(legacyPath)) {
                path = externalStoragePath + path<span class="built_in">.</span>substring(legacyPath<span class="built_in">.</span>length());
            }

            <span class="keyword">Log</span><span class="built_in">.</span>d(<span class="built_in">TAG</span>, <span class="string">"action: "</span> + action + <span class="string">" path: "</span> + path);
            <span class="keyword">if</span> (Intent<span class="built_in">.</span>ACTION_MEDIA_MOUNTED<span class="built_in">.</span><span class="keyword">equals</span>(action)) {
                <span class="comment">//接收MEDIA_MOUNTED，扫描 外部存储 /storage/emulated/0</span>
                <span class="comment">// scan whenever any volume is mounted</span>
                scan(context, MediaProvider<span class="built_in">.</span>EXTERNAL_VOLUME);
            } <span class="keyword">else</span> <span class="keyword">if</span> (Intent<span class="built_in">.</span>ACTION_MEDIA_SCANNER_SCAN_FILE<span class="built_in">.</span><span class="keyword">equals</span>(action) <span class="subst">&amp;&amp;</span>
                    path != <span class="built_in">null</span> <span class="subst">&amp;&amp;</span> path<span class="built_in">.</span>startsWith(externalStoragePath + <span class="string">"/"</span>)) {
                <span class="comment">//外部应用 可以通过发送 ACTION_MEDIA_SCANNER_SCAN_FILE 让MediaScannerReceiver扫描 单个文件，这个文件必须位于SD卡上</span>
                scanFile(context, path);
            }
        }
    }
}
<span class="keyword">private</span> <span class="literal">void</span> scan(Context context, <span class="built_in">String</span> volume) {
    Bundle args = <span class="literal">new</span> Bundle();
    args<span class="built_in">.</span>putString(<span class="string">"volume"</span>, volume);
    <span class="comment">//启动 MediaScannerService</span>
    context<span class="built_in">.</span>startService(
            <span class="literal">new</span> Intent(context, MediaScannerService<span class="built_in">.</span>class)<span class="built_in">.</span>putExtras(args));
}    

<span class="keyword">private</span> <span class="literal">void</span> scanFile(Context context, <span class="built_in">String</span> path) {
    Bundle args = <span class="literal">new</span> Bundle();
    args<span class="built_in">.</span>putString(<span class="string">"filepath"</span>, path);
    <span class="comment">//启动 MediaScannerService</span>
    context<span class="built_in">.</span>startService(
            <span class="literal">new</span> Intent(context, MediaScannerService<span class="built_in">.</span>class)<span class="built_in">.</span>putExtras(args));
}   
</code></pre><p>MediaProvider.java</p>
<pre><code><span class="literal">static</span> <span class="keyword">final</span> <span class="built_in">String</span> INTERNAL_VOLUME = <span class="string">"internal"</span>;
<span class="literal">static</span> <span class="keyword">final</span> <span class="built_in">String</span> EXTERNAL_VOLUME = <span class="string">"external"</span>;
</code></pre><p>MediaScannerReceiver接收三种请求：</p>
<ul>
<li>ACTION_BOOT_COMPLETED：扫描内部 外部存储</li>
<li>ACTION_MEDIA_MOUNTED：扫描外部存储</li>
<li>ACTION_MEDIA_SCANNER_SCAN_FILE：扫描Sd卡上的一个文件，文件路径必须以Environment.getExternalStorageDirectory().getPath() 开头</li>
</ul>
<h2 id="2-MediaScannerService">2.MediaScannerService</h2><pre><code>public <span class="class"><span class="keyword">class</span> <span class="title">MediaScannerService</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">Service</span> <span class="title">implements</span> <span class="title">Runnable</span></span>
</code></pre><h3 id="2-1_onCreate">2.1 onCreate</h3><pre><code>    <span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span>
</span>{
    <span class="comment">//获得PowerManager，防止扫描过程中休眠</span>
    PowerManager pm = (PowerManager)getSystemService(Context.POWER_SERVICE);
    mWakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, TAG);
    StorageManager storageManager = (StorageManager)getSystemService(Context.STORAGE_SERVICE);
    mExternalStoragePaths = storageManager.getVolumePaths();

    <span class="comment">// Start up the thread running the service.  Note that we create a</span>
    <span class="comment">// separate thread because the service normally runs in the process's</span>
    <span class="comment">// main thread, which we don't want to block.</span>
    Thread thr = <span class="keyword">new</span> Thread(<span class="keyword">null</span>, <span class="keyword">this</span>, <span class="string">"MediaScannerService"</span>);
    thr.start();<span class="comment">//创建一个工作线程，工作在MediaScannerService的run()中</span>
}

<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span>
</span>{
    <span class="comment">//设置线程的优先级，调低优先级，避免MediaScannerService一直占用CPU，导致系统卡</span>
    <span class="comment">// reduce priority below other background threads to avoid interfering</span>
    <span class="comment">// with other services at boot time.</span>
    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND +
            Process.THREAD_PRIORITY_LESS_FAVORABLE);
    Looper.prepare();

    mServiceLooper = Looper.myLooper();
    mServiceHandler = <span class="keyword">new</span> ServiceHandler();<span class="comment">//创建一个Handler</span>

    Looper.loop();
}
</code></pre><p>onCreate后，MediaScannerService创建一个 带消息处理机制 的工作线程，消息 如何传递到 这个线程呢？</p>
<h2 id="2-2_onStartCommand">2.2 onStartCommand</h2><pre><code><span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span>
</span>{
    <span class="comment">//等待mServiceHandler被创建</span>
    <span class="keyword">while</span> (mServiceHandler == <span class="keyword">null</span>) {
        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {
            <span class="keyword">try</span> {
                wait(<span class="number">100</span>);
            } <span class="keyword">catch</span> (InterruptedException e) {
            }
        }
    }

    <span class="keyword">if</span> (intent == <span class="keyword">null</span>) {
        Log.e(TAG, <span class="string">"Intent is null in onStartCommand: "</span>,
            <span class="keyword">new</span> NullPointerException());
        <span class="keyword">return</span> Service.START_NOT_STICKY;
    }

    Message msg = mServiceHandler.obtainMessage();
    msg.arg1 = startId;
    msg.obj = intent.getExtras();
    mServiceHandler.sendMessage(msg);<span class="comment">//发消息，最终由工作线程处理</span>

    <span class="comment">// Try again later if we are killed before we can finish scanning.</span>
    <span class="keyword">return</span> Service.START_REDELIVER_INTENT;
}
</code></pre><p>onStartCommand将 扫描请求信息 投递到 工作线程中 去处理。</p>
<h2 id="2-3处理扫描请求">2.3处理扫描请求</h2><pre><code><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">Handler</span>
</span>{
    <span class="annotation">@Override</span>
    public void handleMessage(<span class="type">Message</span> msg)
    {
        <span class="type">Bundle</span> arguments = (<span class="type">Bundle</span>) msg.obj;
        <span class="type">String</span> filePath = arguments.getString(<span class="string">"filepath"</span>);

        <span class="keyword">try</span> {
            ……
            } <span class="keyword">else</span> {
                <span class="type">String</span> volume = arguments.getString(<span class="string">"volume"</span>);
                <span class="type">String</span>[] directories = <span class="literal">null</span>;

                <span class="keyword">if</span> (<span class="type">MediaProvider</span>.<span class="type">INTERNAL_VOLUME</span>.equals(volume)) {
                    <span class="comment">//扫描内部存储，Environment.getRootDirectory()：/system ，Environment.getOemDirectory() ： /oem </span>
                    <span class="comment">// scan internal media storage</span>
                    directories = <span class="keyword">new</span> <span class="type">String</span>[] {
                            <span class="type">Environment</span>.getRootDirectory() + <span class="string">"/media"</span>,
                            <span class="type">Environment</span>.getOemDirectory() + <span class="string">"/media"</span>,
                    };
                }
                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">MediaProvider</span>.<span class="type">EXTERNAL_VOLUME</span>.equals(volume)) {
                    <span class="comment">// scan external storage volumes</span>
                    directories = mExternalStoragePaths;<span class="comment">// [/storage/emulated/0]</span>
                }

                <span class="keyword">if</span> (directories != <span class="literal">null</span>) {
                    <span class="keyword">if</span> (<span class="literal">false</span>) <span class="type">Log</span>.d(<span class="type">TAG</span>, <span class="string">"start scanning volume "</span> + volume + <span class="string">": "</span>
                            + <span class="type">Arrays</span>.toString(directories));
                    <span class="comment">//调用scan函数扫描文件夹，可以一次设置多个目标文件夹</span>
                    scan(directories, volume);
                    <span class="keyword">if</span> (<span class="literal">false</span>) <span class="type">Log</span>.d(<span class="type">TAG</span>, <span class="string">"done scanning volume "</span> + volume);
                }
            }
        } <span class="keyword">catch</span> (<span class="type">Exception</span> e) {
            <span class="type">Log</span>.e(<span class="type">TAG</span>, <span class="string">"Exception in handleMessage"</span>, e);
        }

        stopSelf(msg.arg1);
    }
};
</code></pre><h2 id="2-4_MediaScannerService的scan函数">2.4 MediaScannerService的scan函数</h2><pre><code>private <span class="keyword">void</span> scan(<span class="built_in">String</span>[] directories, <span class="built_in">String</span> volumeName) {
    <span class="built_in">Uri</span> uri = <span class="built_in">Uri</span>.parse(<span class="string">"file://"</span> + directories[<span class="number">0</span>]);
    <span class="comment">// don't sleep while scanning</span>
    mWakeLock.acquire();

    <span class="keyword">try</span> {
        ContentValues values = <span class="keyword">new</span> ContentValues();
        values.put(MediaStore.MEDIA_SCANNER_VOLUME, volumeName);
        <span class="comment">//MediaScannerService通过insert这个特殊的Uri让MediaProvider做一些准备工作</span>
        <span class="comment">//MediaStore.getMediaScannerUri(): content://media/none/media_scanner</span>
        <span class="built_in">Uri</span> scanUri = getContentResolver().insert(MediaStore.getMediaScannerUri(), values);

        <span class="comment">//发ACTION_MEDIA_SCANNER_STARTED广播</span>
        sendBroadcast(<span class="keyword">new</span> Intent(Intent.ACTION_MEDIA_SCANNER_STARTED, uri));

        <span class="keyword">try</span> {
            <span class="keyword">if</span> (volumeName.equals(MediaProvider.EXTERNAL_VOLUME)) {
                <span class="comment">//打开数据库</span>
                openDatabase(volumeName);
            }

            <span class="comment">//创建MediaScanner，调用scanDirectories扫描目标文件夹</span>
            MediaScanner scanner = createMediaScanner();
            scanner.scanDirectories(directories, volumeName);
        } <span class="keyword">catch</span> (Exception e) {
            Log.e(TAG, <span class="string">"exception in MediaScanner.scan()"</span>, e);
        }
        <span class="comment">//通过 特殊Uri 让MediaProvider 做一些清理工作</span>
        getContentResolver().delete(scanUri, <span class="keyword">null</span>, <span class="keyword">null</span>);

    } <span class="keyword">finally</span> {
        <span class="comment">//发送ACTION_MEDIA_SCANNER_FINISHED广播</span>
        sendBroadcast(<span class="keyword">new</span> Intent(Intent.ACTION_MEDIA_SCANNER_FINISHED, uri));
        mWakeLock.release();
    }
}
<span class="comment">//openDatabase()通过insert这个特殊的Uri 让MediaProvider打开数据库</span>
private <span class="keyword">void</span> openDatabase(<span class="built_in">String</span> volumeName) {
    <span class="keyword">try</span> {
        ContentValues values = <span class="keyword">new</span> ContentValues();
        values.put(<span class="string">"name"</span>, volumeName);
        getContentResolver().insert(<span class="built_in">Uri</span>.parse(<span class="string">"content://media/"</span>), values);
    } <span class="keyword">catch</span> (IllegalArgumentException ex) {
        Log.w(TAG, <span class="string">"failed to open media database"</span>);
    }         
}
</code></pre><p>上边代码中，比较复杂的是 MediaScannerService和MediaProvider交互。除了后文的正常数据库操作外，MediaScannerService还经常会使用一些特殊的Uri来做数据库操作，而MediaProvider针对Uri会做一些特殊处理，如打开数据库文件等。</p>
<pre><code><span class="keyword">private</span> MediaScanner createMediaScanner() {
    MediaScanner scanner = <span class="literal">new</span> MediaScanner(this);
    <span class="comment">//获取当前系统使用的区域信息，扫描的时候 将 媒体文件信息 转换成 当前系统的语言</span>
    <span class="built_in">Locale</span> <span class="built_in">locale</span> = getResources()<span class="built_in">.</span>getConfiguration()<span class="built_in">.</span><span class="built_in">locale</span>;
    <span class="keyword">if</span> (<span class="built_in">locale</span> != <span class="built_in">null</span>) {
        <span class="built_in">String</span> language = <span class="built_in">locale</span><span class="built_in">.</span>getLanguage();
        <span class="built_in">String</span> country = <span class="built_in">locale</span><span class="built_in">.</span>getCountry();
        <span class="built_in">String</span> localeString = <span class="built_in">null</span>;
        <span class="keyword">if</span> (language != <span class="built_in">null</span>) {
            <span class="keyword">if</span> (country != <span class="built_in">null</span>) {
                <span class="comment">//为扫描器 设置当前系统使用的 国家和语言</span>
                scanner<span class="built_in">.</span>setLocale(language + <span class="string">"_"</span> + country);
            } <span class="keyword">else</span> {
                scanner<span class="built_in">.</span>setLocale(language);
            }
        }    
    }

    <span class="keyword">return</span> scanner;
}
</code></pre><h2 id="2-3媒体扫描工作总结">2.3媒体扫描工作总结</h2><p>MediaScannerReceiver和MediaScannerService交互，流程：</p>
<ul>
<li>MediaScannerReceiver 接收 外部发来 的扫描请求，通过startService启动MediaScannerService处理</li>
<li>MediaScannerService的 主线程接收 MediaScannerReceiver收到的请求，然后 投递给 工作线程去处理</li>
<li>工作线程做一些 前期处理工作（例如 向系统发 扫描开始的 广播），创建MediaScanner来处理扫描目标</li>
<li>MediaScanner扫描完成后，工作线程 做后期处理，然后向系统 发扫描完毕的广播</li>
</ul>
<h1 id="3-MediaScanner分析">3.MediaScanner分析</h1><p>MediaScanner工作原理，跨 Java层、JNI层 Native层。</p>
<h2 id="3-1_Java层">3.1 Java层</h2><h3 id="3-1-1_创建MediaScanner">3.1.1 创建MediaScanner</h3><pre><code>public <span class="class"><span class="keyword">class</span> <span class="title">MediaScanner</span></span>
{
    static {
            <span class="constant">System</span>.loadLibrary(<span class="string">"media_jni"</span>);<span class="regexp">//</span>加载system/<span class="class"><span class="keyword">lib</span>/<span class="title">libmedia_jni</span>.<span class="title">so</span></span>
        native_init();
    }
    ……
    public <span class="constant">MediaScanner</span>(<span class="constant">Context</span> c) {
        native_setup();<span class="regexp">//</span>调用<span class="constant">JNI</span>层 做一些初始化 工作
        ……
    }
}
</code></pre><h3 id="3-1-2_scanDirectories分析">3.1.2 scanDirectories分析</h3><pre><code><span class="comment">/** whether to use bulk inserts or individual inserts for each item */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">boolean</span> ENABLE_BULK_INSERTS = <span class="keyword">true</span>;

<span class="keyword">public</span> <span class="keyword">void</span> scanDirectories(<span class="keyword">String</span>[] directories, <span class="keyword">String</span> volumeName) {
    <span class="keyword">try</span> {
        <span class="keyword">long</span> start = System.currentTimeMillis();
        initialize(volumeName);<span class="comment">//（1）初始化</span>
        prescan(<span class="keyword">null</span>, <span class="keyword">true</span>);<span class="comment">//（2）扫描前的预处理</span>
        <span class="keyword">long</span> prescan = System.currentTimeMillis();

        <span class="keyword">if</span> (ENABLE_BULK_INSERTS) {
            <span class="comment">//MediaInserter: A MediaScanner helper class which enables us to do lazy insertion on the given provider. This class manages buffers internally and flushes when they are full. Note that you should call flushAll() after using this class.</span>
            <span class="comment">// create MediaInserter for bulk inserts</span>
            mMediaInserter = <span class="keyword">new</span> MediaInserter(mMediaProvider, mPackageName, <span class="number">500</span>);
        }

        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; directories.length; i++) {
            <span class="comment">//processDirectory是一个native函数，调用它 扫描目标文件夹</span>
            <span class="comment">//mClient是MyMediaScannerClient类型，派生自MediaScannerClient，其作用后面再分析</span>
            processDirectory(directories[i], mClient);
        }

        <span class="keyword">if</span> (ENABLE_BULK_INSERTS) {
            <span class="comment">// flush remaining inserts</span>
            mMediaInserter.flushAll();
            mMediaInserter = <span class="keyword">null</span>;
        }

        <span class="keyword">long</span> scan = System.currentTimeMillis();
        postscan(directories);<span class="comment">//(4)扫描后 处理</span>
        <span class="keyword">long</span> end = System.currentTimeMillis();

        <span class="keyword">if</span> (<span class="keyword">false</span>) {
            Log.d(TAG, <span class="string">" prescan time: "</span> + (prescan - start) + <span class="string">"ms\n"</span>);
            Log.d(TAG, <span class="string">"    scan time: "</span> + (scan - prescan) + <span class="string">"ms\n"</span>);
            Log.d(TAG, <span class="string">"postscan time: "</span> + (end - scan) + <span class="string">"ms\n"</span>);
            Log.d(TAG, <span class="string">"   total time: "</span> + (end - start) + <span class="string">"ms\n"</span>);
        }
    } <span class="keyword">catch</span> (SQLException e) {
        <span class="comment">// this might happen if the SD card is removed while the media scanner is running</span>
        Log.e(TAG, <span class="string">"SQLException in MediaScanner.scan()"</span>, e);
    } <span class="keyword">catch</span> (UnsupportedOperationException e) {
        <span class="comment">// this might happen if the SD card is removed while the media scanner is running</span>
        Log.e(TAG, <span class="string">"UnsupportedOperationException in MediaScanner.scan()"</span>, e);
    } <span class="keyword">catch</span> (RemoteException e) {
        Log.e(TAG, <span class="string">"RemoteException in MediaScanner.scan()"</span>, e);
    } <span class="keyword">finally</span> {
        releaseResources();
    }
}
</code></pre><p><strong> （1）initialize分析 </strong><br>initialize主要是 初始化一些Uri<br>扫描时 需要把文件的信息 插入到媒体库中，媒体库中 针对 Video、Audio、Image文件有对应的表，表的地址由Uri表示。</p>
<pre><code><span class="keyword">private</span> <span class="literal">void</span> initialize(<span class="built_in">String</span> volumeName) {
    mMediaProvider = mContext<span class="built_in">.</span>getContentResolver()<span class="built_in">.</span>acquireProvider(<span class="string">"media"</span>);

    mAudioUri = Audio<span class="built_in">.</span>Media<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//音频表的地址，对应audio_meta表</span>
    mVideoUri = Video<span class="built_in">.</span>Media<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//视频表地址，对应video表</span>
    mImagesUri = Images<span class="built_in">.</span>Media<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//图片表地址，对应images表</span>
    mThumbsUri = Images<span class="built_in">.</span>Thumbnails<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//缩略图地址，对应thumbnails表</span>
    mFilesUri = Files<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//所有文件的地址，对应files表</span>
    mFilesUriNoNotify = mFilesUri<span class="built_in">.</span>buildUpon()<span class="built_in">.</span>appendQueryParameter(<span class="string">"nonotify"</span>, <span class="string">"1"</span>)<span class="built_in">.</span>build();

    <span class="keyword">if</span> (<span class="subst">!</span>volumeName<span class="built_in">.</span><span class="keyword">equals</span>(<span class="string">"internal"</span>)) {
        <span class="comment">//如果扫描的是 外部存储，支持 播放列表、音乐的流派等内容</span>
        <span class="comment">// we only support playlists on external media</span>
        mProcessPlaylists = <span class="literal">true</span>;
        mProcessGenres = <span class="literal">true</span>;
        mPlaylistsUri = Playlists<span class="built_in">.</span>getContentUri(volumeName);

        mCaseInsensitivePaths = <span class="literal">true</span>;<span class="comment">//Sd卡存储区域一般使用FAT文件系统，文件名与大小写无关</span>
    }
}
</code></pre><p><strong> （2）prescan分析 </strong><br>媒体扫描的问题：假设扫描之前SD卡有100个媒体文件，数据库中有100个关于文件的记录，因某种原因 删除了50个媒体文件，那么 数据库什么时候更新呢？</p>
<p>prescan函数的主要作用就是 在扫描之前 把数据库中 和文件关联的信息 取出并保存，这些信息主要是 媒体文件的路径 所属表的Uri。上边的例子，prescan会从数据库中 取出这100个文件 的文件信息。</p>
<pre><code><span class="keyword">private</span> <span class="keyword">void</span> prescan(<span class="keyword">String</span> filePath, <span class="built_in">boolean</span> prescanFiles) <span class="keyword">throws</span> RemoteException {
    Cursor c = <span class="keyword">null</span>;
    <span class="keyword">String</span> where = <span class="keyword">null</span>;
    <span class="keyword">String</span>[] selectionArgs = <span class="keyword">null</span>;

    <span class="comment">//保存从数据库中获取的文件信息</span>
    <span class="keyword">if</span> (mPlayLists == <span class="keyword">null</span>) {
        mPlayLists = <span class="keyword">new</span> ArrayList&lt;FileEntry&gt;();
    } <span class="keyword">else</span> {
        mPlayLists.<span class="built_in">clear</span>();
    }

    <span class="keyword">if</span> (filePath != <span class="keyword">null</span>) {
        <span class="comment">//查询file信息</span>
        <span class="comment">// query for only one file</span>
        where = MediaStore.Files.FileColumns._ID + <span class="string">"&gt;?"</span> +
            <span class="string">" AND "</span> + Files.FileColumns.DATA + <span class="string">"=?"</span>;
        selectionArgs = <span class="keyword">new</span> <span class="keyword">String</span>[] { <span class="string">""</span>, filePath };
    } <span class="keyword">else</span> {
        where = MediaStore.Files.FileColumns._ID + <span class="string">"&gt;?"</span>;
        selectionArgs = <span class="keyword">new</span> <span class="keyword">String</span>[] { <span class="string">""</span> };
    }

    <span class="comment">// Tell the provider to not delete the file.</span>
    <span class="comment">// If the file is truly gone the delete is unnecessary, and we want to avoid</span>
    <span class="comment">// accidentally deleting files that are really there (this may happen if the</span>
    <span class="comment">// filesystem is mounted and unmounted while the scanner is running).</span>
    Uri.Builder builder = mFilesUri.buildUpon();
    builder.appendQueryParameter(MediaStore.PARAM_DELETE_DATA, <span class="string">"false"</span>);
    MediaBulkDeleter deleter = <span class="keyword">new</span> MediaBulkDeleter(mMediaProvider, mPackageName,
            builder.build());

    <span class="comment">// Build the list of files from the content provider</span>
    <span class="keyword">try</span> {
        <span class="keyword">if</span> (prescanFiles) {
            <span class="comment">// First read existing files from the files table.</span>
            <span class="comment">// Because we'll be deleting entries for missing files as we go,</span>
            <span class="comment">// we need to query the database in small batches, to avoid problems</span>
            <span class="comment">// with CursorWindow positioning.</span>
            <span class="keyword">long</span> lastId = Long.MIN_VALUE;
            Uri limitUri = mFilesUri.buildUpon().appendQueryParameter(<span class="string">"limit"</span>, <span class="string">"1000"</span>).build();
            mWasEmptyPriorToScan = <span class="keyword">true</span>;

            <span class="keyword">while</span> (<span class="keyword">true</span>) {
                selectionArgs[<span class="number">0</span>] = <span class="string">""</span> + lastId;
                <span class="keyword">if</span> (c != <span class="keyword">null</span>) {
                    c.close();
                    c = <span class="keyword">null</span>;
                }
                <span class="comment">//查询files信息</span>
                c = mMediaProvider.query(mPackageName, limitUri, FILES_PRESCAN_PROJECTION,
                        where, selectionArgs, MediaStore.Files.FileColumns._ID, <span class="keyword">null</span>);
                <span class="keyword">if</span> (c == <span class="keyword">null</span>) {
                    <span class="keyword">break</span>;
                }

                <span class="built_in">int</span> num = c.getCount();

                <span class="keyword">if</span> (num == <span class="number">0</span>) {
                    <span class="keyword">break</span>;
                }
                mWasEmptyPriorToScan = <span class="keyword">false</span>;
                <span class="keyword">while</span> (c.moveToNext()) {
                    <span class="keyword">long</span> rowId = c.getLong(FILES_PRESCAN_ID_COLUMN_INDEX);
                    <span class="keyword">String</span> path = c.getString(FILES_PRESCAN_PATH_COLUMN_INDEX);<span class="comment">//查询文件路径</span>
                    <span class="built_in">int</span> format = c.getInt(FILES_PRESCAN_FORMAT_COLUMN_INDEX);
                    <span class="keyword">long</span> lastModified = c.getLong(FILES_PRESCAN_DATE_MODIFIED_COLUMN_INDEX);
                    lastId = rowId;

                    <span class="comment">// Only consider entries with absolute path names.</span>
                    <span class="comment">// This allows storing URIs in the database without the</span>
                    <span class="comment">// media scanner removing them.</span>
                    <span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; path.startsWith(<span class="string">"/"</span>)) {
                        <span class="built_in">boolean</span> exists = <span class="keyword">false</span>;
                        <span class="keyword">try</span> {
                            exists = Os.access(path, android.system.OsConstants.F_OK);
                        } <span class="keyword">catch</span> (ErrnoException e1) {
                        }
                        <span class="keyword">if</span> (!exists &amp;&amp; !MtpConstants.isAbstractObject(format)) {
                            <span class="comment">// do not delete missing playlists, since they may have been</span>
                            <span class="comment">// modified by the user.</span>
                            <span class="comment">// The user can delete them in the media player instead.</span>
                            <span class="comment">// instead, clear the path and lastModified fields in the row</span>
                            MediaFile.MediaFileType mediaFileType = MediaFile.getFileType(path);
                            <span class="built_in">int</span> fileType = (mediaFileType == <span class="keyword">null</span> ? <span class="number">0</span> : mediaFileType.fileType);

                            <span class="keyword">if</span> (!MediaFile.isPlayListFileType(fileType)) {
                                deleter.delete(rowId);
                                <span class="keyword">if</span> (path.toLowerCase(Locale.US).endsWith(<span class="string">"/.nomedia"</span>)) {
                                    deleter.flush();
                                    <span class="keyword">String</span> parent = <span class="keyword">new</span> File(path).getParent();
                                    mMediaProvider.call(mPackageName, MediaStore.UNHIDE_CALL,
                                            parent, <span class="keyword">null</span>);
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    <span class="keyword">finally</span> {
        <span class="keyword">if</span> (c != <span class="keyword">null</span>) {
            c.close();
        }
        deleter.flush();
    }

    <span class="comment">// compute original size of images</span>
    mOriginalCount = <span class="number">0</span>;
    c = mMediaProvider.query(mPackageName, mImagesUri, ID_PROJECTION, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);
    <span class="keyword">if</span> (c != <span class="keyword">null</span>) {
        mOriginalCount = c.getCount();
        c.close();
    }
}
</code></pre><p><strong> （3）processDirectory 和 postscan分析 </strong></p>
<pre><code><span class="keyword">private</span> <span class="keyword">native</span> <span class="function"><span class="keyword">void</span> <span class="title">processDirectory</span><span class="params">(String path, MediaScannerClient client)</span></span>;


<span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">postscan</span><span class="params">(String[] directories)</span> <span class="keyword">throws</span> RemoteException </span>{

    <span class="comment">// handle playlists last, after we know what media files are on the storage.</span>
    <span class="keyword">if</span> (mProcessPlaylists) {
        processPlayLists();
    }

    <span class="keyword">if</span> (mOriginalCount == <span class="number">0</span> &amp;&amp; mImagesUri.equals(Images.Media.getContentUri(<span class="string">"external"</span>)))
        pruneDeadThumbnailFiles();

    <span class="comment">// allow GC to clean up</span>
    mPlayLists = <span class="keyword">null</span>;
    mMediaProvider = <span class="keyword">null</span>;
}
</code></pre><p>processDirectory是一个native函数，JNI层实现。processDirectory扫描SD卡</p>
<pre><code><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">processPlayLists</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>{
    Iterator&lt;FileEntry&gt; iterator = mPlayLists.iterator();
    Cursor fileList = <span class="keyword">null</span>;
    <span class="keyword">try</span> {
        <span class="comment">// use the files uri and projection because we need the format column,</span>
        <span class="comment">// but restrict the query to just audio files</span>
        fileList = mMediaProvider.query(mPackageName, mFilesUri, FILES_PRESCAN_PROJECTION,
                <span class="string">"media_type=2"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);
        <span class="keyword">while</span> (iterator.hasNext()) {
            FileEntry entry = iterator.next();
            <span class="comment">// only process playlist files if they are new or have been modified since the last scan</span>
            <span class="keyword">if</span> (entry.mLastModifiedChanged) {
                processPlayList(entry, fileList);
            }
        }
    } <span class="keyword">catch</span> (RemoteException e1) {
    } <span class="keyword">finally</span> {
        <span class="keyword">if</span> (fileList != <span class="keyword">null</span>) {
            fileList.close();
        }
    }
}


<span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">processPlayList</span><span class="params">(FileEntry entry, Cursor fileList)</span> <span class="keyword">throws</span> RemoteException </span>{
    String path = entry.mPath;
    ContentValues values = <span class="keyword">new</span> ContentValues();
    <span class="keyword">int</span> lastSlash = path.lastIndexOf(<span class="string">'/'</span>);
    <span class="keyword">if</span> (lastSlash &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"bad path "</span> + path);
    Uri uri, membersUri;
    <span class="keyword">long</span> rowId = entry.mRowId;

    <span class="comment">// make sure we have a name</span>
    String name = values.getAsString(MediaStore.Audio.Playlists.NAME);
    <span class="keyword">if</span> (name == <span class="keyword">null</span>) {
        name = values.getAsString(MediaStore.MediaColumns.TITLE);
        <span class="keyword">if</span> (name == <span class="keyword">null</span>) {
            <span class="comment">// extract name from file name</span>
            <span class="keyword">int</span> lastDot = path.lastIndexOf(<span class="string">'.'</span>);
            name = (lastDot &lt; <span class="number">0</span> ? path.substring(lastSlash + <span class="number">1</span>)
                    : path.substring(lastSlash + 1, lastDot));
        }
    }

    values.put(MediaStore.Audio.Playlists.NAME, name);
    values.put(MediaStore.Audio.Playlists.DATE_MODIFIED, entry.mLastModified);

    <span class="keyword">if</span> (rowId == <span class="number">0</span>) {
        values.put(MediaStore.Audio.Playlists.DATA, path);
        uri = mMediaProvider.insert(mPackageName, mPlaylistsUri, values);
        rowId = ContentUris.parseId(uri);
        membersUri = Uri.withAppendedPath(uri, Playlists.Members.CONTENT_DIRECTORY);
    } <span class="keyword">else</span> {
        uri = ContentUris.withAppendedId(mPlaylistsUri, rowId);
        mMediaProvider.update(mPackageName, uri, values, <span class="keyword">null</span>, <span class="keyword">null</span>);

        <span class="comment">// delete members of existing playlist</span>
        membersUri = Uri.withAppendedPath(uri, Playlists.Members.CONTENT_DIRECTORY);
        mMediaProvider.delete(mPackageName, membersUri, <span class="keyword">null</span>, <span class="keyword">null</span>);
    }

    String playListDirectory = path.substring(<span class="number">0</span>, lastSlash + <span class="number">1</span>);
    MediaFile.MediaFileType mediaFileType = MediaFile.getFileType(path);
    <span class="keyword">int</span> fileType = (mediaFileType == <span class="keyword">null</span> ? <span class="number">0</span> : mediaFileType.fileType);

    <span class="keyword">if</span> (fileType == MediaFile.FILE_TYPE_M3U) {
        processM3uPlayList(path, playListDirectory, membersUri, values, fileList);
    } <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(fileType == MediaFile.FILE_TYPE_PLS)</span> </span>{
        processPlsPlayList(path, playListDirectory, membersUri, values, fileList);
    } <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(fileType == MediaFile.FILE_TYPE_WPL)</span> </span>{
        processWplPlayList(path, playListDirectory, membersUri, values, fileList);
    }
}
</code></pre><h2 id="3-2_JNI层">3.2 JNI层</h2><h3 id="3-2-1_native_init">3.2.1 native_init</h3><p>MediaScanner的static块中调用</p>
<pre><code><span class="comment">// This function gets a field ID, which in turn causes class initialization.</span>
<span class="comment">// It is called from a static block in MediaScanner, which won't run until the</span>
<span class="comment">// first time an instance of this class is used.</span>
<span class="function"><span class="keyword">static</span> <span class="keyword">void</span>
<span class="title">android_media_MediaScanner_native_init</span><span class="params">(JNIEnv *env)</span>
</span>{
    ALOGV(<span class="string">"native_init"</span>);
    jclass clazz = env-&gt;FindClass(kClassMediaScanner);
    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>) {
           <span class="keyword">return</span>;
    }

    <span class="comment">//取得Java层MediaScanner类的mNativeContext信息，Native对象的指针保存到Java层MediaScanner对象的mNativeContext中</span>
    fields.context = env-&gt;GetFieldID(clazz, <span class="string">"mNativeContext"</span>, <span class="string">"J"</span>);
    <span class="keyword">if</span> (fields.context == <span class="literal">NULL</span>) {
        <span class="keyword">return</span>;
    }
}
</code></pre><h3 id="3-2-2_native_setup">3.2.2 native_setup</h3><pre><code>static void
android_media_MediaScanner_native_setup<span class="list">(<span class="keyword">JNIEnv</span> <span class="variable">*env, jobject thiz)
{
    ALOGV("native_setup");
    MediaScanner *</span>mp = new StagefrightMediaScanner<span class="comment">;//创建Native层的MediaScanner对象</span>

    if <span class="list">(<span class="keyword">mp</span> == NULL)</span> {
        jniThrowException<span class="list">(<span class="keyword">env</span>, kRunTimeException, <span class="string">"Out of memory"</span>)</span><span class="comment">;</span>
        return<span class="comment">;</span>
    }

    env-&gt;SetLongField<span class="list">(<span class="keyword">thiz</span>, fields.context, <span class="list">(<span class="keyword">jlong</span>)</span>mp)</span><span class="comment">;</span>
}</span>
</code></pre><h3 id="3-2-3_processDirectory">3.2.3 processDirectory</h3><pre><code><span class="keyword">static</span> <span class="type">void</span>
android_media_MediaScanner_processDirectory(
        <span class="type">JNIEnv</span> *env, jobject thiz, jstring path, jobject client)
{
    <span class="type">ALOGV</span>(<span class="string">"processDirectory"</span>);
    <span class="type">MediaScanner</span> *mp = getNativeScanner_l(env, thiz);
    <span class="keyword">if</span> (mp == <span class="type">NULL</span>) {
        jniThrowException(env, kRunTimeException, <span class="string">"No scanner available"</span>);
        <span class="keyword">return</span>;
    }

    <span class="keyword">if</span> (path == <span class="type">NULL</span>) {
        jniThrowException(env, kIllegalArgumentException, <span class="type">NULL</span>);
        <span class="keyword">return</span>;
    }

    <span class="keyword">const</span> <span class="type">char</span> *pathStr = env-&gt;<span class="type">GetStringUTFChars</span>(path, <span class="type">NULL</span>);
    <span class="keyword">if</span> (pathStr == <span class="type">NULL</span>) {  // <span class="type">Out</span> <span class="keyword">of</span> memory
        <span class="keyword">return</span>;
    }

    //构造<span class="type">Native</span>层的<span class="type">MyMediaScannerClient</span>，并使用<span class="type">Java</span>层的<span class="type">Client</span>对象做参数
    <span class="type">MyMediaScannerClient</span> myClient(env, client);
    <span class="type">MediaScanResult</span> <span class="literal">result</span> = mp-&gt;processDirectory(pathStr, myClient);//调用<span class="type">Native</span>层的<span class="type">MediaScanner</span>扫描文件夹，并把<span class="type">Native</span>的<span class="type">MyMediaScannerClient</span>传进去
    <span class="keyword">if</span> (<span class="literal">result</span> == <span class="type">MEDIA_SCAN_RESULT_ERROR</span>) {
        <span class="type">ALOGE</span>(<span class="string">"An error occurred while scanning directory '%s'."</span>, pathStr);
    }
    env-&gt;<span class="type">ReleaseStringUTFChars</span>(path, pathStr);
}
</code></pre><p>frameworks/av/media/libmedia/MediaScanner.cpp</p>
<pre><code><span class="type">MediaScanResult</span> <span class="type">MediaScanner</span>::processDirectory(
        <span class="keyword">const</span> <span class="type">char</span> *path, <span class="type">MediaScannerClient</span> &amp;client) {
     ……
    client.setLocale(locale());//给<span class="type">Native</span>的<span class="type">MyMediaScannerClient</span>设置local信息

    <span class="type">MediaScanResult</span> <span class="literal">result</span> = doProcessDirectory(pathBuffer, pathRemaining, client, <span class="literal">false</span>);//调用doProcessDirectory扫描文件夹

    free(pathBuffer);

    <span class="keyword">return</span> <span class="literal">result</span>;
}



<span class="type">MediaScanResult</span> <span class="type">MediaScanner</span>::doProcessDirectory(
        <span class="type">char</span> *path, <span class="type">int</span> pathRemaining, <span class="type">MediaScannerClient</span> &amp;client, <span class="type">bool</span> noMedia) {
    ……//忽略.nomedia文件夹

    <span class="type">DIR</span>* dir = opendir(path);
    <span class="keyword">if</span> (!dir) {
        <span class="type">ALOGW</span>(<span class="string">"Error opening directory '%s', skipping: %s."</span>, path, strerror(errno));
        <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_SKIPPED</span>;
    }

    <span class="type">MediaScanResult</span> <span class="literal">result</span> = <span class="type">MEDIA_SCAN_RESULT_OK</span>;
    <span class="keyword">while</span> ((entry = readdir(dir))) {
        <span class="keyword">if</span> (doProcessDirectoryEntry(path, pathRemaining, client, noMedia, entry, fileSpot)
                == <span class="type">MEDIA_SCAN_RESULT_ERROR</span>) {
            <span class="literal">result</span> = <span class="type">MEDIA_SCAN_RESULT_ERROR</span>;
            <span class="keyword">break</span>;
        }
    }
    closedir(dir);
    <span class="keyword">return</span> <span class="literal">result</span>;
}



<span class="type">MediaScanResult</span> <span class="type">MediaScanner</span>::doProcessDirectoryEntry(
        <span class="type">char</span> *path, <span class="type">int</span> pathRemaining, <span class="type">MediaScannerClient</span> &amp;client, <span class="type">bool</span> noMedia,
        struct dirent* entry, <span class="type">char</span>* fileSpot) {
    struct stat statbuf;
    <span class="keyword">const</span> <span class="type">char</span>* name = entry-&gt;d_name;//枚举目录中的文件和子文件夹信息

    // ignore <span class="string">"."</span> <span class="keyword">and</span> <span class="string">".."</span>
    <span class="keyword">if</span> (name[<span class="number">0</span>] == '.' &amp;&amp; (name[<span class="number">1</span>] == <span class="number">0</span> || (name[<span class="number">1</span>] == '.' &amp;&amp; name[<span class="number">2</span>] == <span class="number">0</span>))) {
        <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_SKIPPED</span>;
    }

    <span class="type">int</span> nameLength = strlen(name);
    <span class="keyword">if</span> (nameLength + <span class="number">1</span> &gt; pathRemaining) {
        // path too long!
        <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_SKIPPED</span>;
    }
    strcpy(fileSpot, name);

    <span class="type">int</span> <span class="keyword">type</span> = entry-&gt;d_type;
    <span class="keyword">if</span> (<span class="keyword">type</span> == <span class="type">DT_UNKNOWN</span>) {
        // <span class="type">If</span> the <span class="keyword">type</span> <span class="keyword">is</span> unknown, stat() the file instead.
        // <span class="type">This</span> <span class="keyword">is</span> sometimes necessary <span class="keyword">when</span> accessing <span class="type">NFS</span> mounted filesystems, but
        // could be needed <span class="keyword">in</span> other cases well.
        <span class="keyword">if</span> (stat(path, &amp;statbuf) == <span class="number">0</span>) {
            <span class="keyword">if</span> (<span class="type">S_ISREG</span>(statbuf.st_mode)) {
                <span class="keyword">type</span> = <span class="type">DT_REG</span>;
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">S_ISDIR</span>(statbuf.st_mode)) {
                <span class="keyword">type</span> = <span class="type">DT_DIR</span>;
            }
        } <span class="keyword">else</span> {
            <span class="type">ALOGD</span>(<span class="string">"stat() failed for %s: %s"</span>, path, strerror(errno) );
        }
    }
    <span class="keyword">if</span> (<span class="keyword">type</span> == <span class="type">DT_DIR</span>) {
        //文件夹
        <span class="type">bool</span> childNoMedia = noMedia;
        // <span class="type">set</span> noMedia flag on directories <span class="keyword">with</span> a name that starts <span class="keyword">with</span> '.'
        // <span class="keyword">for</span> example, the <span class="type">Mac</span> <span class="string">".Trashes"</span> directory
        <span class="keyword">if</span> (name[<span class="number">0</span>] == '.')
            childNoMedia = <span class="literal">true</span>;

        // report the directory to the client
        <span class="keyword">if</span> (stat(path, &amp;statbuf) == <span class="number">0</span>) {
            status_t status = client.scanFile(path, statbuf.st_mtime, <span class="number">0</span>,
                    <span class="literal">true</span> /*isDirectory*/, childNoMedia);
            <span class="keyword">if</span> (status) {
                <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_ERROR</span>;
            }
        }

        // <span class="keyword">and</span> now process its contents
        strcat(fileSpot, <span class="string">"/"</span>);
        //如果是子文件夹，递归调用doProcessDirectory
        <span class="type">MediaScanResult</span> <span class="literal">result</span> = doProcessDirectory(path, pathRemaining - nameLength - <span class="number">1</span>,
                client, childNoMedia);
        <span class="keyword">if</span> (<span class="literal">result</span> == <span class="type">MEDIA_SCAN_RESULT_ERROR</span>) {
            <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_ERROR</span>;
        }
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">type</span> == <span class="type">DT_REG</span>) {
        stat(path, &amp;statbuf);//取出文件修改时间和大小
        status_t status = client.scanFile(path, statbuf.st_mtime, statbuf.st_size,
                <span class="literal">false</span> /*isDirectory*/, noMedia);//调用<span class="type">MyMediaScannerClient</span>的scanFile函数
        <span class="keyword">if</span> (status) {
            <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_ERROR</span>;
        }
    }

    <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_OK</span>;
}
</code></pre><h3 id="3-2-4_MyMediaScannerClient的scanFile分析">3.2.4 MyMediaScannerClient的scanFile分析</h3><p>(1)JNI层的scanFile<br>android_media_MediaScanner.cpp</p>
<pre><code>virtual status_t scanFile(<span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">long</span> <span class="keyword">long</span> lastModified,
        <span class="keyword">long</span> <span class="keyword">long</span> fileSize, <span class="keyword">bool</span> isDirectory, <span class="keyword">bool</span> noMedia)
{
    ALOGV(<span class="string">"scanFile: path(%s), time(%lld), size(%lld) and isDir(%d)"</span>,
        path, lastModified, fileSize, isDirectory);

    jstring pathStr;
    <span class="keyword">if</span> ((pathStr = mEnv-&gt;NewStringUTF(path)) == <span class="keyword">NULL</span>) {
        mEnv-&gt;ExceptionClear();
        <span class="keyword">return</span> NO_MEMORY;
    }
    <span class="comment">//mClient是Java层的MyMediaScannerClient对象，调用其scanFile函数</span>
    mEnv-&gt;CallVoidMethod(mClient, mScanFileMethodID, pathStr, lastModified,
            fileSize, isDirectory, noMedia);

    mEnv-&gt;DeleteLocalRef(pathStr);
    <span class="keyword">return</span> checkAndClearExceptionFromCallback(mEnv, <span class="string">"scanFile"</span>);
}
</code></pre><p>(2)Java层的scanFile函数</p>
<pre><code>    @Override
    <span class="keyword">public</span> <span class="keyword">void</span> scanFile(<span class="keyword">String</span> path, <span class="keyword">long</span> lastModified, <span class="keyword">long</span> fileSize,
            <span class="built_in">boolean</span> isDirectory, <span class="built_in">boolean</span> noMedia) {
        <span class="comment">// This is the callback funtion from native codes.</span>
        <span class="comment">// Log.v(TAG, "scanFile: "+path);</span>
        doScanFile(path, <span class="keyword">null</span>, lastModified, fileSize, isDirectory, <span class="keyword">false</span>, noMedia);<span class="comment">//调用doScanFile函数</span>
    }



    <span class="keyword">public</span> Uri doScanFile(<span class="keyword">String</span> path, <span class="keyword">String</span> mimeType, <span class="keyword">long</span> lastModified,
            <span class="keyword">long</span> fileSize, <span class="built_in">boolean</span> isDirectory, <span class="built_in">boolean</span> scanAlways, <span class="built_in">boolean</span> noMedia) {
        <span class="comment">//scanAlways：是否强制扫描。有时候有些文件 在两次扫描过程中没有发生变化，MediaScanner可以不处理这些文件。scanAlways为true，则文件没有变化也要扫描</span>
        Uri result = <span class="keyword">null</span>;
<span class="comment">//        long t1 = System.currentTimeMillis();</span>
        <span class="keyword">try</span> {
            <span class="comment">//beginFile根据lastModified值，判断这个文件在两次扫描的时间段内 是否有修改，如果有修改，则需要重新扫描</span>
            FileEntry entry = beginFile(path, mimeType, lastModified,
                    fileSize, isDirectory, noMedia);

            <span class="comment">// if this file was just inserted via mtp, set the rowid to zero</span>
            <span class="comment">// (even though it already exists in the database), to trigger</span>
            <span class="comment">// the correct code path for updating its entry</span>
            <span class="keyword">if</span> (mMtpObjectHandle != <span class="number">0</span>) {
                entry.mRowId = <span class="number">0</span>;
            }
            <span class="comment">// rescan for metadata if file was modified since last scan</span>
            <span class="keyword">if</span> (entry != <span class="keyword">null</span> &amp;&amp; (entry.mLastModifiedChanged || scanAlways)) {
                <span class="keyword">if</span> (noMedia) {
                    result = endFile(entry, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);
                } <span class="keyword">else</span> {
                    <span class="keyword">String</span> lowpath = path.toLowerCase(Locale.ROOT);
                    <span class="built_in">boolean</span> ringtones = (lowpath.indexOf(RINGTONES_DIR) &gt; <span class="number">0</span>);
                    <span class="built_in">boolean</span> notifications = (lowpath.indexOf(NOTIFICATIONS_DIR) &gt; <span class="number">0</span>);
                    <span class="built_in">boolean</span> alarms = (lowpath.indexOf(ALARMS_DIR) &gt; <span class="number">0</span>);
                    <span class="built_in">boolean</span> podcasts = (lowpath.indexOf(PODCAST_DIR) &gt; <span class="number">0</span>);
                    <span class="built_in">boolean</span> music = (lowpath.indexOf(MUSIC_DIR) &gt; <span class="number">0</span>) ||
                        (!ringtones &amp;&amp; !notifications &amp;&amp; !alarms &amp;&amp; !podcasts);

                    <span class="built_in">boolean</span> isaudio = MediaFile.isAudioFileType(mFileType);
                    <span class="built_in">boolean</span> isvideo = MediaFile.isVideoFileType(mFileType);
                    <span class="built_in">boolean</span> isimage = MediaFile.isImageFileType(mFileType);

                    <span class="keyword">if</span> (isaudio || isvideo || isimage) {
                        path = Environment.maybeTranslateEmulatedPathToInternal(<span class="keyword">new</span> File(path))
                                .getAbsolutePath();
                    }

                    <span class="comment">// we only extract metadata for audio and video files</span>
                    <span class="keyword">if</span> (isaudio || isvideo) {
                        processFile(path, mimeType, <span class="keyword">this</span>);<span class="comment">//native方法</span>
                    }

                    <span class="keyword">if</span> (isimage) {
                        processImageFile(path);
                    }

                    result = endFile(entry, ringtones, notifications, alarms, music, podcasts);<span class="comment">//扫描完成后，需要把新的信息插入数据库，或者要将原有的信息更新</span>
                }
            }
        } <span class="keyword">catch</span> (RemoteException e) {
            Log.e(TAG, <span class="string">"RemoteException in MediaScanner.scanFile()"</span>, e);
        }
<span class="comment">//        long t2 = System.currentTimeMillis();</span>
<span class="comment">//        Log.v(TAG, "scanFile: " + path + " took " + (t2-t1));</span>
        <span class="keyword">return</span> result;
    }
</code></pre><p>(3)JNI层的processFile分析</p>
<pre><code>static void
android_media_MediaScanner_processFile<span class="list">(
        <span class="keyword">JNIEnv</span> <span class="variable">*env, jobject thiz, jstring path,
        jstring mimeType, jobject client)
{
    ALOGV("processFile");

    // Lock already hold by processDirectory
    MediaScanner *</span>mp = getNativeScanner_l<span class="list">(<span class="keyword">env</span>, thiz)</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">mp</span> == NULL)</span> {
        jniThrowException<span class="list">(<span class="keyword">env</span>, kRunTimeException, <span class="string">"No scanner available"</span>)</span><span class="comment">;</span>
        return<span class="comment">;</span>
    }

    if <span class="list">(<span class="keyword">path</span> == NULL)</span> {
        jniThrowException<span class="list">(<span class="keyword">env</span>, kIllegalArgumentException, NULL)</span><span class="comment">;</span>
        return<span class="comment">;</span>
    }

    const char <span class="variable">*pathStr = env-&gt;GetStringUTFChars(path, NULL);
    if (pathStr == NULL) {  // Out of memory
        return;
    }

    const char *</span>mimeTypeStr =
        <span class="list">(<span class="keyword">mimeType</span> ? env-&gt;GetStringUTFChars<span class="list">(<span class="keyword">mimeType</span>, NULL)</span> : NULL)</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">mimeType</span> <span class="keyword">&amp;&amp;</span> mimeTypeStr == NULL)</span> {  // Out of memory
        // ReleaseStringUTFChars can be called with an exception pending.
        env-&gt;ReleaseStringUTFChars<span class="list">(<span class="keyword">path</span>, pathStr)</span><span class="comment">;</span>
        return<span class="comment">;</span>
    }

    MyMediaScannerClient myClient<span class="list">(<span class="keyword">env</span>, client)</span><span class="comment">;</span>
    MediaScanResult result = mp-&gt;processFile<span class="list">(<span class="keyword">pathStr</span>, mimeTypeStr, myClient)</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">result</span> == MEDIA_SCAN_RESULT_ERROR)</span> {
        ALOGE<span class="list">(<span class="string">"An error occurred while scanning file '%s'."</span>, pathStr)</span><span class="comment">;</span>
    }
    env-&gt;ReleaseStringUTFChars<span class="list">(<span class="keyword">path</span>, pathStr)</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">mimeType</span>)</span> {
        env-&gt;ReleaseStringUTFChars<span class="list">(<span class="keyword">mimeType</span>, mimeTypeStr)</span><span class="comment">;</span>
    }
}</span>
</code></pre><p>frameworks/av/media/libstagefright/StagefrightMediaScanner.cpp</p>
<pre><code><span class="type">MediaScanResult</span> <span class="type">StagefrightMediaScanner</span>::processFile(
        <span class="keyword">const</span> <span class="type">char</span> *path, <span class="keyword">const</span> <span class="type">char</span> *mimeType,
        <span class="type">MediaScannerClient</span> &amp;client) {
    <span class="type">ALOGV</span>(<span class="string">"processFile '%s'."</span>, path);

    client.setLocale(locale());
    client.beginFile();
    <span class="type">MediaScanResult</span> <span class="literal">result</span> = processFileInternal(path, mimeType, client);
    client.endFile();
    <span class="keyword">return</span> <span class="literal">result</span>;
}
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/02/framework-MediaScanner/" data-id="cisvbrdcy000urso0oj09gjog" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/framework/">framework</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/12/03/数据结构3-树-上-——3-2-二叉树与存储结构/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          数据结构3-树-上-——3-2-二叉树与存储结构
        
      </div>
    </a>
  
  
    <a href="/2015/12/02/数据结构3-树-上-——3-1-树与树的表示/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">数据结构3-树(上)——3-1-树与树的表示</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/SELinux/">SELinux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/framework/">framework</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a><span class="tag-list-count">13</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/SELinux/" style="font-size: 10px;">SELinux</a> <a href="/tags/framework/" style="font-size: 10px;">framework</a> <a href="/tags/数据结构/" style="font-size: 20px;">数据结构</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/09/09/spannableString/">(no title)</a>
          </li>
        
          <li>
            <a href="/2016/01/19/SELinux/">SELinux</a>
          </li>
        
          <li>
            <a href="/2015/12/10/数据结构5-树-下-5-1-堆/">数据结构5-树-下-5-1-堆</a>
          </li>
        
          <li>
            <a href="/2015/12/08/数据结构4-树-中-——4-2-平衡二叉树/">数据结构4-树-中-——4-2-平衡二叉树</a>
          </li>
        
          <li>
            <a href="/2015/12/07/数据结构4-树-中-——4-1-二叉搜索树/">数据结构4-树-中-——4-1-二叉搜索树</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Jie Qiong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>