<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-c语言程序设计进阶-1数据类型" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/09/c语言程序设计进阶-1数据类型/" class="article-date">
  <time datetime="2016-09-09T11:51:28.000Z" itemprop="datePublished">2016-09-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/09/c语言程序设计进阶-1数据类型/">c语言程序设计进阶-1数据类型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-0_数据类型">1.0 数据类型</h1><p>sizeof<br>是一个运算符，给出某个类型或变量在内存中 所占据的字节数</p>
<ul>
<li>是静态运算符，它的结果在编译时刻就决定了</li>
<li><p>sizeof括号里的运算是不会做的</p>
</li>
<li><p>sizeof(int)</p>
</li>
<li><p>sizeof(i)</p>
<pre><code><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span>
<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>
</span>{
    <span class="keyword">int</span> a;
    a = <span class="number">6</span>;
    <span class="built_in">printf</span>(<span class="string">"sizeof(a) =%ld\n"</span>, <span class="keyword">sizeof</span>(a));<span class="comment">//4</span>
    <span class="built_in">printf</span>(<span class="string">"sizeof(int)=%ld\n"</span>, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));<span class="comment">//4</span>
    <span class="built_in">printf</span>(<span class="string">"sizeof(a++)=%ld\n"</span>, <span class="keyword">sizeof</span>(a++));<span class="comment">//4 运行完 a=6</span>
    <span class="built_in">printf</span>(<span class="string">"sizeof(a+1.0)=%ld\n"</span>, <span class="keyword">sizeof</span>(a+<span class="number">1.0</span>));<span class="comment">//8 因为1.0是double，double的字节数是8</span>

}
</code></pre></li>
</ul>
<h1 id="1-1_整数类型">1.1 整数类型</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/09/c语言程序设计进阶-1数据类型/" data-id="cisvpt2ry000x0ko0jvlld603" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c语言程序设计进阶/">c语言程序设计进阶</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-spannableString" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/09/spannableString/" class="article-date">
  <time datetime="2016-09-09T01:54:05.479Z" itemprop="datePublished">2016-09-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="TextView_SpannableString">TextView SpannableString</h1><p><a href="http://blog.csdn.net/fengyuzhengfan/article/details/38459299" target="_blank" rel="external">http://blog.csdn.net/fengyuzhengfan/article/details/38459299</a><br><a href="http://blog.csdn.net/fengyuzhengfan/article/details/38470675" target="_blank" rel="external">http://blog.csdn.net/fengyuzhengfan/article/details/38470675</a><br><a href="http://blog.csdn.net/nnmmbb/article/details/37656513" target="_blank" rel="external">http://blog.csdn.net/nnmmbb/article/details/37656513</a></p>
<h4 id="Android中设置文本样式的几种方法">Android中设置文本样式的几种方法</h4><ul>
<li>将android:autoLink属性值设为true。系统会自动识别E-mail、电话、网址等特殊文本。</li>
<li>在Java代码中直接使用Span对象来设置文本样式。这种方法需要将文本转换成一个SpannableString或SpannableStringBuilder对象，然后在SpannableString或SpannableStringBuilder对象中使用setSpan方法将要设置样式的文本转换成相应的Span对象。</li>
</ul>
<h4 id="void_setSpan(Object_what,_int_start,_int_end,_int_flags)">void setSpan(Object what, int start, int end, int flags)</h4><p>what:设置一个Span对象<br>start：起始位置<br>end：结束位置（不包含结束位置）<br>flags值说明：</p>
<ul>
<li>Spanned.SPAN_EXCLUSIVE_INCLUSIVE:在 Span前面输入的字符不应用 Span的效果，在后面输入的字符应用Span效果。</li>
<li>Spanned.SPAN_INCLUSIVE_EXCLUSIVE:在 Span前面输入的字符应用 Span 的效果，在后面输入的字符不应用Span效果。</li>
<li>Spanned.SPAN_INCUJSIVE_INCLUSIVE:在 Span前后输入的字符都应用 Span 的效果。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/09/spannableString/" data-id="cisvpt2rt000s0ko0la3dxtse" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-SELinux" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/19/SELinux/" class="article-date">
  <time datetime="2016-01-19T06:34:19.000Z" itemprop="datePublished">2016-01-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/19/SELinux/">SELinux</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>参考：<a href="http://blog.csdn.net/innost/article/details/19641487" target="_blank" rel="external">http://blog.csdn.net/innost/article/details/19641487</a></p>
<h1 id="一、SELinux背景知识">一、SELinux背景知识</h1><h2 id="1-DAC与MAC">1.DAC与MAC</h2><h2 id="1-1_简介">1.1 简介</h2><ul>
<li>DAC（Discretionary Access Control）：自主访问控制。进程权限与 执行它的用户权限相同。root用户启动Browser，Browser就有root权限。</li>
<li>MAC（Mandatory Access Control）：强制访问机制。进程想在SELinux系统中做事，要先在 安全策略配置文件 中 赋予权限。没有出现在 安全策略配置文件中 的权限，进程就没有该权限。</li>
</ul>
<p>【例1】SELinux中权限举例：</p>
<hr>
<pre><code><span class="comment">#允许（allow）netd域（domain）中的进程 写（write）类型为proc_net文件</span>
<span class="comment">#路径:external/sepolicy/netd.te</span>
allow netd proc_net:<span class="type">file</span> <span class="command">write</span>;
</code></pre><ul>
<li>总结：<ul>
<li>Linux系统先做 DAC权限检查。如果 没有通过DAC，则操作失败；如果 通过DAC检查，再做MAC权限检查；</li>
<li>SELinux中也有用户的概念，和Linux中 原有的user概念 不是同一个东西。Linux中root在 SELinux中可以 没权限，由SELinux安全策略 制定者决定。</li>
</ul>
</li>
<li>学习目标：<ul>
<li>看懂现有的安全策略文件；</li>
<li>编写符合特定需求的 安全策略文件。</li>
</ul>
</li>
</ul>
<h2 id="1-2-SELinux_Policy语言介绍">1.2.SELinux Policy语言介绍</h2><p>SELinux Policy语言：编写 安全策略文件 的规则。</p>
<p>Linux中有2中东西：</p>
<ul>
<li>死的（Inactive）:文件。万物皆文件</li>
<li>活的（Active）：进程。能发起动作</li>
</ul>
<p>SELinux中，每种东西都被赋予一个 安全属性： Security Context（以后称为SContext）。Security Context是一个字符串。</p>
<h3 id="进程的SContext，可通过命令：ps_-Z_查看。">进程的SContext，可通过命令：ps -Z 查看。</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/eb8dc683295707e7a3286ae1952d80d24e97bc42/20160119/ps-Z.PNG" alt="ps -Z"></p>
<p>左边第一列 是SContext，以init进程的SContext为例，其值为：u:r:init:s0。</p>
<ul>
<li>u：user。SEAndroid中定义了一个SELinux用户，值为u。</li>
<li>r：role。是SELinux中更方便的 权限管理思路（Role Based Access Control，基于角色的访问控制，RBAC）。一个u可以属于多个role，不同的role具有不同的权限。</li>
<li>init：该进程所属的 domain 为 init。MAC的基础管理思路是 TEAC（Type Enforcement Access Contr，简称TEAC，一般用TE表示），对于进程，Type就是Domain。init这个domain有什么权限，需要通过allow语句说明。</li>
<li>s0：与MLS（Multi-Level Security）机制有关。MLS将 系统的 进程和文件 进行分级，不同级别的资源 需要不同级别的进程才能访问。</li>
</ul>
<h3 id="文件的SContext，可通过命令：ls_-Z_查看。">文件的SContext，可通过命令：ls -Z 查看。</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/53648baf809ab1fc2b213b8b9fd85f6bae4914ca/20160119/ls-Z.PNG" alt="ls -Z"></p>
<p>倒数第二列是 文件和目录的SContext信息，以root目录为例，其信息为：u:object_r:rootfs:s0</p>
<ul>
<li>u:user。代表创建这个文件的SELinux user。</li>
<li>object_r:role。死的东西用object_r表示它的role。</li>
<li>rootfs:type。root目录对应的Type是rootfs。</li>
<li>s0：MLS的级别。</li>
</ul>
<h3 id="总结：">总结：</h3><p>SContext字符串格式为：<br>user:role:type[:range]<br>s0是range中的一部分，SContext核心是前3个部分：user:role:type</p>
<p>MAC基本管理单位是TEAC（Type Enforcement Access Control），然后是高一级别的RBAC（Role Based Access Control）。RBAC是基于TE的，TE是SELinux中最主要的部分。</p>
<h2 id="2-1_TE介绍">2.1 TE介绍</h2><p>【例2】</p>
<pre><code><span class="comment">#路径:external/sepolicy/netd.te</span>
allow netd proc_net:<span class="type">file</span> <span class="command">write</span>;
</code></pre><ul>
<li>allow：allow语句，表示授权。除了allow，还有auditallow， dontaudit， neverallow等</li>
<li>netd：source type，也叫subject，domain</li>
<li>proc_net：target type，代表其后的file对应的type</li>
<li>file：Object Class。代表能够给subject操作的一类东西。如File，Dir，Socket等。Android中的Binder，在其他Linux中是没有没有这个Object Class的。</li>
<li>write：该类Object Class中所定义的操作。</li>
</ul>
<p><strong> 语句格式： </strong><br>rule_name source_type target_type : class perm_set<br>【例3】</p>
<pre><code><span class="preprocessor">#路径：/external/sepolicy/zygote.te:</span>
<span class="preprocessor">#允许 zygote域中的进程 search或getattr 类型为appdomain的目录，多个perm_set可用{}括起来</span>
allow zygote appdomain:dir { getattr search };
<span class="preprocessor"># ~表示除了，target_type为一组，除了appdomain  和system_server；</span>
<span class="preprocessor">#特殊符号：~表示 除了，-表示去除某项，*表示所有内容</span>
<span class="preprocessor">#neverallow表示 绝对不允许。</span>
neverallow zygote ~{ appdomain system_server }:process dyntransition;

<span class="preprocessor">#路径：./external/sepolicy/domain.te</span>
<span class="preprocessor">#source_type属于 domain，但是不属于 kernel，ueventd，init</span>
<span class="preprocessor"># *表示和所有chr_file 相关的权限</span>
neverallow { domain -kernel -ueventd -init } kmem_device:chr_file *;
</code></pre><h3 id="neverallow的作用：">neverallow的作用：</h3><p>权限必须要 显示声明，没有声明的话 默认就是 没有权限。neverallow有存在的必要吗？<br>neverallow的作用：在生成 安全策略文件时 进行检查，判断 是否有违反 neverallow语句的 allow语句。生成 安全策略文件时 监测到冲突：<br><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/82d4f9b82a29918486f60f8a0605c83eda0bb5b7/20160119/neverallow%E4%BD%9C%E7%94%A8.PNG" alt="neverallow作用"></p>
<h2 id="2-1-1_Object_Class和Perm_Set">2.1.1 Object Class和Perm Set</h2><h3 id="Object_Class">Object Class</h3><p>Object Class 很难说清楚定义，常见的Object Class如下：<br>路径：external/sepolicy/security_classes<br><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/b28f6e3f5261cb9a7ce52d28026cf915066e7bc9/20160119/ObjectClass.PNG" alt="Object Class"></p>
<ul>
<li>Object Class需要class语句声明，这些声明一般放在security_classes文件中</li>
<li>这些class与kernel中相关模块 紧密结合。kernel编译时会 根据security_classes文件生成对应的头文件，该文件一般不需要修改。</li>
</ul>
<h3 id="Perm_Set">Perm Set</h3><p>路径： external/sepolicy/access_vectors</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/f7160353f03fa3d0dd5d2657fadbeef922ffd7cd/20160119/PermSet.PNG" alt="Perm Set"></p>
<h2 id="2-1-2_type,_attribute_和_rule_name等">2.1.2 type, attribute 和 rule_name等</h2><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/38981d83d22823464b00ba9e1ef6e4397b7388d2/20160119/type_attribute.PNG" alt="type attribute"></p>
<ul>
<li>type和attribute在同一个命名空间，即不能用type命令 和 attribute命令定义相同名字的东西</li>
<li>attribute类似type(或domain) group这样的概念。type A与 attribute B关联，就是说 type A属于 group B中的一员</li>
</ul>
<h3 id="使用attribute有什么好处？">使用attribute有什么好处？</h3><p>系统会定义很多Type，每个Type用allow语句设置相应的权限，安全策略文件编起来 非常麻烦。<br>有了attribute，可以将Type与某个attribute关联起来，用一个allow语句，将source_type设置为这个attribute：</p>
<ul>
<li>这也是 type和attribute在同一个命名空间的原因</li>
<li>这种做法减轻了TE文件编写者的烦恼，编译 安全策略文件时，会将attribute拓展为其包含的type：<br>【例4】：</li>
</ul>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/4f9666cfece8686b1b7b6ed46ac769d46b8829bf/20160119/type%E4%BE%8B%E5%AD%90.PNG" alt="type例子"></p>
<p>TE的完整格式为：<br>rule_name source_type target_type : class perm_set<br>attribute可以出现在source_type和target_type中</p>
<p>SEAndroid中定义的attribute都在external/sepolicy/attributes中，如果分不清是type还是attribute，可以查看该文件。</p>
<h3 id="rule_name">rule_name</h3><ul>
<li>allow：赋予某项权限</li>
<li>auditallow：audit就是记录某项操作。默认情况SELinux只记录 权限检查失败的操作。auditallow使得 权限检查成功 的操作 也被记录。auditallowshi允许记录，与 赋予权限没关系。</li>
<li>dontaudit：对 那些权限检查失败的操作 不做记录。</li>
<li>neverallow：绝对不允许。用于检查 安全策略文件中 是否有 违反该项规则的allow语句。</li>
</ul>
<h2 id="2-1-3_RBAC和constrain">2.1.3 RBAC和constrain</h2><p>绝大多数情况下，SELinux的安全配置策略 需要编写各种xx.te文件， .te文件汇总包含各种 allow，type等语句。这些都是TEAC，是SELinux MAC中的核心组成部分。<br>REAC是一种基于Role的安全策略。</p>
<h3 id="Role定义">Role定义</h3><p>路径：external/sepolicy/roles</p>
<pre><code><span class="comment">#Android只定义了一个role，名字是r</span>
<span class="keyword">role</span> <span class="title">r</span>;
<span class="comment">#将上边定义的r和 attribute domain关联起来</span>
<span class="keyword">role</span> <span class="title">r</span> types domain;
</code></pre><h3 id="user定义">user定义</h3><p>路径：external/sepolicy/users</p>
<pre><code><span class="preprocessor">#支持MLS的user格式定义为：</span>
<span class="preprocessor">#user seuser_id roles role_id level mls_level range mls_range;</span>
<span class="preprocessor">#不支持MLS user定义格式为：</span>
<span class="preprocessor">#user seuser_id roles role_id;</span>
<span class="preprocessor">#SEAndroid使用了支持MLS的格式。下面定义的这个user u 将和 role r关联。一个user可以和多个role关联</span>
<span class="preprocessor">#level之后的是该user具有的 安全级别。s0为最低级，也就是默认的级别；</span>
<span class="preprocessor">#mls_systemhigh为u所能获得的 最高安全级别（security level）</span>
user u roles { r } level s0 range s0 - mls_systemhigh;
</code></pre><h3 id="Roles_和_Users中有什么样的权限控制呢？">Roles 和 Users中有什么样的权限控制呢？</h3><p><strong>1.</strong> 允许从一个role切换到另一个role，SELinux中用transition表达 切换 之意</p>
<pre><code><span class="preprocessor">#注意，关键字也是allow，但是和 前面TE中的allow 不是一个东西</span>
<span class="preprocessor">#下面的allow允许 from_role_id 切换到 to_role_id</span>
allow from_role_id to_role_id;
</code></pre><p><strong>2.</strong> 角色之间的关系。SELinux中，Role和Role之间的关系 和公司中的管理人员的层级关系类似</p>
<pre><code><span class="comment">#dominance语句属于deprecated语句，MLS中有新的定义层级相关的语句，此处介绍的是SELinux中的层级关系</span>
<span class="comment">#下面这句话表示 super_r dominate(统治， dom) sysadm_r 和 secadm_r 两个角色</span>
<span class="comment">#反过来说，sysadm_r 和 secadm_r bominate by（被统治，domby）super_r</span>
<span class="comment">#从type 角度看，super_r 将自动继承 sysadm_r 和 secadm_r 所关联的type(或attribute)</span>
dominance { <span class="keyword">role</span> <span class="title">super_r</span> {<span class="keyword">role</span> <span class="title">sysadm_r</span>; <span class="keyword">role</span> <span class="title">secadm_r</span>; }}
</code></pre><p><strong>3.</strong>其他内容，SEAndroid没有使用，可参考其它文献。<br>怎么实现基于Role或User的权限控制呢？SELinux提供了一个新的关键词：constrain</p>
<pre><code>#<span class="keyword">constrain</span>标准格式为：
#<span class="keyword">constrain</span> object_class_set perm_set <span class="keyword">expression</span>;
#下面这句话 表示 只有<span class="keyword">source</span>和target的user相同，并且role也相同，才允许 write object_class 为<span class="keyword">file</span>
<span class="keyword">constrain</span> <span class="keyword">file</span> write (u1 == u2 and r1 == r2);
</code></pre><h3 id="expression包含的关键词如下：">expression包含的关键词如下：</h3><ul>
<li>u1,r1,t1:代表source的user，role和type</li>
<li>u2,r2,t2:代表target的user，role和type</li>
<li>== 和 !=: ==表示相等或属于，!=表示不等或不属于。 对于u，r，==和!=表示相等或 不等；对于t1 == 或 != 某个attribute时，表示 源type 属于或不属于 这个attribute</li>
<li>dom，domby，incomp，eq：仅针对role，表示：统治、被统治、没关系 和 相同（和== 一样）</li>
</ul>
<h3 id="constrain补充知识点：">constrain补充知识点：</h3><ul>
<li>SEAndroid中没有使用constrain，而是用了MLS的mlsconstrain</li>
<li>constrain是对TEAC的加强。<br>TEAC仅针对Type和Domain，没有针对user和role，所以constrain在TEAC基础上，进一步加强了权限控制。<br>实际使用中，SELinux进行权限检查时，先检查TE是否满足条件，然后再检查constrain是否也满足条件。二者都满足，权限才能满足。</li>
</ul>
<h3 id="RBAC和constrain到底想要干什么">RBAC和constrain到底想要干什么</h3><p>TE是Type Enforcement，没有user和role什么事，而RBAC则可通过constrain语句来在user和role上再加一些限制。constrain也可以对type进行限制。</p>
<h2 id="2-2_Labeling介绍">2.2 Labeling介绍</h2><p>SContext最开始是怎么赋给这些 死的 活的 东西的？<br>SELinux中，设置或分配SContext给进程或文件的工作叫 Security Labeling，即 打标签。</p>
<h2 id="2-2-1_sid和sid_context">2.2.1 sid和sid_context</h2><p>Android系统启动之后，init进程 会将 一个编译完的 安全策略文件 传递给 kernel 以初始化kernel中的 SELinux相关模块（先用Linux Security Module：LSM表示，略有不准，先这样表示），然后LSM根据其中的信息，给相关 Object 打标签。</p>
<h3 id="initial_sids_和_initial_sid_context:">initial_sids 和 initial_sid_context:</h3><p>保存LSM初始化时 所需信息 及 SContext信息</p>
<ul>
<li>initial_sids :<br>路径：external/sepolicy/initial_sids<br>定义了LSM初始化时的相关信息。<br>sid是SELinux中的一个概念，全称是 Security Identifier。<br>sid类似SContext的key值，实际运行时，SELinux会用sid来匹配某个SContext，因为SContext是字符串，一直比较字符串会 严重影响效率。</li>
<li>initial_sid_contexts<br>路径：external/sepolicy/initial_sid_contexts<br>sid设置最初的SContext信息。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/68d68ea68ff4f63f2d0b695f1e3c26ea4881c8ce/20160119/initial_sid%20and%20context.PNG" alt="initial_sids 和 initial_sid_context"></p>
<p>sid的细节需要查看LSM的实现。这两个文件和Kernel紧密相连，一般不用修改。</p>
<h2 id="2-2-2_Domain/Type_Transition_和宏">2.2.2 Domain/Type Transition 和宏</h2><p>SEAndroid中，init进程的SContext为u:r:init:s0，而init 创建的子进程 的SContext 不可能和 init进程的 SContext一样，否则 根据TE，子进程在MAC层面上 有了和 init一样的权限。<br>这些子进程的SContext 是怎么被打上 和其父进程 不一样的SContext呢？</p>
<p>SELinux中，上述问题被称为 Domain Transition，即 某个进程的domain 切换到 一个更合适的domain中去。<br>Domain Transition也需要我们在 安全策略文件中 配置，有相关的关键词。</p>
<p>【例7-1】<br><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/98f92086a4db6e7807ffb0c54d544c81a378ece0/20160119/type_transition.PNG" alt="type_transition"></p>
<ul>
<li>当init_t Domain 中的进程 执行 type为 apache_exec_t的可执行文件（fork并execv）时，其class（此处是process）所属的Domain 需要切换到 apache_t域。</li>
</ul>
<p>要做DT，需要先fork一个子进程，然后通过execv打开一个新的可执行文件，从而进入这个可执行文件 对应的 活物。</p>
<ul>
<li>在type_transition语句中，target_type往往是 那个可执行文件（死物）的type。</li>
<li>default_type则表示execv执行后，这个活物默认的Domain。</li>
<li>对DT来说，class一定回事process。</li>
</ul>
<p>DT属于Labeling的一部分，打标签也需要相关权限。要真正实施成功这个 DT，还需要下边至少3个allow语句配合：<br>【例7-2】</p>
<pre><code><span class="preprocessor">#首先，你得让 init_t 域中 的进程 能够执行 type为apache_exec_t的文件</span>
allow <span class="keyword">init_t</span> <span class="keyword">apache_exec_t</span> : file execute;
<span class="preprocessor">#然后，告诉SELinux，允许 init_t 做DT切换 以 进入 apache_t域</span>
allow <span class="keyword">init_t</span> <span class="keyword">apache_t</span> : process transition;
<span class="preprocessor">#最后，告诉SELinux，切换入口（对应为entrypoint权限）为执行 apache_exec_t 类型的文件</span>
allow <span class="keyword">apache_t</span> <span class="keyword">apache_exec_t</span> : file entrypoint;
</code></pre><h3 id="为什么需要上述3个权限？">为什么需要上述3个权限？</h3><p>Kernel中，从fork到execv一共设置了3处Security检查点，所以需要3个权限。</p>
<p>SELinux支持宏，可以定义 一个宏语句，包含上述4个步骤。<br>SEAndroid中，系统定义的宏全在 external/sepolicy/te_macros中</p>
<pre><code><span class="comment">#####################################</span>
<span class="comment"># domain_trans(olddomain, type, newdomain)</span>
<span class="comment"># Allow a transition from olddomain to newdomain</span>
<span class="comment"># upon executing a file labeled with type.</span>
<span class="comment"># This only allows the transition; it does not</span>
<span class="comment"># cause it to occur automatically - use domain_auto_trans</span>
<span class="comment"># if that is what you want.</span>
<span class="comment">#定义 domain_trans宏，$1 $2等 代表宏的第1个，第2个……参数</span>
define(`domain_trans', `
<span class="comment"># Old domain may exec the file and transition to the new domain.</span>
<span class="comment">#SEAndroid在上述 3个最小权限上，添加了自己的一些权限</span>
allow <span class="variable">$1</span> <span class="variable">$2</span>:file { getattr <span class="literal">open</span> read execute }<span class="comment">;</span>
allow <span class="variable">$1</span> <span class="variable">$3</span>:process transition<span class="comment">;</span>
<span class="comment"># New domain is entered by executing the file.</span>
allow <span class="variable">$3</span> <span class="variable">$2</span>:file { entrypoint <span class="literal">open</span> read execute getattr }<span class="comment">;</span>
<span class="comment"># New domain can send SIGCHLD to its caller.</span>
allow <span class="variable">$3</span> <span class="variable">$1</span>:process sigchld<span class="comment">;</span>
<span class="comment"># Enable AT_SECURE, i.e. libc secure mode.</span>
dontaudit <span class="variable">$1</span> <span class="variable">$3</span>:process noatsecure<span class="comment">;</span>
<span class="comment"># XXX dontaudit candidate but requires further study.</span>
allow <span class="variable">$1</span> <span class="variable">$3</span>:process { siginh rlimitinh }<span class="comment">;</span>
')

<span class="comment">#####################################</span>
<span class="comment"># domain_auto_trans(olddomain, type, newdomain)</span>
<span class="comment"># Automatically transition from olddomain to newdomain</span>
<span class="comment"># upon executing a file labeled with type.</span>
<span class="comment"># 例7中，该宏的用法是：domain_auto_trans(init_t, apache_exec_t, apache_t)</span>
define(`domain_auto_trans', `
<span class="comment"># Allow the necessary permissions. allow相关权限</span>
domain_trans(<span class="variable">$1</span>,<span class="variable">$2</span>,<span class="variable">$3</span>)
<span class="comment"># Make the transition occur by default.设置type_transition</span>
type_transition <span class="variable">$1</span> <span class="variable">$2</span>:process <span class="variable">$3</span><span class="comment">;</span>
')
</code></pre><p>external/sepolicy/init.te中有上述宏的用法:  </p>
<pre><code><span class="function"><span class="title">domain_auto_trans</span><span class="params">(init, logcat_exec, logd)</span></span>
</code></pre><h3 id="针对死的东西打标签">针对死的东西打标签</h3><p>除了DT外，还有 针对Type的Transition。<br>假设目录A的SContext为 u:r:dir_a，默认情况下 该目录下 创建的文件 都具有 u:r:dir_a这个SContext。所以也要 针对 死的东西 打标签。</p>
<p>TT语句也是type_transition。要顺利完成Transition，也要申请权限。直接看 external/sepolicy/te_macros 中 TT所需要的宏的定义：</p>
<pre><code><span class="comment">#####################################</span>
<span class="comment"># file_type_trans(domain, dir_type, file_type)</span>
<span class="comment"># Allow domain to create a file labeled file_type in a</span>
<span class="comment"># directory labeled dir_type.</span>
<span class="comment"># This only allows the transition; it does not</span>
<span class="comment"># cause it to occur automatically - use file_type_auto_trans</span>
<span class="comment"># if that is what you want.</span>
<span class="comment">#</span>
define(`file_type_trans', `
<span class="comment"># Allow the domain to add entries to the directory.ra_dir_perms是一个宏，在global_macros中定义</span>
allow <span class="variable">$1</span> <span class="variable">$2</span>:dir ra_dir_perms<span class="comment">;</span>
<span class="comment"># Allow the domain to create the file.create_file_perms也是一个宏，在global_macros中定义</span>
allow <span class="variable">$1</span> <span class="variable">$3</span>:notdevfile_class_set create_file_perms<span class="comment">;</span>
allow <span class="variable">$1</span> <span class="variable">$3</span>:dir create_dir_perms<span class="comment">;</span>
')


<span class="comment">#####################################</span>
<span class="comment"># file_type_auto_trans(domain, dir_type, file_type)</span>
<span class="comment"># Automatically label new files with file_type when</span>
<span class="comment"># they are created by domain in directories labeled dir_type.</span>
<span class="comment">#该宏的含义是：当domain域中的 进程 在某个 type为 dir_type的目录中 创建文件时，该文件的 SContext应该是 file_type</span>
define(`file_type_auto_trans', `
<span class="comment"># Allow the necessary permissions.</span>
file_type_trans(<span class="variable">$1</span>, <span class="variable">$2</span>, <span class="variable">$3</span>)
<span class="comment"># Make the transition occur by default.notdevfile_class_set是一个宏</span>
type_transition <span class="variable">$1</span> <span class="variable">$2</span>:dir <span class="variable">$3</span><span class="comment">;</span>
type_transition <span class="variable">$1</span> <span class="variable">$2</span>:notdevfile_class_set <span class="variable">$3</span><span class="comment">;</span>
')
</code></pre><p>ra_dir_perms是一个宏，在external/sepolicy/global_macros 中定义</p>
<pre><code><span class="keyword">define</span>(`<span class="title">ra_dir_perms</span><span class="string">', `{ r_dir_perms add_name write }'</span>)

<span class="keyword">define</span>(`<span class="title">create_file_perms</span><span class="string">', `{ create rename setattr unlink rw_file_perms }'</span>)

<span class="keyword">define</span>(`<span class="title">r_dir_perms</span><span class="string">', `{ open getattr read search ioctl }'</span>)

<span class="keyword">define</span>(`<span class="title">rw_dir_perms</span><span class="string">', `{ r_dir_perms w_dir_perms }'</span>)

<span class="keyword">define</span>(`<span class="title">create_dir_perms</span><span class="string">', `{ create reparent rename rmdir setattr rw_dir_perms }'</span>)

<span class="keyword">define</span>(`<span class="title">notdevfile_class_set</span><span class="string">', `{ file lnk_file sock_file fifo_file }'</span>)
</code></pre><p>【例8】官方文档最小声明：<br><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/e2be936bad7d53915341f56c83d191d6b4ccf643/20160119/tt%E6%9C%80%E5%B0%8F%E5%A3%B0%E6%98%8E.PNG" alt="tt最小声明"></p>
<h2 id="2-2-3_File/File_System_打_label">2.2.3 File/File System 打 label</h2><p>前面都是Transition，即从一种Type或domain 进入 另一种 type或domain。<br>最初的type是怎么来的呢？<br>SELinux中，与file相关的死东西 还有一些特殊的语句</p>
<p>external/sepolicy/file_contexts中</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/b0082f9adf058d360bd6a57dac96198a5289e736/20160119/file_context.PNG" alt="file_contexts"></p>
<p>1.external/sepolicy/fs_use，fs表示file system，fs_use描述了SELinux的labeling信息 在不同文件系统时 的处理方式</p>
<pre><code>#对于常规的文件系统，<span class="tag">SContext</span>信息 存储在 文件结点（<span class="tag">inode</span>）的属性中，系统可通过 <span class="tag">getattr</span>函数 读取<span class="tag">inode</span>中的 <span class="tag">SContext</span>信息。
#对于<span class="tag">labeling</span>方式，<span class="tag">SELinux</span>定义了<span class="tag">fs_use_xattr</span> 关键词。这种<span class="tag">SContext</span> 永久性的保存在文件系统中。
# <span class="tag">Label</span> <span class="tag">inodes</span> <span class="tag">via</span> <span class="tag">getxattr</span>.
<span class="tag">fs_use_xattr</span> <span class="tag">yaffs2</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:labeledfs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_xattr</span> <span class="tag">jffs2</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:labeledfs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_xattr</span> <span class="tag">ext2</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:labeledfs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_xattr</span> <span class="tag">ext3</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:labeledfs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_xattr</span> <span class="tag">ext4</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:labeledfs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_xattr</span> <span class="tag">xfs</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:labeledfs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_xattr</span> <span class="tag">btrfs</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:labeledfs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_xattr</span> <span class="tag">f2fs</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:labeledfs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_xattr</span> <span class="tag">squashfs</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:labeledfs</span><span class="pseudo">:s0</span>;

#对于虚拟文件系统，即<span class="tag">Linux</span>系统运行过程中创建的<span class="tag">VFS</span>，则使用<span class="tag">fs_use_task</span>关键字描述。
#目前仅有<span class="tag">pipefs</span> <span class="tag">sockfs</span>两种<span class="tag">VFS</span>格式
# <span class="tag">Label</span> <span class="tag">inodes</span> <span class="tag">from</span> <span class="tag">task</span> <span class="tag">label</span>.
<span class="tag">fs_use_task</span> <span class="tag">pipefs</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:pipefs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_task</span> <span class="tag">sockfs</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:sockfs</span><span class="pseudo">:s0</span>;

<span class="id">#fs_use_trans</span>也是针对 <span class="tag">Virtual</span> <span class="tag">File</span> <span class="tag">System</span>的，这些<span class="tag">VFS</span>是针对<span class="tag">pseudo</span> <span class="tag">terminal</span>和临时对象的。具体<span class="tag">labeling</span>时，会根据 <span class="tag">fs_use_trans</span> 以及 <span class="tag">TT</span>规则来 决定 最终的<span class="tag">SContext</span>。
# <span class="tag">Label</span> <span class="tag">inodes</span> <span class="tag">from</span> <span class="tag">combination</span> <span class="tag">of</span> <span class="tag">task</span> <span class="tag">label</span> <span class="tag">and</span> <span class="tag">fs</span> <span class="tag">label</span>.
# <span class="tag">Define</span> <span class="tag">type_transition</span> <span class="tag">rules</span> <span class="tag">if</span> <span class="tag">you</span> <span class="tag">want</span> <span class="tag">per-domain</span> <span class="tag">types</span>.
<span class="tag">fs_use_trans</span> <span class="tag">devpts</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:devpts</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_trans</span> <span class="tag">tmpfs</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:tmpfs</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_trans</span> <span class="tag">devtmpfs</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:device</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_trans</span> <span class="tag">shm</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:shm</span><span class="pseudo">:s0</span>;
<span class="tag">fs_use_trans</span> <span class="tag">mqueue</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:mqueue</span><span class="pseudo">:s0</span>;
</code></pre><p>以下边例子为例：</p>
<pre><code><span class="tag">fs_use_trans</span> <span class="tag">devpts</span> <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:devpts</span><span class="pseudo">:s0</span>;
# 假设还有一条<span class="tag">TT</span>语句：
<span class="tag">type_transition</span> <span class="tag">sysadm_t</span> <span class="tag">devpts</span> : <span class="tag">chr_file</span> <span class="tag">sysadm_devpts_t</span><span class="pseudo">:s0</span>;
#该语句表示： 当 <span class="tag">sysadm_t</span>的进程 在<span class="tag">type</span>为<span class="tag">devpts</span>下 创建一个<span class="tag">chr_file</span>时，其<span class="tag">SContext</span>是 <span class="tag">sysadm_devpts_t</span><span class="pseudo">:s0</span>。
#如果没有<span class="tag">TT</span>语句，<span class="tag">SContext</span>是 <span class="tag">u</span><span class="pseudo">:object_r</span><span class="pseudo">:devpts</span><span class="pseudo">:s0</span>
#这里的对象不是目录，是<span class="tag">FileSystem</span>
</code></pre><p>2.external/sepolicy/genfs_contexts中，gen是generalized的意思，用于fs_use_xattr,fs_use_task,fs_use_trans之外的情况，用genfscon来打labeling，一般是 /目录，proc目录，sysfs等。</p>
<pre><code><span class="comment"># Label inodes with the fs label.</span>
genfscon rootfs / u:object_r:rootfs:s0
<span class="comment"># proc labeling can be further refined (longest matching prefix).</span>
genfscon <span class="keyword">proc</span> / u:object_r:<span class="keyword">proc</span>:s0
genfscon <span class="keyword">proc</span> /net u:object_r:proc_net:s0
genfscon <span class="keyword">proc</span> /net/xt_qtaguid/ctrl u:object_r:qtaguid_proc:s0
</code></pre><h2 id="2-2-4_给_网络数据包/端口_打标签">2.2.4 给 网络数据包/端口 打标签</h2><p>涉及iptables相关工作，SEAndroid中，暂时 没放开 网络数据包 打标签的功能。<br>给端口打标签，由portcon关键词完成。</p>
<h2 id="2-3_Security_Level_和_MLS">2.3 Security Level 和 MLS</h2><h2 id="2-3-1_Security_Level">2.3.1 Security Level</h2><p>TE，RBAC是 “平等社会”下的权限管理，新增了 多等级安全管理：Multi-LevelSecurity 多等级安全。<br>多等级安全信息 也被 添加到 SContext中，可以控制SELinux 启用MLS 或 不启用MLS。</p>
<p>完整的SContext：</p>
<ul>
<li>MLS未启用：user_u:role_r:type_t</li>
<li>MLS启用后，user:role:type:sensitivity[:category,…]-sensitivity[:category,…]</li>
</ul>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/3e3f3170b4570b4c2c9fbab5e29acf691eceb9bf/20160119/security-level.PNG" alt="Security-Level"><br>组成：</p>
<ul>
<li>low security level:当前SContext所对应的（死的或活的）东西 的当前（也就是最小）安全级别</li>
<li>连字符 - ：表示 range</li>
<li>high security level：当前SContext所对应的 （死的或活的）东西 的最高安全级别</li>
</ul>
<p>【例9】sensitivity关键字<br><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/8d52d2c68a0dca9a943ae12e05e3d38919b26c04/20160119/sensitivity.PNG" alt="sensivity"></p>
<p>【例10】category关键字<br><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/309f3de883ff367329825abdb32a1180dd2ade04/20160119/category.PNG" alt="category"></p>
<p>SEAndroid中：</p>
<ul>
<li>sensitivity 只定义了s0</li>
<li>category 定义了从c0 到 c1023，共 1024个category</li>
</ul>
<p>sensitivity 和 category 一起组成了一个 Security Level（SLevel），SLevel由关键字level声明，如下例所示：</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/3be725998fa6a4ce11936463ecb456b425af19f9/20160119/level.PNG" alt="level"></p>
<p>SL1 和 SL2 之间的关系有：</p>
<ul>
<li><p>dom：如果 SL1 dom SL2的话，则 SL1 的sensitivity &gt;= SL2的sensitivity，SL1的category 包含 SL2的category。例    </p>
<p>  SL1=”s2:c0.c5” dom SL2=”s0:c2,c3”</p>
</li>
<li><p>domby: 和dom相反</p>
</li>
<li>eq：sensitivity相等，category相同。</li>
<li>incomp：不可比。sensitivity不可比，category不可比。</li>
</ul>
<hr>
<pre><code><span class="tag">user</span><span class="pseudo">:role</span><span class="pseudo">:type</span><span class="pseudo">:sensitivity</span><span class="attr_selector">[:category,...]</span><span class="tag">-</span> <span class="tag">sensitivity</span><span class="attr_selector">[:category,...]</span>
<span class="id">#Android</span>中，<span class="tag">SContext</span>有：<span class="tag">u</span><span class="pseudo">:r</span><span class="pseudo">:init</span><span class="pseudo">:s0</span> ，在这种<span class="tag">case</span>中，<span class="tag">Low</span> <span class="tag">Level</span>等于<span class="tag">High</span> <span class="tag">Level</span>，而且<span class="tag">SLevel</span>没有包含<span class="tag">Category</span>
</code></pre><p>SLevel如何在MAC中起作用。和constrain类似，MLS添加了mlsconstrain关键字</p>
<h2 id="2-3-2_mlsconstrain_和_no_read_down/write_up">2.3.2 mlsconstrain 和 no read down/write up</h2><p>mlsconstrain 语法和constrain一样：</p>
<pre><code>mlsconstrain <span class="class"><span class="keyword">class</span> <span class="title">perm_set</span> <span class="title">expression</span>;</span>
</code></pre><p>与constrain不同的是，expression除了u1 , u2, r1, r2, t1, t2外，还新增了：</p>
<ul>
<li>l1, l2: l1表示 源的low sensitivity level，l2表示target的low sensitivity</li>
<li>h1, h2: h1表示 源的high sensitivity level，h2表示target的 high sensitivity</li>
<li>l 和 h 的关系：包括： dom，domby，eq 和 incomp</li>
</ul>
<p>mlsconstrain是一个policy语法，如何利用它来 体现 多层安全管理呢？</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/c9d21c32a1f21d6e9a23d0d567bee00b8574252d/20160119/MLS%E4%BD%9C%E7%94%A8.PNG" alt="MLS的作用"></p>
<p>MLS在安全策略上 形象的描述叫 no write down 和 no read up:</p>
<ul>
<li>高级别的东西 不能 往低级别的东西里 写数据：这样可能导致 高级别的数据 泄露到 低级别中</li>
<li>高级别的东西 只能 从低级别的东西里 读数据。</li>
</ul>
<p>反过来说：</p>
<ul>
<li>低级别的东西 只能 往高级别的东西里 写数据</li>
<li>低级别的东西 不能 从高级别的东西里 读数据</li>
</ul>
<h2 id="2-3-3_MLS_in_Android">2.3.3 MLS in Android</h2><ul>
<li>首先，系统中只有一个sensitivity level，即s0；</li>
<li>系统中有1024个category，从c0到c1023.</li>
</ul>
<p>external/sepolicy/mls:</p>
<pre><code><span class="preprocessor">#########################################</span>
<span class="preprocessor"># MLS declarations</span>
<span class="preprocessor">#</span>
<span class="preprocessor">#定义了2个和mls相关的宏，位于 mls_macro文件中</span>
<span class="preprocessor"># Generate the desired number of sensitivities and categories.</span>
gen_sens(mls_num_sens) # mls_num_sens=<span class="number">1</span>
gen_cats(mls_num_cats) # mls_num_cats=<span class="number">1024</span>

<span class="preprocessor">#下边的宏生成SLevel</span>
<span class="preprocessor"># Generate level definitions for each sensitivity and category.</span>
gen_levels(mls_num_sens,mls_num_cats)
</code></pre><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/2475497bdc7bb52ab8bf7678283152f445a614be/20160119/policy.conf.PNG" alt="policy.conf"></p>
<p>mlsconstrain例子：</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/ade02c3e753911045fd89dea3c8b69bb05470a18/20160119/mlsconstrain%E4%BE%8B%E5%AD%90.PNG" alt="mlsconstrain例子"></p>
<h2 id="2-4_编译安全策略文件">2.4 编译安全策略文件</h2><p>Android中策略文件在external/sepolicy下</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/a67c7ec67e002da0cd5d723ca6da1bfeb8767760/20160119/SElinux%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90.PNG" alt="SELinux安全配置文件生成"></p>
<ul>
<li>左边一列 是 安全配置的源文件。即external/sepolicy下的te，initial_sid, initial_sid_contexts,access_vectors,fs_use , genfs_contexts等。我们要改的一半是te文件，其他文件 由于和 Kernel内部的 LSM等模块相关，很难有机会改。</li>
<li>这些文件都是文本文件，会被组合到一起。</li>
<li>搞到一起后 的文件中 使用宏的地方，要用m4命令对这些宏进行扩展。<br>如：m4 -D mls_num_sens=1 -D mls_num_cats=1024<br>m4处理后 得到 policy.conf。是所有 安全策略 源文件 的集合，宏也被替换。</li>
<li>policy.conf文件 最终被 checkpolicy 命令处理。该命令检查 neverallow 是否被违背，语法是否正确等。最后， checkpolicy 将 policy.conf 打包生成一个二进制文件。在SEAndroid中，该文件叫sepolicy，在Linux发行版本上，一般叫 policy.26等，26表示SELinux的版本号</li>
<li>最后，再把sepolicy文件 传递到 Kernel LSM中，整个安全策略配置就算完成。</li>
</ul>
<h2 id="2-5_拓展讨论">2.5 拓展讨论</h2><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/7f7bf3ddb95208b2d4952acd72916430afa92ee1/20160119/SElinux%20Component.PNG" alt="SELinux Component组成"></p>
<ul>
<li>Subject：代表发起操作的对象，一般试process。SELinux需要检查subject是否满足 权限要求</li>
<li>Object Manager：管理着 Object 及 相应的SContext。OM向Access Vector Cache查询所要求的操作是否有权限。</li>
<li>AVC：起加速作用，将缓存一些权限检查的结果。当相同的 权限检查请求 过来时，直接从AVC中 返回所缓存的结果。</li>
<li>如果AVC没有这条权限检查结果，它将向Security Server去查询。SS内部 保存有SePolicy，它可以根据SePolicy计算出权限检查的结果。</li>
</ul>
<h1 id="二、SEAndroid源码分析">二、SEAndroid源码分析</h1><p>1.初始化SEAndroid，在init的main函数中<br>system/core/init/init.cpp:</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>{
……
    <span class="comment">// Set up SELinux, including loading the SELinux policy if we're in the kernel domain.</span>
    selinux_initialize(is_first_stage);<span class="comment">//①初始化SEAndroid</span>

    <span class="comment">// If we're in the kernel domain, re-exec init to transition to the init domain now</span>
    <span class="comment">// that the SELinux policy has been loaded.</span>
    <span class="keyword">if</span> (is_first_stage) {
        <span class="keyword">if</span> (restorecon(<span class="string">"/init"</span>) == -<span class="number">1</span>) {
            ERROR(<span class="string">"restorecon failed: %s\n"</span>, strerror(errno));
            security_failure();
        }
        <span class="keyword">char</span>* path = argv[<span class="number">0</span>];
        <span class="keyword">char</span>* args[] = { path, <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="string">"--second-stage"</span>), <span class="literal">nullptr</span> };
        <span class="keyword">if</span> (execv(path, args) == -<span class="number">1</span>) {
            ERROR(<span class="string">"execv(\"%s\") failed: %s\n"</span>, path, strerror(errno));
            security_failure();
        }
    }

    <span class="comment">//②给下边几个目录打标签，restorecon 全称是 restore context;就是 根据file_contexts中的内容给一堆目录打标签</span>
    <span class="comment">// These directories were necessarily created before initial policy load</span>
    <span class="comment">// and therefore need their security context restored to the proper value.</span>
    <span class="comment">// This must happen before /dev is populated by ueventd.</span>
    INFO(<span class="string">"Running restorecon...\n"</span>);
    restorecon(<span class="string">"/dev"</span>);
    restorecon(<span class="string">"/dev/socket"</span>);
    restorecon(<span class="string">"/dev/__properties__"</span>);
    restorecon_recursive(<span class="string">"/sys"</span>);

    ……
}
</code></pre><p>1.1. selinux_initialize<br>system/core/init/init.cpp:</p>
<pre><code>static <span class="keyword">void</span> selinux<span class="number">_</span>initialize(bool <span class="keyword">in</span><span class="number">_k</span>ernel<span class="number">_</span>domain) {
    Timer t;

    selinux<span class="number">_</span>callback cb;
    cb.func<span class="number">_</span>log = selinux<span class="number">_k</span>log<span class="number">_</span>callback;
    selinux<span class="number">_</span>set<span class="number">_</span>callback(SELINUX<span class="number">_</span>CB<span class="number">_</span>LOG, cb);<span class="comment">//selinux_set_callback有libselinux提供</span>
    cb.func<span class="number">_</span>audit = audit<span class="number">_</span>callback;
    selinux<span class="number">_</span>set<span class="number">_</span>callback(SELINUX<span class="number">_</span>CB<span class="number">_</span>AUDIT, cb);

    <span class="comment">//①判断SELinux是否启用.方法是：</span>
    <span class="comment">//方式一： /sys/fs/selinux是否存在</span>
    <span class="comment">//方式二：ro.boot.selinux属性不为disable</span>
    <span class="keyword">if</span> (selinux<span class="number">_</span><span class="keyword">is</span><span class="number">_</span>disabled()) {
        <span class="keyword">return</span>;
    }

    <span class="keyword">if</span> (<span class="keyword">in</span><span class="number">_k</span>ernel<span class="number">_</span>domain) {
        <span class="comment">//②加载sepolicy文件</span>
        INFO(<span class="string">"Loading SELinux policy...\n"</span>);
        <span class="keyword">if</span> (selinux<span class="number">_</span>android<span class="number">_</span>load<span class="number">_p</span>olicy() &lt; <span class="number">0</span>) {
            ERROR(<span class="string">"failed to load policy: %s\n"</span>, strerror(errno));
            security<span class="number">_f</span>ailure();
        }

        <span class="comment">//SELinux有2种工作模式：</span>
        <span class="comment">//"permissive"：所有操作都被允许（即没有MAC），但是如果有 违反权限的话，会记录日志</span>
        <span class="comment">//"enforcing"：所有操作都会进行 权限检查</span>
        bool <span class="keyword">is</span><span class="number">_</span>enforcing = selinux<span class="number">_</span><span class="keyword">is</span><span class="number">_</span>enforcing();
        security<span class="number">_</span>setenforce(<span class="keyword">is</span><span class="number">_</span>enforcing);<span class="comment">//③设置SELinux的模式</span>

        <span class="keyword">if</span> (write<span class="number">_f</span>ile(<span class="string">"/sys/fs/selinux/checkreqprot"</span>, <span class="string">"0"</span>) == -<span class="number">1</span>) {
            security<span class="number">_f</span>ailure();
        }

        NOTICE(<span class="string">"(Initializing SELinux %s took %.2fs.)\n"</span>,
               <span class="keyword">is</span><span class="number">_</span>enforcing ? <span class="string">"enforcing"</span> : <span class="string">"non-enforcing"</span>, t.duration());
    } <span class="keyword">else</span> {
        selinux<span class="number">_</span>init<span class="number">_</span>all<span class="number">_</span>handles();<span class="comment">//④初始化 file_context, seapp_context 及 property_context相关内容</span>
    }
}
</code></pre><p>1.1.1 selinux_is_disabled<br>system/core/init/init.cpp:</p>
<pre><code><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">selinux_is_disabled</span><span class="params">(<span class="keyword">void</span>)</span>
</span>{
    <span class="keyword">if</span> (ALLOW_DISABLE_SELINUX) {
        <span class="keyword">if</span> (access(<span class="string">"/sys/fs/selinux"</span>, F_OK) != <span class="number">0</span>) {
            <span class="comment">// SELinux is not compiled into the kernel, or has been disabled</span>
            <span class="comment">// via the kernel command line "selinux=0".</span>
            <span class="keyword">return</span> <span class="literal">true</span>;
        }
        <span class="keyword">return</span> selinux_status_from_cmdline() == SELINUX_DISABLED;
    }

    <span class="keyword">return</span> <span class="literal">false</span>;
}
</code></pre><p>1.1.2 selinux_android_load_policy<br>external/libselinux/src/android.c:</p>
<pre><code><span class="xml">int selinux_android_load_policy(void)
</span><span class="expression">{
        <span class="variable">const</span> <span class="variable">char</span> *<span class="variable">mnt</span> = <span class="variable">SELINUXMNT</span>;/<span class="end-block">/ </span>值为<span class="end-block">/sys</span><span class="end-block">/fs</span><span class="end-block">/selinux</span>
        <span class="variable">int</span> <span class="variable">rc</span>;
        /<span class="end-block">/ </span>挂载 <span class="end-block">/sys</span><span class="end-block">/fs</span><span class="end-block">/selinux</span>，<span class="variable">SELINUXFS</span>值为<span class="string">"selinuxfs"</span>
        <span class="variable">rc</span> = <span class="variable">mount</span>(<span class="variable">SELINUXFS</span>, <span class="variable">mnt</span>, <span class="variable">SELINUXFS</span>, 0, <span class="variable">NULL</span>);
        ……
        /<span class="end-block">/ </span><span class="end-block">/sys</span><span class="end-block">/fs</span><span class="end-block">/selinux</span>是<span class="variable">userpace</span> 和 <span class="variable">kernel</span> 中的<span class="variable">SELinux</span>模块交互的通道
        <span class="variable">set</span>_<span class="variable">selinuxmnt</span>(<span class="variable">mnt</span>);该方法在<span class="variable">external</span><span class="end-block">/libselinux</span><span class="end-block">/include</span><span class="end-block">/selinux</span><span class="end-block">/selinux.h</span>中，属于<span class="variable">libselinux</span> <span class="variable">API</span>

    <span class="variable">return</span> <span class="variable">selinux</span>_<span class="variable">android</span>_<span class="variable">load</span>_<span class="variable">policy</span>_<span class="variable">helper</span>(<span class="variable">false</span>);//加载<span class="variable">SEAndroid</span>中的<span class="variable">policy</span>文件
}</span><span class="xml"></span>
</code></pre><p><img src="" alt="Nexus7上 /sys/fs/selinux 的内容"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/19/SELinux/" data-id="cisvpt2s000100ko0trvsz72x" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SELinux/">SELinux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据结构5-树-下-5-1-堆" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/10/数据结构5-树-下-5-1-堆/" class="article-date">
  <time datetime="2015-12-10T02:16:23.000Z" itemprop="datePublished">2015-12-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/10/数据结构5-树-下-5-1-堆/">数据结构5-树-下-5-1-堆</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="5-1_堆">5.1 堆</h1><h2 id="5-1-1_什么是堆">5.1.1 什么是堆</h2><p><strong> 优先队列： </strong> 特殊的 队列，取出元素的顺序是 按照元素的 优先权（关键字）大小，而不是 元素 进入队列的 先后顺序。</p>
<h3 id="数组_或_链表_实现优先队列：">数组 或 链表 实现优先队列：</h3><ul>
<li><p>数组：</p>
<ul>
<li>插入——元素总是插入 尾部 O(1)</li>
<li>删除——查找最大（或最小）关键字 O(n);  从数组中 删去需要移动的元素 O(n)</li>
</ul>
</li>
<li><p>链表：</p>
<ul>
<li>插入——元素 总是 插入 链表的 头部 O(1)</li>
<li>删除——查找最大（或最小）关键字 O(n);  删去结点 O(1)</li>
</ul>
</li>
<li><p>有序数组：</p>
<ul>
<li>插入——找到合适的位置 O(n)或O(log2 n);  移动元素并插入 O(n)</li>
<li>删除——删去最后一个元素 O(1)</li>
</ul>
</li>
<li><p>有序链表：</p>
<ul>
<li>插入——找到合适的位置 O(n);  插入元素 O(1)</li>
<li>删除——删除首元素或最后元素 O(1)</li>
</ul>
</li>
</ul>
<h3 id="是否可以采用二叉树？">是否可以采用二叉树？</h3><ul>
<li>二叉搜索树？</li>
<li>如果采用二叉树结构，应更关注 插入 还是删除？<ul>
<li>树 结点 顺序 怎么安排？</li>
<li>树 结构怎样？</li>
</ul>
</li>
</ul>
<h3 id="优先队列的完全二叉树表示">优先队列的完全二叉树表示</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/ef686e50ef7e9635c463b4aed18bea985396c90b/201512/%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%8C%E5%85%A8%E4%BA%8C%E5%8F%89%E6%A0%91%E8%A1%A8%E7%A4%BA.PNG" alt="优先队列的完全二叉树表示"></p>
<h3 id="堆_举例">堆 举例</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/9227578ca1777cee63ce761053bd11dc224c78ee/201512/%E5%A0%86%E4%B8%BE%E4%BE%8B.PNG" alt="堆 举例"></p>
<h3 id="堆的抽象数据类型描述">堆的抽象数据类型描述</h3><ul>
<li>类型名称：最大堆(MaxHeap)</li>
<li>数据对象集：完全二叉树，每个结点的元素值 不小于 其 子结点的元素值</li>
<li>操作集：最大堆H ∈ MaxHeap，元素 item ∈ ElementType，主要操作：<ul>
<li>MaxHeap Create(int MaxSize):创建一个空的最大堆</li>
<li>Boolean IsFull(MaxHeap H): 判断最大堆H是否已满</li>
<li>Insert(MaxHeap H, ElementType item): 将元素item插入最大堆H</li>
<li>Boolean IsEmpty(MaxHeap H): 判断最大堆H是否为空</li>
<li>ElementType DeleteMax(MaxHeap H): 返回H中的最大元素（高优先级）</li>
</ul>
</li>
</ul>
<h2 id="5-1-2_最大堆的操作">5.1.2 最大堆的操作</h2><h3 id="最大堆的创建：">最大堆的创建：</h3><pre><code><span class="keyword">typedef</span> <span class="keyword">struct</span> HeapStruct *MaxHeap;
<span class="keyword">struct</span> HeapStruct{
    ElementType *Elements;<span class="comment">//存储堆元素的数组</span>
    <span class="keyword">int</span> Size;<span class="comment">//堆的当前元素个数</span>
    <span class="keyword">int</span> Capacity;<span class="comment">// 堆的最大容量</span>
}
</code></pre><p>创建最大堆</p>
<pre><code><span class="function">MaxHeap <span class="title">Create</span><span class="params">(<span class="keyword">int</span> MaxSize)</span></span>{
    <span class="comment">//创建容量为MaxSize的空的最大堆</span>
    MaxHeap H = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> HeapStruct));
    H-&gt;Elements = <span class="built_in">malloc</span>((MaxSize + <span class="number">1</span>)) * <span class="keyword">sizeof</span>(ElementType));
    H-&gt;Size = <span class="number">0</span>;
    H-&gt;Capacity = MaxSize;
    H-&gt;Element[<span class="number">0</span>] = MaxData;
    <span class="comment">//定义哨兵，为大于 堆中 所有可能元素的值，便于 以后更快操作</span>
    <span class="keyword">return</span> H;
}
</code></pre><h3 id="最大堆的插入">最大堆的插入</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/71aaedede9fcfae256d87663689ecf5d3eaa294a/201512/%E6%9C%80%E5%A4%A7%E5%A0%86%E7%9A%84%E6%8F%92%E5%85%A5.PNG" alt="最大堆的插入"></p>
<p>在[6]处插入<br>插入20，没有破坏有序性，可以插入<br>插入35，35&gt;31，破坏了有序性，35与31换位置<br>插入58,58&gt;31，58与31换位置，58&gt;44，58与44换位置</p>
<p>算法：将新增结点 插入到 从其父结点 到 根结点的 有序序列中</p>
<pre><code><span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(MaxHeap H, ElementType item)</span></span>{
    <span class="comment">//将元素item插入最大堆H，其中H-&gt;Elements[0]已经定义为哨兵</span>
    <span class="keyword">int</span> i;
    <span class="keyword">if</span>(IsFull(H)){
        <span class="built_in">printf</span>(<span class="string">"最大堆已满"</span>);
        <span class="keyword">return</span>;
    }
    i = ++H-&gt;Size;<span class="comment">//i指向 插入后 堆中的 最后一个元素的位置</span>
    <span class="keyword">for</span>(; H-&gt;Elements[i/<span class="number">2</span>] &lt; item; i/=<span class="number">2</span>){
        <span class="comment">//Elements[i/2]是父结点</span>
        H-&gt;Elements[i] = H-&gt;Elements[i/<span class="number">2</span>];<span class="comment">//向下过滤结点</span>
    }
    H-&gt;Elements[i] = item;<span class="comment">//将item插入</span>
}
</code></pre><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/1728b9a68b00f467b395906f89d96f443955f59a/201512/%E5%A0%86%E6%8F%92%E5%85%A5%E4%B8%BE%E4%BE%8B.PNG" alt="堆插入举例"></p>
<p>将25插入，25先跟父结点6比较，25&gt;6，将i/2，<br>25与8比较，25&gt;8 ，将i/2，继续比较……<br>当比较20与25时，25&gt;20，哨兵中存的是最大值，堆元素不能超出哨兵，到i=1,就停止了</p>
<h2 id="5-1-3_最大堆的删除">5.1.3 最大堆的删除</h2><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/35794805f62ace44ad2c126f74643d2c63929045/201512/%E6%9C%80%E5%A4%A7%E5%A0%86%E5%88%A0%E9%99%A4.PNG" alt="最大堆删除-删除58"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/10/数据结构5-树-下-5-1-堆/" data-id="cisvpt2qx00010ko0kx9qifad" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据结构/">数据结构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据结构4-树-中-——4-2-平衡二叉树" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/08/数据结构4-树-中-——4-2-平衡二叉树/" class="article-date">
  <time datetime="2015-12-08T04:58:19.000Z" itemprop="datePublished">2015-12-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/08/数据结构4-树-中-——4-2-平衡二叉树/">数据结构4-树-中-——4-2-平衡二叉树</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="4-2_平衡二叉树">4.2 平衡二叉树</h1><h2 id="4-2-1_什么是_平衡二叉树">4.2.1 什么是 平衡二叉树</h2><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/d9e64a25272b5300d4bbe5c220f81a2242249fd4/201512/%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91.PNG" alt="什么是平衡二叉树"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/7e7883fa6ed043014c71a93eab183bb30d5a50ac/201512/%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%912.PNG" alt="平衡二叉树定义"></p>
<p>第一个例子：对于 3 ，左子树高度是2，没有右子树。不是平衡二叉树<br>第三个例子：对于 7 ，左子树高度是3，右子树高度是1，不是平衡二叉树</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/8791a7ace4647df28afcc83f091b1e06b56548f5/201512/%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91%E9%AB%98%E5%BA%A6.PNG" alt="平衡二叉树高度"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/ab3ebdc83a3a1dfc1358d069487da05707f010a9/201512/%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91%E9%AB%98%E5%BA%A62.PNG" alt="平衡二叉树高度规律"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/2562f5fb5f6ef69361c4bc9ef61de64d33f289da/201512/%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91%E9%AB%98%E5%BA%A6%E4%B8%8E%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E5%BA%8F%E5%88%97.PNG" alt="平衡二叉树高度与斐波那契序列"></p>
<h2 id="4-2-2_平衡二叉树的调整">4.2.2 平衡二叉树的调整</h2><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/b4a563378b0caa0157646c697beaeb3fc163ef1c/201512/%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E8%B0%83%E6%95%B4.PNG" alt="平衡二叉树的调整"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/b4a563378b0caa0157646c697beaeb3fc163ef1c/201512/RR%E6%97%8B%E8%BD%AC.PNG" alt="RR旋转：插入15"><br>5是 破坏者，15是 被破坏者</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/97c930010d059414ed9735727e80fd872f2953ea/201512/RR%E6%97%8B%E8%BD%AC2.PNG" alt="RR旋转：插入13"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/9eb84b36913ed2d07ca1f182ba409b8e17a2933f/201512/LL%E6%97%8B%E8%BD%AC.PNG" alt="LL旋转：插入Apr"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/0bfce7d45de6fb2b6ab88783e422ff17ccd2eb3d/201512/LR%E6%97%8B%E8%BD%AC.PNG" alt="LR旋转：插入Jan"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/40aba002879126450a2aebbce99c01b6f853e4a0/201512/RL%E6%97%8B%E8%BD%AC.PNG" alt="RL旋转：插入Feb"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/08/数据结构4-树-中-——4-2-平衡二叉树/" data-id="cisvpt2r500040ko03lxqmgmv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据结构/">数据结构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据结构4-树-中-——4-1-二叉搜索树" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/07/数据结构4-树-中-——4-1-二叉搜索树/" class="article-date">
  <time datetime="2015-12-07T11:26:42.000Z" itemprop="datePublished">2015-12-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/07/数据结构4-树-中-——4-1-二叉搜索树/">数据结构4-树-中-——4-1-二叉搜索树</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="4-1_二叉搜索树">4.1 二叉搜索树</h1><h2 id="4-1-1_二叉搜索树及查找">4.1.1 二叉搜索树及查找</h2><h3 id="什么是二叉搜索树">什么是二叉搜索树</h3><p>二叉搜索树（也称 二叉排序树 或 二叉查找树）：<br>一棵 二叉树，可以为空；如果 不为空，需要满足以下性质：</p>
<ul>
<li>1.非空 左子树 的所有键值 小于 其根结点的键值</li>
<li>2.非空 右子树 的所有键值 大于 其根结点的键值</li>
<li>3.左、右子树 都是 二叉搜索树</li>
</ul>
<p>函数：</p>
<ul>
<li>Position Find(ElementType X, BinTree BST):从 二叉搜索树BST中 查找元素X。返回其 所在结点的 地址</li>
<li>Position FindMin(BinTree BST)：从 二叉搜索树BST中 查找并返回 最小元素 所在结点的 地址</li>
<li>Position FindMax(BinTree BST)：从 二叉搜索树BST中 查找并返回 最大元素 所在结点的 地址</li>
<li>BinTree Insert(ElementType X, BinTree BST)：二叉搜索树BST中 插入元素X</li>
<li>BinTree Delete(ElementType X, BinTree BST):二叉搜索树BST中 删除元素X</li>
</ul>
<h3 id="二叉搜索树_查找操作：Find">二叉搜索树 查找操作：Find</h3><ul>
<li>从根结点 开始，如果树为空，返回NULL</li>
<li>搜索树非空，将 根结点 关键字 和X比较，进行不同处理：<ul>
<li>1.X 小于 根结点键值，在 左子树中 继续搜索</li>
<li>2.X 大于 根结点键值，在 右子树中 继续搜索</li>
<li>3.X 等于 根结点键值，搜索完成，返回此结点的 指针</li>
</ul>
</li>
</ul>
<hr>
<pre><code>Position Find(ElementType X, BinTree BST){
    <span class="keyword">if</span>(<span class="subst">!</span>BST){
        <span class="keyword">return</span> <span class="built_in">NULL</span>;<span class="comment">//查找失败</span>
    }
    <span class="keyword">if</span>(X &gt; BST<span class="subst">-&gt;</span><span class="built_in">Data</span>){
        <span class="keyword">return</span> Find(X, BST<span class="subst">-&gt;</span>Right);<span class="comment">//右子树 中继续查找</span>
    } <span class="keyword">else</span> <span class="keyword">if</span>(X &lt; BST<span class="subst">-&gt;</span><span class="built_in">Data</span>){
        <span class="keyword">return</span> Find(X, BST<span class="subst">-&gt;</span>Left);<span class="comment">//左子树中 继续查找</span>
    } <span class="keyword">else</span>{
        <span class="comment">//X == BST-&gt;Data</span>
        <span class="keyword">return</span> BST;<span class="comment">//查找成功，返回结点的地址</span>
    }
}
</code></pre><p>上边的递归是 尾递归，递归效率低，可以改成循环实现</p>
<pre><code>Position IterFind(ElementType X, BinTree BST){
    <span class="keyword">while</span>(BST){
        <span class="keyword">if</span>(X &gt; BST<span class="subst">-&gt;</span><span class="built_in">Data</span>){
            BST = BST<span class="subst">-&gt;</span>Right;<span class="comment">//向右子树移动，继续查找</span>
        } <span class="keyword">else</span> <span class="keyword">if</span>(X &lt; BST<span class="subst">-&gt;</span><span class="built_in">Data</span>){
            BST = BST<span class="subst">-&gt;</span>Left;<span class="comment">//向左子树移动，继续查找</span>
        } <span class="keyword">else</span> {
            <span class="comment">//X == BST-&gt;Data;</span>
            <span class="keyword">return</span> BST;<span class="comment">//查找成功，返回结点的地址</span>
        }
    }
    <span class="keyword">return</span> <span class="built_in">NULL</span>;<span class="comment">//查找失败</span>
}
</code></pre><p>查找效率 决定于 树的高度</p>
<h3 id="查找_最大和最小_元素">查找 最大和最小 元素</h3><p>最大元素 在 树的 最右分支 的端结点上<br>最小元素 在 树的 最左分支 的端结点上</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/600220ea7f6f5b9beb723f1ced9c2272e4b22c79/201512/%E6%90%9C%E7%B4%A2%E6%A0%91%E6%9C%80%E5%80%BC.PNG" alt="二叉搜索树 最值"></p>
<pre><code>Position FindMin(BinTree BST){
<span class="comment">//递归实现</span>
    <span class="keyword">if</span>(<span class="subst">!</span>BST){
        <span class="keyword">return</span> <span class="built_in">NULL</span>;<span class="comment">//空 二叉搜索树，返回NULL</span>
    } <span class="keyword">else</span> <span class="keyword">if</span>(<span class="subst">!</span> BST<span class="subst">-&gt;</span>Left){
        <span class="keyword">return</span> BST;<span class="comment">//找到 最左 叶节点 返回</span>
    } <span class="keyword">else</span> {
        <span class="keyword">return</span> FindMin(BST<span class="subst">-&gt;</span>Left);<span class="comment">//沿左分支 继续查找</span>
    }
}

Position FindMax(BinTree BST){
<span class="comment">//迭代实现</span>
    <span class="keyword">if</span>(BST){
        <span class="keyword">while</span>(BST<span class="subst">-&gt;</span>Right){
            BST = BST<span class="subst">-&gt;</span>Right;<span class="comment">//沿右分支 继续查找，直到最右 叶节点</span>
        }
    }
    <span class="keyword">return</span> BST;
}
</code></pre><h2 id="4-1-2_二叉搜索树的_插入">4.1.2 二叉搜索树的 插入</h2><p>关键是 找到要 插入的位置</p>
<pre><code>BinTree Insert(ElementType X, BinTree BST){
    <span class="keyword">if</span>(<span class="subst">!</span>BST){
        <span class="comment">//原树为空，生成 并 返回一个结点 的二叉搜索树</span>
        BST = malloc(sizeof(struct TreeNode));
        BST<span class="subst">-&gt;</span><span class="built_in">Data</span> = X;
        BST<span class="subst">-&gt;</span>Left = BST<span class="subst">-&gt;</span>Right = <span class="built_in">NULL</span>;
    } <span class="keyword">else</span> {
        <span class="comment">//开始找 要插入元素 的位置</span>
        <span class="keyword">if</span>(X &lt; BST<span class="subst">-&gt;</span><span class="built_in">Data</span>){
            BST<span class="subst">-&gt;</span>Left = Insert(X, BST<span class="subst">-&gt;</span>Left);<span class="comment">//递归 插入 左子树</span>
        } <span class="keyword">else</span> <span class="keyword">if</span>(X &gt; BST<span class="subst">-&gt;</span><span class="built_in">Data</span>){
            BST<span class="subst">-&gt;</span>Right = Insert(X, BST<span class="subst">-&gt;</span>Right);<span class="comment">//递归 插入 右子树</span>
        }<span class="comment">//else X已经存在，什么都不做</span>
    }
    <span class="keyword">return</span> BST;
}
</code></pre><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/8e0554d4dbc7e064aecc7d9baf67e139c1e2e779/201512/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%E6%8F%92%E5%85%A5%E4%BE%8B%E5%AD%90.PNG" alt="二叉搜索树插入例子"></p>
<p>按字母排序顺序插入</p>
<h2 id="4-1-3_二叉搜索树_的删除">4.1.3 二叉搜索树 的删除</h2><p>三种情况：</p>
<ul>
<li>要删除 叶节点：直接删除，再修改其 父结点指针 —— 置为NULL</li>
<li><p>要删除的结点 只有一个孩子结点：<br>将其父结点 的指针 指向 要删除结点的 孩子结点<br><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/250f44d5ec40a7e7157bbd681e3ea7c96b20fff8/201512/%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E5%AD%90%E7%BB%93%E7%82%B9%E7%9A%84%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91.PNG" alt="删除一个子结点的二叉搜索树"></p>
</li>
<li><p>要删除的结点 有左、右两颗子树<br>用另一个结点 替代 被删除的结点：右子树 的最小元素 或者 左子树的最大元素</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/9ef7dbc0f223790772bc7c7da9184e1c1bcc416b/201512/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%E5%88%A0%E9%99%A4%E7%BB%93%E7%82%B91.PNG" alt="右子树 最小元素 替代"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/7d4692673021bb3eec757ba485fc7474ba8ce6ce/201512/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%E5%88%A0%E9%99%A4%E7%BB%93%E7%82%B92.PNG" alt="左子树 最大元素 替代"></p>
<pre><code>BinTree Delete(ElementType X, BinTree BST){
    Position Tmp;
    <span class="keyword">if</span>(<span class="subst">!</span>BST){
        printf(<span class="string">"要删除的元素未找到"</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span>(X &lt; BST<span class="subst">-&gt;</span><span class="built_in">Data</span>){
        BST<span class="subst">-&gt;</span>Left = Delete(X, BST<span class="subst">-&gt;</span>Left);<span class="comment">//左子树 递归删除</span>
    } <span class="keyword">else</span> <span class="keyword">if</span>(X &gt; BST<span class="subst">-&gt;</span><span class="built_in">Data</span>) {
        BST<span class="subst">-&gt;</span>Right = Delete(X, BST<span class="subst">-&gt;</span>Right);<span class="comment">//右子树递归删除</span>
    } <span class="keyword">else</span> {
        <span class="comment">//找到要删除的结点</span>
        <span class="keyword">if</span>(BST<span class="subst">-&gt;</span>Left <span class="subst">&amp;&amp;</span> BST<span class="subst">-&gt;</span>Right){
            <span class="comment">//被删除的几点 有 左右两个子结点</span>
            Tmp = FindMin(BST<span class="subst">-&gt;</span>Right);<span class="comment">//右子树中找最小的元素 填充 删除结点</span>
            BST<span class="subst">-&gt;</span><span class="built_in">Data</span> = Tmp-?<span class="built_in">Data</span>;
            BST<span class="subst">-&gt;</span>Right = Delete(BST<span class="subst">-&gt;</span><span class="built_in">Data</span>, BST<span class="subst">-&gt;</span>Right);<span class="comment">//删除结点的 右子树中 删除 最小元素</span>
        } <span class="keyword">else</span> {
            <span class="comment">//被删除结点 有一个或无 子结点</span>
            Tmp = BST;
            <span class="keyword">if</span>(<span class="subst">!</span>BST<span class="subst">-&gt;</span>Left){
                <span class="comment">//有 右孩子 或 无 子结点</span>
                BST = BST<span class="subst">-&gt;</span>Right;
            }<span class="keyword">else</span> <span class="keyword">if</span>(<span class="subst">!</span>BST<span class="subst">-&gt;</span>Right){
                <span class="comment">//有左孩子 或无 子结点</span>
                BST = BST<span class="subst">-&gt;</span>Left;
            }
        }
        free(Tmp);
    }
    <span class="keyword">return</span> BST;
}
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/07/数据结构4-树-中-——4-1-二叉搜索树/" data-id="cisvpt2r700060ko0pnfvw689" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据结构/">数据结构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据结构3-树-上-——3-3-二叉树的遍历" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/04/数据结构3-树-上-——3-3-二叉树的遍历/" class="article-date">
  <time datetime="2015-12-04T01:53:17.000Z" itemprop="datePublished">2015-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/04/数据结构3-树-上-——3-3-二叉树的遍历/">数据结构3-树-上-——3-3-二叉树的遍历</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="3-3_二叉树的遍历">3.3 二叉树的遍历</h1><h2 id="3-3-1_二叉树的遍历">3.3.1 二叉树的遍历</h2><h3 id="(1)先序遍历">(1)先序遍历</h3><p><strong> 遍历过程： </strong></p>
<ul>
<li>1.访问 根结点</li>
<li>2.遍历 左子树</li>
<li>3.遍历 右子树</li>
</ul>
<p>递归实现</p>
<pre><code><span class="label">void</span> PreOrderTraversal(<span class="keyword">BinTree </span><span class="keyword">BT){
</span>    <span class="preprocessor">if</span>(<span class="keyword">BT){
</span>        printf(<span class="string">"%d"</span>, <span class="keyword">BT-&gt;Data);//访问 </span>根结点
        PreOrderTraversal(<span class="keyword">BT-&gt;Left);
</span>        PreOrderTraversal(<span class="keyword">BT-&gt;Right);
</span>    }
}
</code></pre><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/5fac93dd29dd9d994c8de6aad6369524eb793f59/201512/%E5%85%88%E5%BA%8F%E9%81%8D%E5%8E%86.PNG" alt="先序遍历"></p>
<p>先序遍历：A (B D F E) ，(C G H I)</p>
<h3 id="(2)中序遍历">(2)中序遍历</h3><p><strong> 遍历过程： </strong></p>
<ul>
<li>1.中序遍历 左子树</li>
<li>2.访问根结点</li>
<li>3.中序遍历 右子树</li>
</ul>
<hr>
<pre><code><span class="label">void</span> InOrderTraversal(<span class="keyword">BinTree </span><span class="keyword">BT){
</span>    <span class="preprocessor">if</span>(<span class="keyword">BT){
</span>        InOrderTraversal(<span class="keyword">BT-&gt;Left);
</span>        printf(<span class="string">"%d"</span>, <span class="keyword">BT-&gt;Data);
</span>        InOrderTraversal(<span class="keyword">BT-&gt;Right);
</span>    }
}
</code></pre><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/6157a3e3d7e42a1b755a7d502baa381224848bc6/201512/%E4%B8%AD%E5%BA%8F%E9%81%8D%E5%8E%86.PNG" alt="中序遍历"></p>
<p>中序遍历：（D B E F）A （G H C I）</p>
<h3 id="(3)后序遍历">(3)后序遍历</h3><p><strong> 遍历过程： </strong></p>
<ul>
<li>1.后序遍历 左子树</li>
<li>2.后序遍历 右子树</li>
<li>3.访问 根结点</li>
</ul>
<hr>
<pre><code><span class="label">void</span> PostOrderTraversal(<span class="keyword">BinTree </span><span class="keyword">BT){
</span>    <span class="preprocessor">if</span>(<span class="keyword">BT){
</span>        PostOrderTraversal(<span class="keyword">BT-&gt;Left);
</span>        PostOrderTraversal(<span class="keyword">BT-&gt;Right);
</span>        printf(<span class="string">"%d"</span>, <span class="keyword">BT-&gt;Data);
</span>    }
}
</code></pre><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/6871cb78c8ef977f98ea9877c65ec8f18a411a33/201512/%E5%90%8E%E5%BA%8F%E9%81%8D%E5%8E%86.PNG" alt="后序遍历"></p>
<p>后序遍历：(D E F B) (H G I C) A</p>
<h3 id="先序、中序和后序遍历过程：">先序、中序和后序遍历过程：</h3><p>遍历过程中 经过的结点的 路线一样，只是访问各结点的时机不同。</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/d35a42204a3293aabaa4baefba490d1ec39585ac/201512/%E9%81%8D%E5%8E%86%E8%BF%87%E7%A8%8B.PNG" alt="遍历过程"></p>
<p>以上遍历都是通过 递归 实现的，递归本质是用 堆栈 实现的</p>
<h2 id="3-3-2_二叉树_的_非递归遍历">3.3.2 二叉树 的 非递归遍历</h2><h3 id="中序遍历_非递归_实现：使用堆栈">中序遍历 非递归 实现：使用堆栈</h3><p>算法：</p>
<ul>
<li>遇到一个结点，压入栈，遍历它的左子树</li>
<li>当 左子树 遍历结束后，从 栈顶 弹出一个结点，并访问它</li>
<li>然后按其 右指针 再去 中序遍历 该结点的右子树</li>
</ul>
<hr>
<pre><code><span class="literal">void</span> InOrderTraversal(BinTree BT){
    BinTree T = BT;
    <span class="built_in">Stack</span> S = CreateStack(MaxSize);<span class="comment">//创建并初始化堆栈S</span>
    <span class="keyword">while</span>(T <span class="subst">||</span> <span class="subst">!</span>IsEmpty(S)){
        <span class="comment">//树T不为空，或者 堆栈S不为空</span>

        <span class="keyword">while</span>(T){
            <span class="comment">//一直向左 并将 沿途结点 压入堆栈</span>
            Push(S, T);
            T = T<span class="subst">-&gt;</span>Left;<span class="comment">//往左走</span>
        }

        <span class="keyword">if</span>(<span class="subst">!</span>IsEmpty(S)){
            T = Pop(S);<span class="comment">//结点弹出堆栈</span>
            printf(<span class="string">"%5d"</span>, T<span class="subst">-&gt;</span><span class="built_in">Data</span>);<span class="comment">//访问（打印）结点</span>
            T = T<span class="subst">-&gt;</span>Right;<span class="comment">//转向 右子树</span>
        }
    }
} 
</code></pre><h3 id="先序遍历_的_非递归_实现：">先序遍历 的 非递归 实现：</h3><pre><code><span class="literal">void</span> InOrderTraversal(BinTree BT){
    BinTree T = BT;
    <span class="built_in">Stack</span> S = CreateStack(MaxSize);<span class="comment">//创建并初始化堆栈S</span>
    <span class="keyword">while</span>(T <span class="subst">||</span> <span class="subst">!</span>IsEmpty(S)){
        <span class="keyword">while</span>(T){
            <span class="comment">//一直向左，并将 沿途结点 压入堆栈</span>
            Push(S, T);
            printf(<span class="string">"%5d"</span>, T<span class="subst">-&gt;</span><span class="built_in">Data</span>);<span class="comment">//访问（打印）结点</span>
            T = T<span class="subst">-&gt;</span>Left;
        }

        <span class="keyword">if</span>(<span class="subst">!</span>IsEmpty(S)){
            T = Pop(S);<span class="comment">//结点 弹出堆栈        </span>
            T = T<span class="subst">-&gt;</span>Right;<span class="comment">//转向 右子树</span>
        }
    }
}
</code></pre><h2 id="3-3-3_层序遍历">3.3.3 层序遍历</h2><h3 id="层序遍历">层序遍历</h3><p><strong> 二叉树 遍历 的核心问题： </strong> 二维结构的 线性化</p>
<ul>
<li>从结点 访问 其左、右儿子结点</li>
<li>访问左儿子后，右儿子 结点 怎么办？<ul>
<li>需要一个存储结构 保存 暂时不访问的结点</li>
<li>存储结构：堆栈、队列</li>
</ul>
</li>
</ul>
<h3 id="队列实现：">队列实现：</h3><p>遍历 从 根结点 开始，首先将 根结点 入队，然后 开始执行循环：结点出队、访问该结点、其左右儿子入队</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/02f4b68e424b0a989368b126d46cff512b212cda/201512/%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B01.PNG" alt="队列实现1"></p>
<h3 id="层序基本过程">层序基本过程</h3><p>先根结点入队，然后：<br>1.从队列中 取出一个元素<br>2.访问 该元素指向的结点<br>3.若元素所指向的结点 的左、右孩子结点 非空，则将其 左、右孩子的指针顺序入队</p>
<pre><code><span class="literal">void</span> LevelOrderTraversal(BinTree BT){
    <span class="built_in">Queue</span> Q;
    BinTree T;

    <span class="keyword">if</span>(<span class="subst">!</span>BT){
        <span class="keyword">return</span>;<span class="comment">//若 是空树 ，则返回</span>
    }

    Q = CreateQueue(maxSize);<span class="comment">//创建 并 初始化 队列Q</span>
    AddQ(Q, BT);<span class="comment">//根结点 放到 队列中</span>

    <span class="keyword">while</span>(<span class="subst">!</span>IsEmptyQ(Q)){
        T = DeleteQ(Q);<span class="comment">//队列中 抛出一个元素</span>
        printf(<span class="string">"%d\n"</span>, T<span class="subst">-&gt;</span><span class="built_in">Data</span>);<span class="comment">//访问 取出 队列的结点</span>
        <span class="keyword">if</span>(T<span class="subst">-&gt;</span>Left){
            AddQ(Q, T<span class="subst">-&gt;</span>Left)l;
        }
        <span class="keyword">if</span>(T<span class="subst">-&gt;</span>Right){
            AddQ(Q, T<span class="subst">-&gt;</span>Right);
        }
    }
}
</code></pre><h2 id="3-3-4_遍历应用例子">3.3.4 遍历应用例子</h2><h3 id="[例]遍历_二叉树的应用：_输出_二叉树中的_叶子结点">[例]遍历 二叉树的应用： 输出 二叉树中的 叶子结点</h3><p>叶子结点：左右子树 都为空</p>
<pre><code><span class="label">void</span> PreOrderPrintLeaves(<span class="keyword">BinTree </span><span class="keyword">BT){
</span>    <span class="preprocessor">if</span>(<span class="keyword">BT){
</span>        <span class="preprocessor">if</span>(!<span class="keyword">BT-&gt;Left </span>&amp;&amp; !<span class="keyword">BT-&gt;Right){
</span>            printf(<span class="string">"%d"</span>, <span class="keyword">BT-&gt;Data);
</span>        }
        PreOrderPrintLeaves(<span class="keyword">BT-&gt;Left);
</span>        PreOrderPrintLeaves(<span class="keyword">BT_&gt;Right);
</span>    }
}
</code></pre><h3 id="[例]求二叉树的高度">[例]求二叉树的高度</h3><p>二叉树的高度：Height = max（左子树高， 右子树高）+ 1</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">PostOrderGetHeight</span><span class="params">(BinTree BT)</span></span>{
    <span class="keyword">int</span> HL, HR, MaxH;
    <span class="keyword">if</span>(BT){
        HL = PostOrderGetHeight(BT-&gt;Left);<span class="comment">//左子树的 深度</span>
        HR = PostOrderGetHeight(BT-&gt;Right);<span class="comment">//右子树 的深度</span>
        MaxH = (HL &gt; HR) ? HL : HR;<span class="comment">//取左 右子树 最大深度</span>
        <span class="keyword">return</span> MaxH + <span class="number">1</span>;
    } <span class="keyword">else</span> {
        <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//空树 深度为0</span>
    }        
}
</code></pre><h3 id="[例]二元运算表达式_树_及其遍历">[例]二元运算表达式 树 及其遍历</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/929170c6ed445d81a7ca8b29bfcf3771ed6dff9d/201512/%E4%BA%8C%E5%85%83%E8%BF%90%E7%AE%97.PNG" alt="二元运算"><br>三种遍历得到的结果：<br>先序遍历 得到 前缀表达式：+ + a <em> b c </em> + <em> d e f g<br>中序遍历 得到 中缀表达式：a + b </em> c + d <em> e + f </em> g<br>后序遍历 得到 后缀表达式： a b c <em> +  d e </em> f + g * +</p>
<p>中缀 表达式 受 运算符优先级 影响</p>
<h3 id="[例]由两种遍历序列_确定_二叉树">[例]由两种遍历序列 确定 二叉树</h3><p>必须要有 中序遍历才行</p>
<p>没有中序 的困扰：</p>
<ul>
<li>先序遍历序列：A B</li>
<li>后序遍历序列：B A</li>
</ul>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/376d2fc8bbb1c6ca806e512f0cb3c3821af40029/201512/%E9%81%8D%E5%8E%86%E7%A1%AE%E5%AE%9A%E4%BA%8C%E5%8F%89%E6%A0%91.PNG" alt="先序、后序 不能确定 唯一的二叉树"></p>
<h3 id="先序和中序遍历_序列_确定二叉树">先序和中序遍历 序列 确定二叉树</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/faa917aa96ac702ca310e7037a2ef2131bb0f576/201512/%E5%85%88%E5%BA%8F%E5%92%8C%E4%B8%AD%E5%BA%8F%E7%A1%AE%E5%AE%9A%E4%BA%8C%E5%8F%89%E6%A0%91.PNG" alt="先序和中序遍历 序列 确定二叉树"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/04/数据结构3-树-上-——3-3-二叉树的遍历/" data-id="cisvpt2r900080ko04yzy7alg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据结构/">数据结构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据结构3-树-上-——3-2-二叉树与存储结构" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/03/数据结构3-树-上-——3-2-二叉树与存储结构/" class="article-date">
  <time datetime="2015-12-03T04:44:51.000Z" itemprop="datePublished">2015-12-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/03/数据结构3-树-上-——3-2-二叉树与存储结构/">数据结构3-树-上-——3-2-二叉树与存储结构</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="3-2_二叉树及存储结构">3.2 二叉树及存储结构</h1><h2 id="3-2-1_二叉树的定义">3.2.1 二叉树的定义</h2><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/314abd6ad2297a34d354aac072cbad88704b7b33/201512/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%AE%9A%E4%B9%89.PNG" alt="二叉树的定义"><br>(a)是空树<br>(b)只有一个结点，左子树 右子树 为空<br>(c)有左子树，右子树为空<br>(d)左子树为空，有右子树<br>(e)左子树 右子树都非空</p>
<h3 id="特殊二叉树">特殊二叉树</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/591980a52b80dcea2159714719032bd2e478e923/201512/%E7%89%B9%E6%AE%8A%E4%BA%8C%E5%8F%89%E6%A0%911.PNG" alt="特殊二叉树1"><br>完全二叉树：有n个结点的二叉树，对 树中结点 按 从上至下、从左到右顺序 进行编号，编号为i(1 &lt;= i &lt;= n) 的结点 与 满二叉树中 编号为i的结点 在二叉树中 位置相同</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/38b39bdaf7c2ca4b1ec6e74b0b98a1761c4de1e3/201512/%E5%AE%8C%E5%85%A8%E4%BA%8C%E5%8F%89%E6%A0%911.PNG" alt="完全二叉树1"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/bf84cbbe47481ba0874c0f5bb6c7cceb77b066f7/201512/%E5%AE%8C%E5%85%A8%E4%BA%8C%E5%8F%89%E6%A0%912.PNG" alt="完全二叉树2"></p>
<h3 id="二叉树的几个重要性质">二叉树的几个重要性质</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/519494d1bdfc1bc1ef37647e1234a0a17882dc50/201512/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E6%80%A7%E8%B4%A8.PNG" alt="二叉树的几个重要性质"><br>n0表示 没有 子树的结点，n1是有一个子树的结点，n2是有2个子树的结点。</p>
<h3 id="二叉树的抽象数据类型定义">二叉树的抽象数据类型定义</h3><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/3b57a5fdd00eb6678bddbfccd4ebbcabc2a91cf2/201512/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E6%8A%BD%E8%B1%A1%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89.PNG" alt="二叉树的抽象数据类型定义"></p>
<h2 id="3-2-2_二叉树的存储结构">3.2.2 二叉树的存储结构</h2><p><strong> 数组存储 </strong><br><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/856841d5e4f0ea618643d873f23eb730680815f1/201512/%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E9%A1%BA%E5%BA%8F%E5%AD%98%E5%82%A8.PNG" alt="二叉树的顺序存储"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/18631f2efd478f41b2c58fee471550cff90d9517/201512/%E9%A1%BA%E5%BA%8F%E5%AD%98%E5%82%A8%E4%B8%80%E8%88%AC%E4%BA%8C%E5%8F%89%E6%A0%91.PNG" alt="顺序存储 一般二叉树"></p>
<p><strong> 链表存储 </strong></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/716559ce792356880ee64401109f62c5cb93c24e/201512/%E9%93%BE%E8%A1%A8%E5%AD%98%E5%82%A8%E4%BA%8C%E5%8F%89%E6%A0%91.PNG" alt="链表存储二叉树"></p>
<pre><code><span class="label">typedef</span> <span class="keyword">struct </span>TreeNode *<span class="keyword">BinTree;
</span><span class="label">typedef</span> <span class="keyword">BinTree </span>Position<span class="comment">;</span>
<span class="keyword">struct </span>TreeNode{
    ElementType <span class="preprocessor">Data</span><span class="comment">;</span>
    <span class="keyword">BinTree </span>Left<span class="comment">;</span>
    <span class="keyword">BinTree </span>Right<span class="comment">;</span>
}
</code></pre><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/1daaeb800bd0fc2ab8079aa728b405c4fbf80f5f/201512/%E9%93%BE%E8%A1%A8%E5%AD%98%E5%82%A8%E4%BA%8C%E5%8F%89%E6%A0%91%E4%B8%BE%E4%BE%8B.PNG" alt="链表存储二叉树举例"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/03/数据结构3-树-上-——3-2-二叉树与存储结构/" data-id="cisvpt2ra000a0ko03bcseu25" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据结构/">数据结构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-framework-MediaScanner" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/02/framework-MediaScanner/" class="article-date">
  <time datetime="2015-12-02T07:22:05.000Z" itemprop="datePublished">2015-12-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/02/framework-MediaScanner/">framework--MediaScanner</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="MediaScanner">MediaScanner</h1><h2 id="涉及组件">涉及组件</h2><ul>
<li>MediaScannerService:负责扫描媒体文件，将扫描的信息插入到媒体数据库中</li>
<li>MediaProvider：处理 媒体数据库的增删改查</li>
<li>MediaScannerReceiver：接收外界发来的扫描请求，MediaScanner对外提供的接口</li>
</ul>
<h2 id="1-MediaScannerReceiver">1.MediaScannerReceiver</h2><pre><code>@Override
<span class="keyword">public</span> <span class="literal">void</span> onReceive(Context context, Intent intent) {
    final <span class="built_in">String</span> action = intent<span class="built_in">.</span>getAction();
    final Uri uri = intent<span class="built_in">.</span>getData();
    <span class="keyword">if</span> (Intent<span class="built_in">.</span>ACTION_BOOT_COMPLETED<span class="built_in">.</span><span class="keyword">equals</span>(action)) {
        <span class="comment">//接收BOOT_COMPLETED广播，扫描内部 外部存储区。</span>
        <span class="comment">//内部存储区 扫描的是/system/midia目录，存储了系统自带的铃声等媒体文件</span>
        <span class="comment">// Scan both internal and external storage</span>
        scan(context, MediaProvider<span class="built_in">.</span>INTERNAL_VOLUME);
        scan(context, MediaProvider<span class="built_in">.</span>EXTERNAL_VOLUME);

    } <span class="keyword">else</span> {
        <span class="keyword">if</span> (uri<span class="built_in">.</span>getScheme()<span class="built_in">.</span><span class="keyword">equals</span>(<span class="string">"file"</span>)) {
            <span class="comment">// handle intents related to external storage</span>
            <span class="comment">//uri = file:///storage/emulated/0/Sound_recorder/%E5%BD%95%E9%9F%B3_2015%E5%B9%B412%E6%9C%882%E6%97%A5_11%E7%82%B918%E5%88%8653%E7%A7%92.aac, </span>
            <span class="comment">//path = /storage/emulated/0/Sound_recorder/录音_2015年12月2日_11点18分53秒.aac</span>
            <span class="built_in">String</span> path = uri<span class="built_in">.</span>getPath();
            <span class="built_in">String</span> externalStoragePath = Environment<span class="built_in">.</span>getExternalStorageDirectory()<span class="built_in">.</span>getPath();<span class="comment">// /storage/emulated/0</span>
            <span class="built_in">String</span> legacyPath = Environment<span class="built_in">.</span>getLegacyExternalStorageDirectory()<span class="built_in">.</span>getPath();<span class="comment">// /sdcard</span>

            try {
                path = <span class="literal">new</span> File(path)<span class="built_in">.</span>getCanonicalPath();
            } catch (IOException e) {
                <span class="keyword">Log</span><span class="built_in">.</span>e(<span class="built_in">TAG</span>, <span class="string">"couldn't canonicalize "</span> + path);
                <span class="keyword">return</span>;
            }
            <span class="keyword">if</span> (path<span class="built_in">.</span>startsWith(legacyPath)) {
                path = externalStoragePath + path<span class="built_in">.</span>substring(legacyPath<span class="built_in">.</span>length());
            }

            <span class="keyword">Log</span><span class="built_in">.</span>d(<span class="built_in">TAG</span>, <span class="string">"action: "</span> + action + <span class="string">" path: "</span> + path);
            <span class="keyword">if</span> (Intent<span class="built_in">.</span>ACTION_MEDIA_MOUNTED<span class="built_in">.</span><span class="keyword">equals</span>(action)) {
                <span class="comment">//接收MEDIA_MOUNTED，扫描 外部存储 /storage/emulated/0</span>
                <span class="comment">// scan whenever any volume is mounted</span>
                scan(context, MediaProvider<span class="built_in">.</span>EXTERNAL_VOLUME);
            } <span class="keyword">else</span> <span class="keyword">if</span> (Intent<span class="built_in">.</span>ACTION_MEDIA_SCANNER_SCAN_FILE<span class="built_in">.</span><span class="keyword">equals</span>(action) <span class="subst">&amp;&amp;</span>
                    path != <span class="built_in">null</span> <span class="subst">&amp;&amp;</span> path<span class="built_in">.</span>startsWith(externalStoragePath + <span class="string">"/"</span>)) {
                <span class="comment">//外部应用 可以通过发送 ACTION_MEDIA_SCANNER_SCAN_FILE 让MediaScannerReceiver扫描 单个文件，这个文件必须位于SD卡上</span>
                scanFile(context, path);
            }
        }
    }
}
<span class="keyword">private</span> <span class="literal">void</span> scan(Context context, <span class="built_in">String</span> volume) {
    Bundle args = <span class="literal">new</span> Bundle();
    args<span class="built_in">.</span>putString(<span class="string">"volume"</span>, volume);
    <span class="comment">//启动 MediaScannerService</span>
    context<span class="built_in">.</span>startService(
            <span class="literal">new</span> Intent(context, MediaScannerService<span class="built_in">.</span>class)<span class="built_in">.</span>putExtras(args));
}    

<span class="keyword">private</span> <span class="literal">void</span> scanFile(Context context, <span class="built_in">String</span> path) {
    Bundle args = <span class="literal">new</span> Bundle();
    args<span class="built_in">.</span>putString(<span class="string">"filepath"</span>, path);
    <span class="comment">//启动 MediaScannerService</span>
    context<span class="built_in">.</span>startService(
            <span class="literal">new</span> Intent(context, MediaScannerService<span class="built_in">.</span>class)<span class="built_in">.</span>putExtras(args));
}   
</code></pre><p>MediaProvider.java</p>
<pre><code><span class="literal">static</span> <span class="keyword">final</span> <span class="built_in">String</span> INTERNAL_VOLUME = <span class="string">"internal"</span>;
<span class="literal">static</span> <span class="keyword">final</span> <span class="built_in">String</span> EXTERNAL_VOLUME = <span class="string">"external"</span>;
</code></pre><p>MediaScannerReceiver接收三种请求：</p>
<ul>
<li>ACTION_BOOT_COMPLETED：扫描内部 外部存储</li>
<li>ACTION_MEDIA_MOUNTED：扫描外部存储</li>
<li>ACTION_MEDIA_SCANNER_SCAN_FILE：扫描Sd卡上的一个文件，文件路径必须以Environment.getExternalStorageDirectory().getPath() 开头</li>
</ul>
<h2 id="2-MediaScannerService">2.MediaScannerService</h2><pre><code>public <span class="class"><span class="keyword">class</span> <span class="title">MediaScannerService</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">Service</span> <span class="title">implements</span> <span class="title">Runnable</span></span>
</code></pre><h3 id="2-1_onCreate">2.1 onCreate</h3><pre><code>    <span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span>
</span>{
    <span class="comment">//获得PowerManager，防止扫描过程中休眠</span>
    PowerManager pm = (PowerManager)getSystemService(Context.POWER_SERVICE);
    mWakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, TAG);
    StorageManager storageManager = (StorageManager)getSystemService(Context.STORAGE_SERVICE);
    mExternalStoragePaths = storageManager.getVolumePaths();

    <span class="comment">// Start up the thread running the service.  Note that we create a</span>
    <span class="comment">// separate thread because the service normally runs in the process's</span>
    <span class="comment">// main thread, which we don't want to block.</span>
    Thread thr = <span class="keyword">new</span> Thread(<span class="keyword">null</span>, <span class="keyword">this</span>, <span class="string">"MediaScannerService"</span>);
    thr.start();<span class="comment">//创建一个工作线程，工作在MediaScannerService的run()中</span>
}

<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span>
</span>{
    <span class="comment">//设置线程的优先级，调低优先级，避免MediaScannerService一直占用CPU，导致系统卡</span>
    <span class="comment">// reduce priority below other background threads to avoid interfering</span>
    <span class="comment">// with other services at boot time.</span>
    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND +
            Process.THREAD_PRIORITY_LESS_FAVORABLE);
    Looper.prepare();

    mServiceLooper = Looper.myLooper();
    mServiceHandler = <span class="keyword">new</span> ServiceHandler();<span class="comment">//创建一个Handler</span>

    Looper.loop();
}
</code></pre><p>onCreate后，MediaScannerService创建一个 带消息处理机制 的工作线程，消息 如何传递到 这个线程呢？</p>
<h2 id="2-2_onStartCommand">2.2 onStartCommand</h2><pre><code><span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span>
</span>{
    <span class="comment">//等待mServiceHandler被创建</span>
    <span class="keyword">while</span> (mServiceHandler == <span class="keyword">null</span>) {
        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {
            <span class="keyword">try</span> {
                wait(<span class="number">100</span>);
            } <span class="keyword">catch</span> (InterruptedException e) {
            }
        }
    }

    <span class="keyword">if</span> (intent == <span class="keyword">null</span>) {
        Log.e(TAG, <span class="string">"Intent is null in onStartCommand: "</span>,
            <span class="keyword">new</span> NullPointerException());
        <span class="keyword">return</span> Service.START_NOT_STICKY;
    }

    Message msg = mServiceHandler.obtainMessage();
    msg.arg1 = startId;
    msg.obj = intent.getExtras();
    mServiceHandler.sendMessage(msg);<span class="comment">//发消息，最终由工作线程处理</span>

    <span class="comment">// Try again later if we are killed before we can finish scanning.</span>
    <span class="keyword">return</span> Service.START_REDELIVER_INTENT;
}
</code></pre><p>onStartCommand将 扫描请求信息 投递到 工作线程中 去处理。</p>
<h2 id="2-3处理扫描请求">2.3处理扫描请求</h2><pre><code><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">Handler</span>
</span>{
    <span class="annotation">@Override</span>
    public void handleMessage(<span class="type">Message</span> msg)
    {
        <span class="type">Bundle</span> arguments = (<span class="type">Bundle</span>) msg.obj;
        <span class="type">String</span> filePath = arguments.getString(<span class="string">"filepath"</span>);

        <span class="keyword">try</span> {
            ……
            } <span class="keyword">else</span> {
                <span class="type">String</span> volume = arguments.getString(<span class="string">"volume"</span>);
                <span class="type">String</span>[] directories = <span class="literal">null</span>;

                <span class="keyword">if</span> (<span class="type">MediaProvider</span>.<span class="type">INTERNAL_VOLUME</span>.equals(volume)) {
                    <span class="comment">//扫描内部存储，Environment.getRootDirectory()：/system ，Environment.getOemDirectory() ： /oem </span>
                    <span class="comment">// scan internal media storage</span>
                    directories = <span class="keyword">new</span> <span class="type">String</span>[] {
                            <span class="type">Environment</span>.getRootDirectory() + <span class="string">"/media"</span>,
                            <span class="type">Environment</span>.getOemDirectory() + <span class="string">"/media"</span>,
                    };
                }
                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">MediaProvider</span>.<span class="type">EXTERNAL_VOLUME</span>.equals(volume)) {
                    <span class="comment">// scan external storage volumes</span>
                    directories = mExternalStoragePaths;<span class="comment">// [/storage/emulated/0]</span>
                }

                <span class="keyword">if</span> (directories != <span class="literal">null</span>) {
                    <span class="keyword">if</span> (<span class="literal">false</span>) <span class="type">Log</span>.d(<span class="type">TAG</span>, <span class="string">"start scanning volume "</span> + volume + <span class="string">": "</span>
                            + <span class="type">Arrays</span>.toString(directories));
                    <span class="comment">//调用scan函数扫描文件夹，可以一次设置多个目标文件夹</span>
                    scan(directories, volume);
                    <span class="keyword">if</span> (<span class="literal">false</span>) <span class="type">Log</span>.d(<span class="type">TAG</span>, <span class="string">"done scanning volume "</span> + volume);
                }
            }
        } <span class="keyword">catch</span> (<span class="type">Exception</span> e) {
            <span class="type">Log</span>.e(<span class="type">TAG</span>, <span class="string">"Exception in handleMessage"</span>, e);
        }

        stopSelf(msg.arg1);
    }
};
</code></pre><h2 id="2-4_MediaScannerService的scan函数">2.4 MediaScannerService的scan函数</h2><pre><code>private <span class="keyword">void</span> scan(<span class="built_in">String</span>[] directories, <span class="built_in">String</span> volumeName) {
    <span class="built_in">Uri</span> uri = <span class="built_in">Uri</span>.parse(<span class="string">"file://"</span> + directories[<span class="number">0</span>]);
    <span class="comment">// don't sleep while scanning</span>
    mWakeLock.acquire();

    <span class="keyword">try</span> {
        ContentValues values = <span class="keyword">new</span> ContentValues();
        values.put(MediaStore.MEDIA_SCANNER_VOLUME, volumeName);
        <span class="comment">//MediaScannerService通过insert这个特殊的Uri让MediaProvider做一些准备工作</span>
        <span class="comment">//MediaStore.getMediaScannerUri(): content://media/none/media_scanner</span>
        <span class="built_in">Uri</span> scanUri = getContentResolver().insert(MediaStore.getMediaScannerUri(), values);

        <span class="comment">//发ACTION_MEDIA_SCANNER_STARTED广播</span>
        sendBroadcast(<span class="keyword">new</span> Intent(Intent.ACTION_MEDIA_SCANNER_STARTED, uri));

        <span class="keyword">try</span> {
            <span class="keyword">if</span> (volumeName.equals(MediaProvider.EXTERNAL_VOLUME)) {
                <span class="comment">//打开数据库</span>
                openDatabase(volumeName);
            }

            <span class="comment">//创建MediaScanner，调用scanDirectories扫描目标文件夹</span>
            MediaScanner scanner = createMediaScanner();
            scanner.scanDirectories(directories, volumeName);
        } <span class="keyword">catch</span> (Exception e) {
            Log.e(TAG, <span class="string">"exception in MediaScanner.scan()"</span>, e);
        }
        <span class="comment">//通过 特殊Uri 让MediaProvider 做一些清理工作</span>
        getContentResolver().delete(scanUri, <span class="keyword">null</span>, <span class="keyword">null</span>);

    } <span class="keyword">finally</span> {
        <span class="comment">//发送ACTION_MEDIA_SCANNER_FINISHED广播</span>
        sendBroadcast(<span class="keyword">new</span> Intent(Intent.ACTION_MEDIA_SCANNER_FINISHED, uri));
        mWakeLock.release();
    }
}
<span class="comment">//openDatabase()通过insert这个特殊的Uri 让MediaProvider打开数据库</span>
private <span class="keyword">void</span> openDatabase(<span class="built_in">String</span> volumeName) {
    <span class="keyword">try</span> {
        ContentValues values = <span class="keyword">new</span> ContentValues();
        values.put(<span class="string">"name"</span>, volumeName);
        getContentResolver().insert(<span class="built_in">Uri</span>.parse(<span class="string">"content://media/"</span>), values);
    } <span class="keyword">catch</span> (IllegalArgumentException ex) {
        Log.w(TAG, <span class="string">"failed to open media database"</span>);
    }         
}
</code></pre><p>上边代码中，比较复杂的是 MediaScannerService和MediaProvider交互。除了后文的正常数据库操作外，MediaScannerService还经常会使用一些特殊的Uri来做数据库操作，而MediaProvider针对Uri会做一些特殊处理，如打开数据库文件等。</p>
<pre><code><span class="keyword">private</span> MediaScanner createMediaScanner() {
    MediaScanner scanner = <span class="literal">new</span> MediaScanner(this);
    <span class="comment">//获取当前系统使用的区域信息，扫描的时候 将 媒体文件信息 转换成 当前系统的语言</span>
    <span class="built_in">Locale</span> <span class="built_in">locale</span> = getResources()<span class="built_in">.</span>getConfiguration()<span class="built_in">.</span><span class="built_in">locale</span>;
    <span class="keyword">if</span> (<span class="built_in">locale</span> != <span class="built_in">null</span>) {
        <span class="built_in">String</span> language = <span class="built_in">locale</span><span class="built_in">.</span>getLanguage();
        <span class="built_in">String</span> country = <span class="built_in">locale</span><span class="built_in">.</span>getCountry();
        <span class="built_in">String</span> localeString = <span class="built_in">null</span>;
        <span class="keyword">if</span> (language != <span class="built_in">null</span>) {
            <span class="keyword">if</span> (country != <span class="built_in">null</span>) {
                <span class="comment">//为扫描器 设置当前系统使用的 国家和语言</span>
                scanner<span class="built_in">.</span>setLocale(language + <span class="string">"_"</span> + country);
            } <span class="keyword">else</span> {
                scanner<span class="built_in">.</span>setLocale(language);
            }
        }    
    }

    <span class="keyword">return</span> scanner;
}
</code></pre><h2 id="2-3媒体扫描工作总结">2.3媒体扫描工作总结</h2><p>MediaScannerReceiver和MediaScannerService交互，流程：</p>
<ul>
<li>MediaScannerReceiver 接收 外部发来 的扫描请求，通过startService启动MediaScannerService处理</li>
<li>MediaScannerService的 主线程接收 MediaScannerReceiver收到的请求，然后 投递给 工作线程去处理</li>
<li>工作线程做一些 前期处理工作（例如 向系统发 扫描开始的 广播），创建MediaScanner来处理扫描目标</li>
<li>MediaScanner扫描完成后，工作线程 做后期处理，然后向系统 发扫描完毕的广播</li>
</ul>
<h1 id="3-MediaScanner分析">3.MediaScanner分析</h1><p>MediaScanner工作原理，跨 Java层、JNI层 Native层。</p>
<h2 id="3-1_Java层">3.1 Java层</h2><h3 id="3-1-1_创建MediaScanner">3.1.1 创建MediaScanner</h3><pre><code>public <span class="class"><span class="keyword">class</span> <span class="title">MediaScanner</span></span>
{
    static {
            <span class="constant">System</span>.loadLibrary(<span class="string">"media_jni"</span>);<span class="regexp">//</span>加载system/<span class="class"><span class="keyword">lib</span>/<span class="title">libmedia_jni</span>.<span class="title">so</span></span>
        native_init();
    }
    ……
    public <span class="constant">MediaScanner</span>(<span class="constant">Context</span> c) {
        native_setup();<span class="regexp">//</span>调用<span class="constant">JNI</span>层 做一些初始化 工作
        ……
    }
}
</code></pre><h3 id="3-1-2_scanDirectories分析">3.1.2 scanDirectories分析</h3><pre><code><span class="comment">/** whether to use bulk inserts or individual inserts for each item */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">boolean</span> ENABLE_BULK_INSERTS = <span class="keyword">true</span>;

<span class="keyword">public</span> <span class="keyword">void</span> scanDirectories(<span class="keyword">String</span>[] directories, <span class="keyword">String</span> volumeName) {
    <span class="keyword">try</span> {
        <span class="keyword">long</span> start = System.currentTimeMillis();
        initialize(volumeName);<span class="comment">//（1）初始化</span>
        prescan(<span class="keyword">null</span>, <span class="keyword">true</span>);<span class="comment">//（2）扫描前的预处理</span>
        <span class="keyword">long</span> prescan = System.currentTimeMillis();

        <span class="keyword">if</span> (ENABLE_BULK_INSERTS) {
            <span class="comment">//MediaInserter: A MediaScanner helper class which enables us to do lazy insertion on the given provider. This class manages buffers internally and flushes when they are full. Note that you should call flushAll() after using this class.</span>
            <span class="comment">// create MediaInserter for bulk inserts</span>
            mMediaInserter = <span class="keyword">new</span> MediaInserter(mMediaProvider, mPackageName, <span class="number">500</span>);
        }

        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; directories.length; i++) {
            <span class="comment">//processDirectory是一个native函数，调用它 扫描目标文件夹</span>
            <span class="comment">//mClient是MyMediaScannerClient类型，派生自MediaScannerClient，其作用后面再分析</span>
            processDirectory(directories[i], mClient);
        }

        <span class="keyword">if</span> (ENABLE_BULK_INSERTS) {
            <span class="comment">// flush remaining inserts</span>
            mMediaInserter.flushAll();
            mMediaInserter = <span class="keyword">null</span>;
        }

        <span class="keyword">long</span> scan = System.currentTimeMillis();
        postscan(directories);<span class="comment">//(4)扫描后 处理</span>
        <span class="keyword">long</span> end = System.currentTimeMillis();

        <span class="keyword">if</span> (<span class="keyword">false</span>) {
            Log.d(TAG, <span class="string">" prescan time: "</span> + (prescan - start) + <span class="string">"ms\n"</span>);
            Log.d(TAG, <span class="string">"    scan time: "</span> + (scan - prescan) + <span class="string">"ms\n"</span>);
            Log.d(TAG, <span class="string">"postscan time: "</span> + (end - scan) + <span class="string">"ms\n"</span>);
            Log.d(TAG, <span class="string">"   total time: "</span> + (end - start) + <span class="string">"ms\n"</span>);
        }
    } <span class="keyword">catch</span> (SQLException e) {
        <span class="comment">// this might happen if the SD card is removed while the media scanner is running</span>
        Log.e(TAG, <span class="string">"SQLException in MediaScanner.scan()"</span>, e);
    } <span class="keyword">catch</span> (UnsupportedOperationException e) {
        <span class="comment">// this might happen if the SD card is removed while the media scanner is running</span>
        Log.e(TAG, <span class="string">"UnsupportedOperationException in MediaScanner.scan()"</span>, e);
    } <span class="keyword">catch</span> (RemoteException e) {
        Log.e(TAG, <span class="string">"RemoteException in MediaScanner.scan()"</span>, e);
    } <span class="keyword">finally</span> {
        releaseResources();
    }
}
</code></pre><p><strong> （1）initialize分析 </strong><br>initialize主要是 初始化一些Uri<br>扫描时 需要把文件的信息 插入到媒体库中，媒体库中 针对 Video、Audio、Image文件有对应的表，表的地址由Uri表示。</p>
<pre><code><span class="keyword">private</span> <span class="literal">void</span> initialize(<span class="built_in">String</span> volumeName) {
    mMediaProvider = mContext<span class="built_in">.</span>getContentResolver()<span class="built_in">.</span>acquireProvider(<span class="string">"media"</span>);

    mAudioUri = Audio<span class="built_in">.</span>Media<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//音频表的地址，对应audio_meta表</span>
    mVideoUri = Video<span class="built_in">.</span>Media<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//视频表地址，对应video表</span>
    mImagesUri = Images<span class="built_in">.</span>Media<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//图片表地址，对应images表</span>
    mThumbsUri = Images<span class="built_in">.</span>Thumbnails<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//缩略图地址，对应thumbnails表</span>
    mFilesUri = Files<span class="built_in">.</span>getContentUri(volumeName);<span class="comment">//所有文件的地址，对应files表</span>
    mFilesUriNoNotify = mFilesUri<span class="built_in">.</span>buildUpon()<span class="built_in">.</span>appendQueryParameter(<span class="string">"nonotify"</span>, <span class="string">"1"</span>)<span class="built_in">.</span>build();

    <span class="keyword">if</span> (<span class="subst">!</span>volumeName<span class="built_in">.</span><span class="keyword">equals</span>(<span class="string">"internal"</span>)) {
        <span class="comment">//如果扫描的是 外部存储，支持 播放列表、音乐的流派等内容</span>
        <span class="comment">// we only support playlists on external media</span>
        mProcessPlaylists = <span class="literal">true</span>;
        mProcessGenres = <span class="literal">true</span>;
        mPlaylistsUri = Playlists<span class="built_in">.</span>getContentUri(volumeName);

        mCaseInsensitivePaths = <span class="literal">true</span>;<span class="comment">//Sd卡存储区域一般使用FAT文件系统，文件名与大小写无关</span>
    }
}
</code></pre><p><strong> （2）prescan分析 </strong><br>媒体扫描的问题：假设扫描之前SD卡有100个媒体文件，数据库中有100个关于文件的记录，因某种原因 删除了50个媒体文件，那么 数据库什么时候更新呢？</p>
<p>prescan函数的主要作用就是 在扫描之前 把数据库中 和文件关联的信息 取出并保存，这些信息主要是 媒体文件的路径 所属表的Uri。上边的例子，prescan会从数据库中 取出这100个文件 的文件信息。</p>
<pre><code><span class="keyword">private</span> <span class="keyword">void</span> prescan(<span class="keyword">String</span> filePath, <span class="built_in">boolean</span> prescanFiles) <span class="keyword">throws</span> RemoteException {
    Cursor c = <span class="keyword">null</span>;
    <span class="keyword">String</span> where = <span class="keyword">null</span>;
    <span class="keyword">String</span>[] selectionArgs = <span class="keyword">null</span>;

    <span class="comment">//保存从数据库中获取的文件信息</span>
    <span class="keyword">if</span> (mPlayLists == <span class="keyword">null</span>) {
        mPlayLists = <span class="keyword">new</span> ArrayList&lt;FileEntry&gt;();
    } <span class="keyword">else</span> {
        mPlayLists.<span class="built_in">clear</span>();
    }

    <span class="keyword">if</span> (filePath != <span class="keyword">null</span>) {
        <span class="comment">//查询file信息</span>
        <span class="comment">// query for only one file</span>
        where = MediaStore.Files.FileColumns._ID + <span class="string">"&gt;?"</span> +
            <span class="string">" AND "</span> + Files.FileColumns.DATA + <span class="string">"=?"</span>;
        selectionArgs = <span class="keyword">new</span> <span class="keyword">String</span>[] { <span class="string">""</span>, filePath };
    } <span class="keyword">else</span> {
        where = MediaStore.Files.FileColumns._ID + <span class="string">"&gt;?"</span>;
        selectionArgs = <span class="keyword">new</span> <span class="keyword">String</span>[] { <span class="string">""</span> };
    }

    <span class="comment">// Tell the provider to not delete the file.</span>
    <span class="comment">// If the file is truly gone the delete is unnecessary, and we want to avoid</span>
    <span class="comment">// accidentally deleting files that are really there (this may happen if the</span>
    <span class="comment">// filesystem is mounted and unmounted while the scanner is running).</span>
    Uri.Builder builder = mFilesUri.buildUpon();
    builder.appendQueryParameter(MediaStore.PARAM_DELETE_DATA, <span class="string">"false"</span>);
    MediaBulkDeleter deleter = <span class="keyword">new</span> MediaBulkDeleter(mMediaProvider, mPackageName,
            builder.build());

    <span class="comment">// Build the list of files from the content provider</span>
    <span class="keyword">try</span> {
        <span class="keyword">if</span> (prescanFiles) {
            <span class="comment">// First read existing files from the files table.</span>
            <span class="comment">// Because we'll be deleting entries for missing files as we go,</span>
            <span class="comment">// we need to query the database in small batches, to avoid problems</span>
            <span class="comment">// with CursorWindow positioning.</span>
            <span class="keyword">long</span> lastId = Long.MIN_VALUE;
            Uri limitUri = mFilesUri.buildUpon().appendQueryParameter(<span class="string">"limit"</span>, <span class="string">"1000"</span>).build();
            mWasEmptyPriorToScan = <span class="keyword">true</span>;

            <span class="keyword">while</span> (<span class="keyword">true</span>) {
                selectionArgs[<span class="number">0</span>] = <span class="string">""</span> + lastId;
                <span class="keyword">if</span> (c != <span class="keyword">null</span>) {
                    c.close();
                    c = <span class="keyword">null</span>;
                }
                <span class="comment">//查询files信息</span>
                c = mMediaProvider.query(mPackageName, limitUri, FILES_PRESCAN_PROJECTION,
                        where, selectionArgs, MediaStore.Files.FileColumns._ID, <span class="keyword">null</span>);
                <span class="keyword">if</span> (c == <span class="keyword">null</span>) {
                    <span class="keyword">break</span>;
                }

                <span class="built_in">int</span> num = c.getCount();

                <span class="keyword">if</span> (num == <span class="number">0</span>) {
                    <span class="keyword">break</span>;
                }
                mWasEmptyPriorToScan = <span class="keyword">false</span>;
                <span class="keyword">while</span> (c.moveToNext()) {
                    <span class="keyword">long</span> rowId = c.getLong(FILES_PRESCAN_ID_COLUMN_INDEX);
                    <span class="keyword">String</span> path = c.getString(FILES_PRESCAN_PATH_COLUMN_INDEX);<span class="comment">//查询文件路径</span>
                    <span class="built_in">int</span> format = c.getInt(FILES_PRESCAN_FORMAT_COLUMN_INDEX);
                    <span class="keyword">long</span> lastModified = c.getLong(FILES_PRESCAN_DATE_MODIFIED_COLUMN_INDEX);
                    lastId = rowId;

                    <span class="comment">// Only consider entries with absolute path names.</span>
                    <span class="comment">// This allows storing URIs in the database without the</span>
                    <span class="comment">// media scanner removing them.</span>
                    <span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; path.startsWith(<span class="string">"/"</span>)) {
                        <span class="built_in">boolean</span> exists = <span class="keyword">false</span>;
                        <span class="keyword">try</span> {
                            exists = Os.access(path, android.system.OsConstants.F_OK);
                        } <span class="keyword">catch</span> (ErrnoException e1) {
                        }
                        <span class="keyword">if</span> (!exists &amp;&amp; !MtpConstants.isAbstractObject(format)) {
                            <span class="comment">// do not delete missing playlists, since they may have been</span>
                            <span class="comment">// modified by the user.</span>
                            <span class="comment">// The user can delete them in the media player instead.</span>
                            <span class="comment">// instead, clear the path and lastModified fields in the row</span>
                            MediaFile.MediaFileType mediaFileType = MediaFile.getFileType(path);
                            <span class="built_in">int</span> fileType = (mediaFileType == <span class="keyword">null</span> ? <span class="number">0</span> : mediaFileType.fileType);

                            <span class="keyword">if</span> (!MediaFile.isPlayListFileType(fileType)) {
                                deleter.delete(rowId);
                                <span class="keyword">if</span> (path.toLowerCase(Locale.US).endsWith(<span class="string">"/.nomedia"</span>)) {
                                    deleter.flush();
                                    <span class="keyword">String</span> parent = <span class="keyword">new</span> File(path).getParent();
                                    mMediaProvider.call(mPackageName, MediaStore.UNHIDE_CALL,
                                            parent, <span class="keyword">null</span>);
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    <span class="keyword">finally</span> {
        <span class="keyword">if</span> (c != <span class="keyword">null</span>) {
            c.close();
        }
        deleter.flush();
    }

    <span class="comment">// compute original size of images</span>
    mOriginalCount = <span class="number">0</span>;
    c = mMediaProvider.query(mPackageName, mImagesUri, ID_PROJECTION, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);
    <span class="keyword">if</span> (c != <span class="keyword">null</span>) {
        mOriginalCount = c.getCount();
        c.close();
    }
}
</code></pre><p><strong> （3）processDirectory 和 postscan分析 </strong></p>
<pre><code><span class="keyword">private</span> <span class="keyword">native</span> <span class="function"><span class="keyword">void</span> <span class="title">processDirectory</span><span class="params">(String path, MediaScannerClient client)</span></span>;


<span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">postscan</span><span class="params">(String[] directories)</span> <span class="keyword">throws</span> RemoteException </span>{

    <span class="comment">// handle playlists last, after we know what media files are on the storage.</span>
    <span class="keyword">if</span> (mProcessPlaylists) {
        processPlayLists();
    }

    <span class="keyword">if</span> (mOriginalCount == <span class="number">0</span> &amp;&amp; mImagesUri.equals(Images.Media.getContentUri(<span class="string">"external"</span>)))
        pruneDeadThumbnailFiles();

    <span class="comment">// allow GC to clean up</span>
    mPlayLists = <span class="keyword">null</span>;
    mMediaProvider = <span class="keyword">null</span>;
}
</code></pre><p>processDirectory是一个native函数，JNI层实现。processDirectory扫描SD卡</p>
<pre><code><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">processPlayLists</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>{
    Iterator&lt;FileEntry&gt; iterator = mPlayLists.iterator();
    Cursor fileList = <span class="keyword">null</span>;
    <span class="keyword">try</span> {
        <span class="comment">// use the files uri and projection because we need the format column,</span>
        <span class="comment">// but restrict the query to just audio files</span>
        fileList = mMediaProvider.query(mPackageName, mFilesUri, FILES_PRESCAN_PROJECTION,
                <span class="string">"media_type=2"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);
        <span class="keyword">while</span> (iterator.hasNext()) {
            FileEntry entry = iterator.next();
            <span class="comment">// only process playlist files if they are new or have been modified since the last scan</span>
            <span class="keyword">if</span> (entry.mLastModifiedChanged) {
                processPlayList(entry, fileList);
            }
        }
    } <span class="keyword">catch</span> (RemoteException e1) {
    } <span class="keyword">finally</span> {
        <span class="keyword">if</span> (fileList != <span class="keyword">null</span>) {
            fileList.close();
        }
    }
}


<span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">processPlayList</span><span class="params">(FileEntry entry, Cursor fileList)</span> <span class="keyword">throws</span> RemoteException </span>{
    String path = entry.mPath;
    ContentValues values = <span class="keyword">new</span> ContentValues();
    <span class="keyword">int</span> lastSlash = path.lastIndexOf(<span class="string">'/'</span>);
    <span class="keyword">if</span> (lastSlash &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"bad path "</span> + path);
    Uri uri, membersUri;
    <span class="keyword">long</span> rowId = entry.mRowId;

    <span class="comment">// make sure we have a name</span>
    String name = values.getAsString(MediaStore.Audio.Playlists.NAME);
    <span class="keyword">if</span> (name == <span class="keyword">null</span>) {
        name = values.getAsString(MediaStore.MediaColumns.TITLE);
        <span class="keyword">if</span> (name == <span class="keyword">null</span>) {
            <span class="comment">// extract name from file name</span>
            <span class="keyword">int</span> lastDot = path.lastIndexOf(<span class="string">'.'</span>);
            name = (lastDot &lt; <span class="number">0</span> ? path.substring(lastSlash + <span class="number">1</span>)
                    : path.substring(lastSlash + 1, lastDot));
        }
    }

    values.put(MediaStore.Audio.Playlists.NAME, name);
    values.put(MediaStore.Audio.Playlists.DATE_MODIFIED, entry.mLastModified);

    <span class="keyword">if</span> (rowId == <span class="number">0</span>) {
        values.put(MediaStore.Audio.Playlists.DATA, path);
        uri = mMediaProvider.insert(mPackageName, mPlaylistsUri, values);
        rowId = ContentUris.parseId(uri);
        membersUri = Uri.withAppendedPath(uri, Playlists.Members.CONTENT_DIRECTORY);
    } <span class="keyword">else</span> {
        uri = ContentUris.withAppendedId(mPlaylistsUri, rowId);
        mMediaProvider.update(mPackageName, uri, values, <span class="keyword">null</span>, <span class="keyword">null</span>);

        <span class="comment">// delete members of existing playlist</span>
        membersUri = Uri.withAppendedPath(uri, Playlists.Members.CONTENT_DIRECTORY);
        mMediaProvider.delete(mPackageName, membersUri, <span class="keyword">null</span>, <span class="keyword">null</span>);
    }

    String playListDirectory = path.substring(<span class="number">0</span>, lastSlash + <span class="number">1</span>);
    MediaFile.MediaFileType mediaFileType = MediaFile.getFileType(path);
    <span class="keyword">int</span> fileType = (mediaFileType == <span class="keyword">null</span> ? <span class="number">0</span> : mediaFileType.fileType);

    <span class="keyword">if</span> (fileType == MediaFile.FILE_TYPE_M3U) {
        processM3uPlayList(path, playListDirectory, membersUri, values, fileList);
    } <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(fileType == MediaFile.FILE_TYPE_PLS)</span> </span>{
        processPlsPlayList(path, playListDirectory, membersUri, values, fileList);
    } <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(fileType == MediaFile.FILE_TYPE_WPL)</span> </span>{
        processWplPlayList(path, playListDirectory, membersUri, values, fileList);
    }
}
</code></pre><h2 id="3-2_JNI层">3.2 JNI层</h2><h3 id="3-2-1_native_init">3.2.1 native_init</h3><p>MediaScanner的static块中调用</p>
<pre><code><span class="comment">// This function gets a field ID, which in turn causes class initialization.</span>
<span class="comment">// It is called from a static block in MediaScanner, which won't run until the</span>
<span class="comment">// first time an instance of this class is used.</span>
<span class="function"><span class="keyword">static</span> <span class="keyword">void</span>
<span class="title">android_media_MediaScanner_native_init</span><span class="params">(JNIEnv *env)</span>
</span>{
    ALOGV(<span class="string">"native_init"</span>);
    jclass clazz = env-&gt;FindClass(kClassMediaScanner);
    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>) {
           <span class="keyword">return</span>;
    }

    <span class="comment">//取得Java层MediaScanner类的mNativeContext信息，Native对象的指针保存到Java层MediaScanner对象的mNativeContext中</span>
    fields.context = env-&gt;GetFieldID(clazz, <span class="string">"mNativeContext"</span>, <span class="string">"J"</span>);
    <span class="keyword">if</span> (fields.context == <span class="literal">NULL</span>) {
        <span class="keyword">return</span>;
    }
}
</code></pre><h3 id="3-2-2_native_setup">3.2.2 native_setup</h3><pre><code>static void
android_media_MediaScanner_native_setup<span class="list">(<span class="keyword">JNIEnv</span> <span class="variable">*env, jobject thiz)
{
    ALOGV("native_setup");
    MediaScanner *</span>mp = new StagefrightMediaScanner<span class="comment">;//创建Native层的MediaScanner对象</span>

    if <span class="list">(<span class="keyword">mp</span> == NULL)</span> {
        jniThrowException<span class="list">(<span class="keyword">env</span>, kRunTimeException, <span class="string">"Out of memory"</span>)</span><span class="comment">;</span>
        return<span class="comment">;</span>
    }

    env-&gt;SetLongField<span class="list">(<span class="keyword">thiz</span>, fields.context, <span class="list">(<span class="keyword">jlong</span>)</span>mp)</span><span class="comment">;</span>
}</span>
</code></pre><h3 id="3-2-3_processDirectory">3.2.3 processDirectory</h3><pre><code><span class="keyword">static</span> <span class="type">void</span>
android_media_MediaScanner_processDirectory(
        <span class="type">JNIEnv</span> *env, jobject thiz, jstring path, jobject client)
{
    <span class="type">ALOGV</span>(<span class="string">"processDirectory"</span>);
    <span class="type">MediaScanner</span> *mp = getNativeScanner_l(env, thiz);
    <span class="keyword">if</span> (mp == <span class="type">NULL</span>) {
        jniThrowException(env, kRunTimeException, <span class="string">"No scanner available"</span>);
        <span class="keyword">return</span>;
    }

    <span class="keyword">if</span> (path == <span class="type">NULL</span>) {
        jniThrowException(env, kIllegalArgumentException, <span class="type">NULL</span>);
        <span class="keyword">return</span>;
    }

    <span class="keyword">const</span> <span class="type">char</span> *pathStr = env-&gt;<span class="type">GetStringUTFChars</span>(path, <span class="type">NULL</span>);
    <span class="keyword">if</span> (pathStr == <span class="type">NULL</span>) {  // <span class="type">Out</span> <span class="keyword">of</span> memory
        <span class="keyword">return</span>;
    }

    //构造<span class="type">Native</span>层的<span class="type">MyMediaScannerClient</span>，并使用<span class="type">Java</span>层的<span class="type">Client</span>对象做参数
    <span class="type">MyMediaScannerClient</span> myClient(env, client);
    <span class="type">MediaScanResult</span> <span class="literal">result</span> = mp-&gt;processDirectory(pathStr, myClient);//调用<span class="type">Native</span>层的<span class="type">MediaScanner</span>扫描文件夹，并把<span class="type">Native</span>的<span class="type">MyMediaScannerClient</span>传进去
    <span class="keyword">if</span> (<span class="literal">result</span> == <span class="type">MEDIA_SCAN_RESULT_ERROR</span>) {
        <span class="type">ALOGE</span>(<span class="string">"An error occurred while scanning directory '%s'."</span>, pathStr);
    }
    env-&gt;<span class="type">ReleaseStringUTFChars</span>(path, pathStr);
}
</code></pre><p>frameworks/av/media/libmedia/MediaScanner.cpp</p>
<pre><code><span class="type">MediaScanResult</span> <span class="type">MediaScanner</span>::processDirectory(
        <span class="keyword">const</span> <span class="type">char</span> *path, <span class="type">MediaScannerClient</span> &amp;client) {
     ……
    client.setLocale(locale());//给<span class="type">Native</span>的<span class="type">MyMediaScannerClient</span>设置local信息

    <span class="type">MediaScanResult</span> <span class="literal">result</span> = doProcessDirectory(pathBuffer, pathRemaining, client, <span class="literal">false</span>);//调用doProcessDirectory扫描文件夹

    free(pathBuffer);

    <span class="keyword">return</span> <span class="literal">result</span>;
}



<span class="type">MediaScanResult</span> <span class="type">MediaScanner</span>::doProcessDirectory(
        <span class="type">char</span> *path, <span class="type">int</span> pathRemaining, <span class="type">MediaScannerClient</span> &amp;client, <span class="type">bool</span> noMedia) {
    ……//忽略.nomedia文件夹

    <span class="type">DIR</span>* dir = opendir(path);
    <span class="keyword">if</span> (!dir) {
        <span class="type">ALOGW</span>(<span class="string">"Error opening directory '%s', skipping: %s."</span>, path, strerror(errno));
        <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_SKIPPED</span>;
    }

    <span class="type">MediaScanResult</span> <span class="literal">result</span> = <span class="type">MEDIA_SCAN_RESULT_OK</span>;
    <span class="keyword">while</span> ((entry = readdir(dir))) {
        <span class="keyword">if</span> (doProcessDirectoryEntry(path, pathRemaining, client, noMedia, entry, fileSpot)
                == <span class="type">MEDIA_SCAN_RESULT_ERROR</span>) {
            <span class="literal">result</span> = <span class="type">MEDIA_SCAN_RESULT_ERROR</span>;
            <span class="keyword">break</span>;
        }
    }
    closedir(dir);
    <span class="keyword">return</span> <span class="literal">result</span>;
}



<span class="type">MediaScanResult</span> <span class="type">MediaScanner</span>::doProcessDirectoryEntry(
        <span class="type">char</span> *path, <span class="type">int</span> pathRemaining, <span class="type">MediaScannerClient</span> &amp;client, <span class="type">bool</span> noMedia,
        struct dirent* entry, <span class="type">char</span>* fileSpot) {
    struct stat statbuf;
    <span class="keyword">const</span> <span class="type">char</span>* name = entry-&gt;d_name;//枚举目录中的文件和子文件夹信息

    // ignore <span class="string">"."</span> <span class="keyword">and</span> <span class="string">".."</span>
    <span class="keyword">if</span> (name[<span class="number">0</span>] == '.' &amp;&amp; (name[<span class="number">1</span>] == <span class="number">0</span> || (name[<span class="number">1</span>] == '.' &amp;&amp; name[<span class="number">2</span>] == <span class="number">0</span>))) {
        <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_SKIPPED</span>;
    }

    <span class="type">int</span> nameLength = strlen(name);
    <span class="keyword">if</span> (nameLength + <span class="number">1</span> &gt; pathRemaining) {
        // path too long!
        <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_SKIPPED</span>;
    }
    strcpy(fileSpot, name);

    <span class="type">int</span> <span class="keyword">type</span> = entry-&gt;d_type;
    <span class="keyword">if</span> (<span class="keyword">type</span> == <span class="type">DT_UNKNOWN</span>) {
        // <span class="type">If</span> the <span class="keyword">type</span> <span class="keyword">is</span> unknown, stat() the file instead.
        // <span class="type">This</span> <span class="keyword">is</span> sometimes necessary <span class="keyword">when</span> accessing <span class="type">NFS</span> mounted filesystems, but
        // could be needed <span class="keyword">in</span> other cases well.
        <span class="keyword">if</span> (stat(path, &amp;statbuf) == <span class="number">0</span>) {
            <span class="keyword">if</span> (<span class="type">S_ISREG</span>(statbuf.st_mode)) {
                <span class="keyword">type</span> = <span class="type">DT_REG</span>;
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">S_ISDIR</span>(statbuf.st_mode)) {
                <span class="keyword">type</span> = <span class="type">DT_DIR</span>;
            }
        } <span class="keyword">else</span> {
            <span class="type">ALOGD</span>(<span class="string">"stat() failed for %s: %s"</span>, path, strerror(errno) );
        }
    }
    <span class="keyword">if</span> (<span class="keyword">type</span> == <span class="type">DT_DIR</span>) {
        //文件夹
        <span class="type">bool</span> childNoMedia = noMedia;
        // <span class="type">set</span> noMedia flag on directories <span class="keyword">with</span> a name that starts <span class="keyword">with</span> '.'
        // <span class="keyword">for</span> example, the <span class="type">Mac</span> <span class="string">".Trashes"</span> directory
        <span class="keyword">if</span> (name[<span class="number">0</span>] == '.')
            childNoMedia = <span class="literal">true</span>;

        // report the directory to the client
        <span class="keyword">if</span> (stat(path, &amp;statbuf) == <span class="number">0</span>) {
            status_t status = client.scanFile(path, statbuf.st_mtime, <span class="number">0</span>,
                    <span class="literal">true</span> /*isDirectory*/, childNoMedia);
            <span class="keyword">if</span> (status) {
                <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_ERROR</span>;
            }
        }

        // <span class="keyword">and</span> now process its contents
        strcat(fileSpot, <span class="string">"/"</span>);
        //如果是子文件夹，递归调用doProcessDirectory
        <span class="type">MediaScanResult</span> <span class="literal">result</span> = doProcessDirectory(path, pathRemaining - nameLength - <span class="number">1</span>,
                client, childNoMedia);
        <span class="keyword">if</span> (<span class="literal">result</span> == <span class="type">MEDIA_SCAN_RESULT_ERROR</span>) {
            <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_ERROR</span>;
        }
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">type</span> == <span class="type">DT_REG</span>) {
        stat(path, &amp;statbuf);//取出文件修改时间和大小
        status_t status = client.scanFile(path, statbuf.st_mtime, statbuf.st_size,
                <span class="literal">false</span> /*isDirectory*/, noMedia);//调用<span class="type">MyMediaScannerClient</span>的scanFile函数
        <span class="keyword">if</span> (status) {
            <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_ERROR</span>;
        }
    }

    <span class="keyword">return</span> <span class="type">MEDIA_SCAN_RESULT_OK</span>;
}
</code></pre><h3 id="3-2-4_MyMediaScannerClient的scanFile分析">3.2.4 MyMediaScannerClient的scanFile分析</h3><p>(1)JNI层的scanFile<br>android_media_MediaScanner.cpp</p>
<pre><code>virtual status_t scanFile(<span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">long</span> <span class="keyword">long</span> lastModified,
        <span class="keyword">long</span> <span class="keyword">long</span> fileSize, <span class="keyword">bool</span> isDirectory, <span class="keyword">bool</span> noMedia)
{
    ALOGV(<span class="string">"scanFile: path(%s), time(%lld), size(%lld) and isDir(%d)"</span>,
        path, lastModified, fileSize, isDirectory);

    jstring pathStr;
    <span class="keyword">if</span> ((pathStr = mEnv-&gt;NewStringUTF(path)) == <span class="keyword">NULL</span>) {
        mEnv-&gt;ExceptionClear();
        <span class="keyword">return</span> NO_MEMORY;
    }
    <span class="comment">//mClient是Java层的MyMediaScannerClient对象，调用其scanFile函数</span>
    mEnv-&gt;CallVoidMethod(mClient, mScanFileMethodID, pathStr, lastModified,
            fileSize, isDirectory, noMedia);

    mEnv-&gt;DeleteLocalRef(pathStr);
    <span class="keyword">return</span> checkAndClearExceptionFromCallback(mEnv, <span class="string">"scanFile"</span>);
}
</code></pre><p>(2)Java层的scanFile函数</p>
<pre><code>    @Override
    <span class="keyword">public</span> <span class="keyword">void</span> scanFile(<span class="keyword">String</span> path, <span class="keyword">long</span> lastModified, <span class="keyword">long</span> fileSize,
            <span class="built_in">boolean</span> isDirectory, <span class="built_in">boolean</span> noMedia) {
        <span class="comment">// This is the callback funtion from native codes.</span>
        <span class="comment">// Log.v(TAG, "scanFile: "+path);</span>
        doScanFile(path, <span class="keyword">null</span>, lastModified, fileSize, isDirectory, <span class="keyword">false</span>, noMedia);<span class="comment">//调用doScanFile函数</span>
    }



    <span class="keyword">public</span> Uri doScanFile(<span class="keyword">String</span> path, <span class="keyword">String</span> mimeType, <span class="keyword">long</span> lastModified,
            <span class="keyword">long</span> fileSize, <span class="built_in">boolean</span> isDirectory, <span class="built_in">boolean</span> scanAlways, <span class="built_in">boolean</span> noMedia) {
        <span class="comment">//scanAlways：是否强制扫描。有时候有些文件 在两次扫描过程中没有发生变化，MediaScanner可以不处理这些文件。scanAlways为true，则文件没有变化也要扫描</span>
        Uri result = <span class="keyword">null</span>;
<span class="comment">//        long t1 = System.currentTimeMillis();</span>
        <span class="keyword">try</span> {
            <span class="comment">//beginFile根据lastModified值，判断这个文件在两次扫描的时间段内 是否有修改，如果有修改，则需要重新扫描</span>
            FileEntry entry = beginFile(path, mimeType, lastModified,
                    fileSize, isDirectory, noMedia);

            <span class="comment">// if this file was just inserted via mtp, set the rowid to zero</span>
            <span class="comment">// (even though it already exists in the database), to trigger</span>
            <span class="comment">// the correct code path for updating its entry</span>
            <span class="keyword">if</span> (mMtpObjectHandle != <span class="number">0</span>) {
                entry.mRowId = <span class="number">0</span>;
            }
            <span class="comment">// rescan for metadata if file was modified since last scan</span>
            <span class="keyword">if</span> (entry != <span class="keyword">null</span> &amp;&amp; (entry.mLastModifiedChanged || scanAlways)) {
                <span class="keyword">if</span> (noMedia) {
                    result = endFile(entry, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);
                } <span class="keyword">else</span> {
                    <span class="keyword">String</span> lowpath = path.toLowerCase(Locale.ROOT);
                    <span class="built_in">boolean</span> ringtones = (lowpath.indexOf(RINGTONES_DIR) &gt; <span class="number">0</span>);
                    <span class="built_in">boolean</span> notifications = (lowpath.indexOf(NOTIFICATIONS_DIR) &gt; <span class="number">0</span>);
                    <span class="built_in">boolean</span> alarms = (lowpath.indexOf(ALARMS_DIR) &gt; <span class="number">0</span>);
                    <span class="built_in">boolean</span> podcasts = (lowpath.indexOf(PODCAST_DIR) &gt; <span class="number">0</span>);
                    <span class="built_in">boolean</span> music = (lowpath.indexOf(MUSIC_DIR) &gt; <span class="number">0</span>) ||
                        (!ringtones &amp;&amp; !notifications &amp;&amp; !alarms &amp;&amp; !podcasts);

                    <span class="built_in">boolean</span> isaudio = MediaFile.isAudioFileType(mFileType);
                    <span class="built_in">boolean</span> isvideo = MediaFile.isVideoFileType(mFileType);
                    <span class="built_in">boolean</span> isimage = MediaFile.isImageFileType(mFileType);

                    <span class="keyword">if</span> (isaudio || isvideo || isimage) {
                        path = Environment.maybeTranslateEmulatedPathToInternal(<span class="keyword">new</span> File(path))
                                .getAbsolutePath();
                    }

                    <span class="comment">// we only extract metadata for audio and video files</span>
                    <span class="keyword">if</span> (isaudio || isvideo) {
                        processFile(path, mimeType, <span class="keyword">this</span>);<span class="comment">//native方法</span>
                    }

                    <span class="keyword">if</span> (isimage) {
                        processImageFile(path);
                    }

                    result = endFile(entry, ringtones, notifications, alarms, music, podcasts);<span class="comment">//扫描完成后，需要把新的信息插入数据库，或者要将原有的信息更新</span>
                }
            }
        } <span class="keyword">catch</span> (RemoteException e) {
            Log.e(TAG, <span class="string">"RemoteException in MediaScanner.scanFile()"</span>, e);
        }
<span class="comment">//        long t2 = System.currentTimeMillis();</span>
<span class="comment">//        Log.v(TAG, "scanFile: " + path + " took " + (t2-t1));</span>
        <span class="keyword">return</span> result;
    }
</code></pre><p>(3)JNI层的processFile分析</p>
<pre><code>static void
android_media_MediaScanner_processFile<span class="list">(
        <span class="keyword">JNIEnv</span> <span class="variable">*env, jobject thiz, jstring path,
        jstring mimeType, jobject client)
{
    ALOGV("processFile");

    // Lock already hold by processDirectory
    MediaScanner *</span>mp = getNativeScanner_l<span class="list">(<span class="keyword">env</span>, thiz)</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">mp</span> == NULL)</span> {
        jniThrowException<span class="list">(<span class="keyword">env</span>, kRunTimeException, <span class="string">"No scanner available"</span>)</span><span class="comment">;</span>
        return<span class="comment">;</span>
    }

    if <span class="list">(<span class="keyword">path</span> == NULL)</span> {
        jniThrowException<span class="list">(<span class="keyword">env</span>, kIllegalArgumentException, NULL)</span><span class="comment">;</span>
        return<span class="comment">;</span>
    }

    const char <span class="variable">*pathStr = env-&gt;GetStringUTFChars(path, NULL);
    if (pathStr == NULL) {  // Out of memory
        return;
    }

    const char *</span>mimeTypeStr =
        <span class="list">(<span class="keyword">mimeType</span> ? env-&gt;GetStringUTFChars<span class="list">(<span class="keyword">mimeType</span>, NULL)</span> : NULL)</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">mimeType</span> <span class="keyword">&amp;&amp;</span> mimeTypeStr == NULL)</span> {  // Out of memory
        // ReleaseStringUTFChars can be called with an exception pending.
        env-&gt;ReleaseStringUTFChars<span class="list">(<span class="keyword">path</span>, pathStr)</span><span class="comment">;</span>
        return<span class="comment">;</span>
    }

    MyMediaScannerClient myClient<span class="list">(<span class="keyword">env</span>, client)</span><span class="comment">;</span>
    MediaScanResult result = mp-&gt;processFile<span class="list">(<span class="keyword">pathStr</span>, mimeTypeStr, myClient)</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">result</span> == MEDIA_SCAN_RESULT_ERROR)</span> {
        ALOGE<span class="list">(<span class="string">"An error occurred while scanning file '%s'."</span>, pathStr)</span><span class="comment">;</span>
    }
    env-&gt;ReleaseStringUTFChars<span class="list">(<span class="keyword">path</span>, pathStr)</span><span class="comment">;</span>
    if <span class="list">(<span class="keyword">mimeType</span>)</span> {
        env-&gt;ReleaseStringUTFChars<span class="list">(<span class="keyword">mimeType</span>, mimeTypeStr)</span><span class="comment">;</span>
    }
}</span>
</code></pre><p>frameworks/av/media/libstagefright/StagefrightMediaScanner.cpp</p>
<pre><code><span class="type">MediaScanResult</span> <span class="type">StagefrightMediaScanner</span>::processFile(
        <span class="keyword">const</span> <span class="type">char</span> *path, <span class="keyword">const</span> <span class="type">char</span> *mimeType,
        <span class="type">MediaScannerClient</span> &amp;client) {
    <span class="type">ALOGV</span>(<span class="string">"processFile '%s'."</span>, path);

    client.setLocale(locale());
    client.beginFile();
    <span class="type">MediaScanResult</span> <span class="literal">result</span> = processFileInternal(path, mimeType, client);
    client.endFile();
    <span class="keyword">return</span> <span class="literal">result</span>;
}
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/02/framework-MediaScanner/" data-id="cisvpt2rx000u0ko03i8ic397" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/framework/">framework</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-数据结构3-树-上-——3-1-树与树的表示" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/02/数据结构3-树-上-——3-1-树与树的表示/" class="article-date">
  <time datetime="2015-12-02T02:01:52.000Z" itemprop="datePublished">2015-12-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/02/数据结构3-树-上-——3-1-树与树的表示/">数据结构3-树(上)——3-1-树与树的表示</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="3-1_树与树的表示">3.1 树与树的表示</h1><h2 id="3-1-1什么是树">3.1.1什么是树</h2><p>客观世界中 许多事物 存在的 层次关系</p>
<ul>
<li>家谱</li>
<li>社会组织结构</li>
<li>图书信息管理</li>
</ul>
<p>分层次组织 在管理上 具有更高的效率。</p>
<h2 id="查找">查找</h2><p>查找： 根据 关键字K，从 集合R中 找出与K相同的记录</p>
<ul>
<li>静态查找：集合中 记录是固定的<ul>
<li>没有插入和删除操作，只有查找</li>
<li>举例：查字典</li>
</ul>
</li>
<li>动态查找： 集合中 记录是动态变化的<ul>
<li>除查找，还可以 插入和删除</li>
</ul>
</li>
</ul>
<h2 id="静态查找">静态查找</h2><h3 id="方法1：顺序查找">方法1：顺序查找</h3><pre><code><span class="keyword">int</span> SequentialSearch(StaticTable *Tbl, ElementType K){
    <span class="comment">//在表Tbl[1]-Tbl[n]中查找关键字为K的元素</span>
    <span class="keyword">int</span> i;
    Tbl-&gt;Element[<span class="number">0</span>] = K;<span class="comment">//建立哨兵</span>
    <span class="keyword">for</span>(i = Tbl-&gt;Length; Tbl-&gt;Element[i] != K; i--);
    <span class="keyword">return</span> i;<span class="comment">//找不到返回0</span>
}
</code></pre><p>//数据从1开始存储，时间复杂度O(n)</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/d5b1cc1c621830d978ae1b046cc820a0ec0bde80/201512/%E9%A1%BA%E5%BA%8F%E6%9F%A5%E6%89%BE.PNG" alt="顺序查找"></p>
<p><strong> 顺序查找的另一种实现：不用哨兵 </strong></p>
<pre><code><span class="built_in">int</span> SequentailSearch(StaticTable *Tbl, ElementType K){
    <span class="built_in">int</span> i<span class="comment">;</span>
    <span class="keyword">for</span>(i = Tbl-&gt;Length<span class="comment">; i&gt;0 &amp;&amp; Tbl-&gt;Element[i]!=K; i--);</span>
    <span class="keyword">return</span> i<span class="comment">;</span>
} 
</code></pre><h2 id="3-1-2_方法2：二分查找">3.1.2 方法2：二分查找</h2><p>假设n个数据元素时有序的：<br>    K1 &lt; K2 &lt; … &lt; Kn<br>并且 连续存放（数组），可以进行二分查找。</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/481c80d2db16be5cf93e1eb25728031b295736b3/201512/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E4%B8%BE%E4%BE%8B.PNG" alt="二分查找举例"></p>
<h2 id="3-1-3_二分查找_代码实现">3.1.3 二分查找 代码实现</h2><pre><code>int <span class="type">BinarySearch</span>(<span class="type">StaticTable</span> *<span class="type">Tbl</span>, <span class="type">ElementType</span> <span class="type">K</span>){
    <span class="comment">//在表Tbl中查找K</span>
    int <span class="keyword">left</span>, <span class="keyword">right</span>, mid, <span class="type">NoFound</span> = -<span class="number">1</span>;

    <span class="keyword">left</span> = <span class="number">1</span>;<span class="comment">//初始左边界</span>
    <span class="keyword">right</span> = <span class="type">Tbl</span>-&gt;<span class="type">Length</span>;<span class="comment">//初始右边界</span>
    <span class="keyword">while</span>(<span class="keyword">left</span> &lt;= <span class="keyword">right</span>){
        mid = (<span class="keyword">left</span> + <span class="keyword">right</span>) / <span class="number">2</span>;<span class="comment">//计算中间坐标</span>
        <span class="keyword">if</span>(<span class="type">K</span> &lt; <span class="type">Tbl</span>-&gt;<span class="type">Element</span>[mid]){
            <span class="keyword">right</span> = mid - <span class="number">1</span>;<span class="comment">//调整右边界</span>
        } <span class="keyword">else</span> <span class="keyword">if</span>(<span class="type">K</span> &gt; <span class="type">Tbl</span>-&gt;<span class="type">Element</span>[mid]){
            <span class="keyword">left</span> = mid + <span class="number">1</span>;<span class="comment">//调整左边界</span>
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> mid;
        }
    }
    <span class="keyword">return</span> <span class="type">NotFound</span>;<span class="comment">//查找不成功，返回-1</span>
}
</code></pre><p>二分查找的 时间复杂度O(logN)</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/b6a841cd9f31188ed06fc23784503b1b1295673c/201512/%E5%88%A4%E5%AE%9A%E6%A0%91.PNG" alt="判定树"></p>
<h2 id="3-1-4_树的定义">3.1.4 树的定义</h2><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/9092a46a668c1b08c73485b36ec8387f69408e80/201512/%E6%A0%91%E7%9A%84%E5%AE%9A%E4%B9%89.PNG" alt="树的定义"></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/fb3108289afb901f102b5a04bbf23625becb91a7/201512/%E6%A0%91%E4%B8%8E%E9%9D%9E%E6%A0%91.PNG" alt="树与非树"></p>
<h3 id="树的术语">树的术语</h3><ul>
<li>1.结点的度（Degree）：结点的子树个数</li>
<li>2.树的度：树的所有结点中 最大的度数</li>
<li>3.叶结点（Leaf）：度为0 的点，没有子树 的点</li>
<li>4.父结点（Parent）：有子树的结点 是其子树 的根结点 的父结点</li>
<li>5.子结点（Child）：若A结点是B结点的父结点，则称 B结点 是A结点 的子结点；子结点 也称 孩子结点</li>
<li>6.兄弟结点（Sibling）：具有 同一父结点 的各结点 彼此是 兄弟结点。</li>
<li>7.路径和 路径长度：从 结点n1到nk的路径 为 一个结点序列n1，n2，…，nk， ni是ni+1的父结点。路径 所包含的个数 为 路径长度</li>
<li>8.祖先结点（Ancestor）：沿 树根 到某一结点 路径上 的所以结点 都是 这个结点 的祖先结点</li>
<li>9.子孙结点（Descendant）：某一结点 的子树 中的 所有结点 是这个结点的子孙</li>
<li>10.结点的层次（Level）：规定 根结点在1层，其他 任一结点的层数 是其 父结点 的层数+1</li>
<li>11.树的深度（Depth）：树中所有结点中 的最大层次 是这棵树的 深度。</li>
</ul>
<h2 id="3-1-5_树的表示">3.1.5 树的表示</h2><p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/90438b87d183998de2ce8be0e50a14382013674e/201512/%E6%A0%91%E7%9A%84%E8%A1%A8%E7%A4%BA1.PNG" alt="树的表示1"></p>
<p><strong> 方式1：数组 </strong><br>数组 表示不了 谁是谁的父结点</p>
<p><strong> 方式二：链表 </strong></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/dc9e459ca97f628e6c57a33a48604119a8ba69ee/201512/%E6%A0%91%E7%9A%84%E8%A1%A8%E7%A4%BA-%E9%93%BE%E8%A1%A8.PNG" alt="树的表示"></p>
<p>A有3个指针，B有2个指针，C有3个指针。<br>每个元素设置几个指针？都设置3个，空的指针个数很多，浪费资源。</p>
<p><strong> 方式三：儿子-兄弟表示法 </strong></p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/9f6e8da5b232e8001a0272f4ef5249f98c36019d/201512/%E5%84%BF%E5%AD%90%E5%85%84%E5%BC%9F%E8%A1%A8%E7%A4%BA%E6%B3%95.PNG" alt="儿子-兄弟表示法"></p>
<p>儿子-兄弟 表示法 旋转45°，变成 二叉树</p>
<p><img src="https://raw.githubusercontent.com/FloraJieQiong/pages-pics/855520711dfedd3ed8d726039f5427185fee44fa/201512/%E4%BA%8C%E5%8F%89%E6%A0%91.PNG" alt="二叉树"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/02/数据结构3-树-上-——3-1-树与树的表示/" data-id="cisvpt2rc000c0ko0bgkcnb3s" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据结构/">数据结构</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/SELinux/">SELinux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c语言程序设计进阶/">c语言程序设计进阶</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/framework/">framework</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a><span class="tag-list-count">13</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/SELinux/" style="font-size: 10px;">SELinux</a> <a href="/tags/c语言程序设计进阶/" style="font-size: 10px;">c语言程序设计进阶</a> <a href="/tags/framework/" style="font-size: 10px;">framework</a> <a href="/tags/数据结构/" style="font-size: 20px;">数据结构</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/09/09/c语言程序设计进阶-1数据类型/">c语言程序设计进阶-1数据类型</a>
          </li>
        
          <li>
            <a href="/2016/09/09/spannableString/">(no title)</a>
          </li>
        
          <li>
            <a href="/2016/01/19/SELinux/">SELinux</a>
          </li>
        
          <li>
            <a href="/2015/12/10/数据结构5-树-下-5-1-堆/">数据结构5-树-下-5-1-堆</a>
          </li>
        
          <li>
            <a href="/2015/12/08/数据结构4-树-中-——4-2-平衡二叉树/">数据结构4-树-中-——4-2-平衡二叉树</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Jie Qiong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>